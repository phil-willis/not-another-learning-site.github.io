<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="Not another learning site."/><meta property="og:image" content="https://og-image.now.sh/Next.js%20Blog%20Starter%20Example.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><title>Not another learning site.</title><meta property="og:image" content="/assets/covers/aws.jpg"/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/aadbdd3a744cb30b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/aadbdd3a744cb30b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/cf121497002c184d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cf121497002c184d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-779b41245c009d2a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2c537fe628b325b3.js" defer=""></script><script src="/_next/static/chunks/664-4243e6d8b13d56da.js" defer=""></script><script src="/_next/static/chunks/pages/learn/%5Bslug%5D-92635154843eec70.js" defer=""></script><script src="/_next/static/uOEqA3AejMNRXWmH9me8c/_buildManifest.js" defer=""></script><script src="/_next/static/uOEqA3AejMNRXWmH9me8c/_ssgManifest.js" defer=""></script><script src="/_next/static/uOEqA3AejMNRXWmH9me8c/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="min-h-screen"><main><div class="container mx-auto px-5"><div style="position:fixed;background-color:rgba(255,255,255,0.9);backdrop-filter:blur(10px);width:100%;left:0px"><h2 class="text-2xl md:text-4xl font-bold tracking-tight md:tracking-tighter leading-tight mb-20 mt-8" style="padding:0;padding-left:10px;margin-bottom:20px"><a class="hover:underline" href="/">Learn</a>.</h2></div><article class="mb-32"><div style="height:100px"></div><h1 class="text-6xl md:text-7xl lg:text-8xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">aws</h1><div class="mb-8 md:mb-16 sm:mx-0"><div class="sm:mx-0"><img src="/assets/covers/aws.jpg" alt="Cover Image for aws" class="shadow-sm" layout="responsive" width="1240" height="620"/></div></div><div class="max-w-2xl mx-auto"><div class="block md:hidden mb-6"><div>TODO: add language chip here</div></div></div><div class="max-w-2xl mx-auto"><div class="markdown-styles_markdown__h_8de"><h1>AWS CLI</h1>
<ul>
<li>Installing the AWS CLI <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">Docs here</a></li>
<li>For macOS <a href="https://awscli.amazonaws.com/AWSCLIV2.pkg">download</a>
<ul>
<li>You can install to any folder, or choose the recommended default folder of <code>/usr/local/aws-cli</code>.</li>
<li>The installer automatically creates a symlink at <code>/usr/local/bin/aws</code> that links to the main program in the installation folder you chose.</li>
</ul>
</li>
<li>Check to see if it's installed properly
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ <span class="token function">which</span> aws
/usr/local/bin/aws 
$ aws --version
aws-cli/2.4.5 Python/3.8.8 Darwin/18.7.0 botocore/2.4.5
</code></pre></div>
</li>
<li>You can access your AWS services via:
<ol>
<li>Named profiles</li>
</ol>
<ul>
<li>AWS uses <code>~./aws/credentials</code> file for accessing your AWS accounts where you can have multiple profiles but you should probably have a <code>default</code> profile
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token punctuation">[</span>default<span class="token punctuation">]</span>
<span class="token assign-left variable">aws_access_key_id</span><span class="token operator">=</span>AAAAAAAAAAAAAEXAMPLE
<span class="token assign-left variable">aws_secret_access_key</span><span class="token operator">=</span><span class="token number">123456789123456789</span>

<span class="token punctuation">[</span>user1<span class="token punctuation">]</span>
<span class="token assign-left variable">aws_access_key_id</span><span class="token operator">=</span>BBBBBBBBBBBBBEXAMPLE
<span class="token assign-left variable">aws_secret_access_key</span><span class="token operator">=</span><span class="token number">12345678923456789</span>
</code></pre></div>
</li>
<li>You can also define the default regions for each profile in <code>~/.aws/config</code>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token punctuation">[</span>default<span class="token punctuation">]</span>
<span class="token assign-left variable">region</span><span class="token operator">=</span>us-west-2
<span class="token assign-left variable">output</span><span class="token operator">=</span>json

<span class="token punctuation">[</span>profile user1<span class="token punctuation">]</span>
<span class="token assign-left variable">region</span><span class="token operator">=</span>us-east-1
<span class="token assign-left variable">output</span><span class="token operator">=</span>text
</code></pre></div>
</li>
<li>Accessing a specific profile's resources you just have to pass in the <code>--profile &#x3C;PROFILE_NAME></code>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ aws s3 <span class="token function">ls</span> --profile default
</code></pre></div>
</li>
</ul>
<ol start="2">
<li>Environment variables</li>
</ol>
<ul>
<li>You can also pass in environment variables access key/secrets
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_ACCESS_KEY_ID</span><span class="token operator">=</span>BBBBBBBBBBBBBEXAMPLE
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_SECRET_ACCESS_KEY</span><span class="token operator">=</span><span class="token number">12345678923456789</span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_DEFAULT_REGION</span><span class="token operator">=</span>us-west-2
</code></pre></div>
</li>
</ul>
</li>
<li>Now, getting your <code>AWS_ACCESS_KEY_ID</code> &#x26; <code>AWS_SECRET_ACCESS_KEY</code> values
<ol>
<li>Go to Amazon Web Services console and click on the name of your account (it is located in the top right corner of the console). Then, in the expanded drop-down list, select <code>Security Credentials</code>.
<img src="public/assets/blog/aws/credentials_1.jpg" alt="Security Page"></li>
<li>Click the <code>Access keys (access key ID and secret access key)</code> accordion title and click <code>Create New Access Key</code>
<img src="public/assets/blog/aws/credentials_2.jpg" alt="Security Page"></li>
<li>Click <code>Show Access Key</code> to have it displayed on the screen. Note, that you can download it to your machine as a file and open it whenever needed. To download it, just click the <code>Download Key File</code> button.
<img src="public/assets/blog/aws/credentials_2.jpg" alt="Security Page"></li>
<li>Now update your <code>~/.aws/credentials</code> file with this key pair</li>
</ol>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token punctuation">[</span>default<span class="token punctuation">]</span>
<span class="token assign-left variable">aws_access_key_id</span><span class="token operator">=</span>AAAAAAAAAAAAAEXAMPLE
<span class="token assign-left variable">aws_secret_access_key</span><span class="token operator">=</span><span class="token number">123456789123456789</span>
</code></pre></div>
</li>
</ul>
<h1>S3</h1>
<ul>
<li>Storage</li>
</ul>
<h1>CLoudFront</h1>
<ul>
<li>Distribute your static content at AWS edge locations</li>
</ul>
<h1>ACM</h1>
<ul>
<li>AWS Certificate Manager is a service provided by Amazon that issues on-demand TLS certificates at no cost. Much like Letâ€™s Encrypt, Amazon controls the Certificate Authority (Amazon Trust Services, LLC) behind the certificates, as well as the accompanying API to manage them.</li>
<li>Amazon Certificate Manager (ACM) provides an elegant wayt to convert  a cumbersome multi-step process (the process of provisioning, validating, and configuring Transport Layer Security (TLS) certificates) into a single step</li>
<li>ACM certificates can only be associated with AWS Elastic and Application Load Balancers, CloudFront distributions, and API Gateway endpoints.</li>
</ul>
<h1>Route53</h1>
<h1>API Gateway</h1>
<ul>
<li>Allows you to make RESTful applications</li>
</ul>
<h1>Lambda</h1>
<ul>
<li>Serverless functions</li>
</ul>
<h1>DynamoDB</h1>
<ul>
<li>DynamoDB is a NoSQL database service</li>
</ul>
<h1>RDS</h1>
<ul>
<li>Relational Database Service (RDS)</li>
</ul>
<h1>Aurora DB</h1>
<ul>
<li>MySQL and PostgreSQL-compatible relational database built for the cloud. Performance and availability of commercial-grade databases at 1/10th the cost.</li>
<li>Amazon Aurora is a MySQL and PostgreSQL-compatible relational database built for the cloud, that combines the performance and availability of traditional enterprise databases with the simplicity and cost-effectiveness of open source databases.</li>
<li>Amazon Aurora is up to five times faster than standard MySQL databases and three times faster than standard PostgreSQL databases.</li>
<li>DB normally run on an EC and it a pain to scale</li>
<li>Aurora scale automatically,</li>
<li>Aurora make 6 copies of your data distributes around multiple locations</li>
<li>Continuously backs it up to S3 so your data is safe</li>
<li>Aurora can also replicate around multiple regions</li>
<li>It's fully managed</li>
<li>Aurora comes in 2 flavors
<ul>
<li>Aurora Basic</li>
<li>Aurora Serverless (scales as much as you need and shuts down when you don't need it)</li>
</ul>
</li>
<li>Aurora uses a data API to access the data, which is different to how you normally connect to a relational database (via connections)
<ul>
<li>Working with Relational Database you have to connect to the DB, do your operations, then closing the connections</li>
<li>In the world of Serverless it become a little problematic cause you can have multiple lambda functions and they will all be handling the connections independenly which can lead to problems in your database like running out of open connections, your killing the memory, making it preform really bad</li>
<li>You can use an AWS Proxy that sits between your Database and your lambda functions and will handle the connections</li>
<li>You should really just use this if you have legacy DB</li>
<li>If you are building a new application, just use the Aurora Serverless and save yourself the headache</li>
</ul>
</li>
<li>DynamoDB used the model of accessing the DB via the API</li>
<li>In the serverless world dealing with DB connections is a pain,</li>
</ul>
<h1>Terraform (Infrastructure as Code) to build out your services</h1>
<ul>
<li>Why?
<ul>
<li>To document all the services that are being used</li>
<li>Repeatable &#x26; reusable solution</li>
<li>Tare down all the services created with Terraform because TF creates an inventory of all the services in a state file</li>
</ul>
</li>
</ul>
<h1>Terraform for a client-side static web application</h1>
<h2>The variable file</h2>
<ul>
<li>This file is the only <code>.tf</code> file where you need to update values the rest of the <code>.tf</code> files are totally project agnostic
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./varables.tf)</span>
<span class="token comment">#-------------------------------------------</span>
<span class="token comment"># Required variables (values passed in via command)</span>
<span class="token comment">#-------------------------------------------</span>
<span class="token keyword">variable<span class="token type variable"> domain_name </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">variable<span class="token type variable"> hosted_zone_name </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">variable<span class="token type variable"> env_tags </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">#-------------------------------------------</span>
<span class="token comment"># TF version &#x26; State file config</span>
<span class="token comment">#-------------------------------------------</span>
<span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token keyword">backend<span class="token type variable"> "s3" </span></span><span class="token punctuation">{</span>
    <span class="token property">key</span>    <span class="token punctuation">=</span> <span class="token string">"&#x3C;YOUR_PROJECT_NAME_HERE>"</span> <span class="token comment"># this will define the TF state file</span>
    <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">"us-west-2"</span>
  <span class="token punctuation">}</span>
  <span class="token property">required_version</span> <span class="token punctuation">=</span> <span class="token string">">= 0.13.5"</span>
  <span class="token keyword">required_providers</span> <span class="token punctuation">{</span>
    <span class="token property">aws</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">"hashicorp/aws"</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">"~>3.4"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">#-------------------------------------------</span>
<span class="token comment"># Default region</span>
<span class="token comment">#-------------------------------------------</span>
<span class="token keyword">variable<span class="token type variable"> "region" </span></span><span class="token punctuation">{</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"us-west-2"</span>
<span class="token punctuation">}</span>
<span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span> <span class="token punctuation">=</span> var.region
<span class="token punctuation">}</span>

<span class="token comment">#-------------------------------------------</span>
<span class="token comment"># Interpolated Values</span>
<span class="token comment">#-------------------------------------------</span>
<span class="token keyword">locals</span> <span class="token punctuation">{</span>
  <span class="token property">bucket_name</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">domain_name</span><span class="token punctuation">}</span></span>"</span>
  <span class="token property">domain_name</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">domain_name</span><span class="token punctuation">}</span></span>"</span>
<span class="token punctuation">}</span>

<span class="token comment">#-------------------------------------------</span>
<span class="token comment"># Data</span>
<span class="token comment">#-------------------------------------------</span>
<span class="token keyword">data <span class="token type variable">"aws_caller_identity"</span></span> <span class="token string">"current"</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<h2>S3</h2>
<ul>
<li>Use S3 to store the static web files and a second bucket for logging
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./s3.tf)</span>
<span class="token keyword">resource <span class="token type variable">"aws_s3_bucket"</span></span> <span class="token string">"site"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> local.bucket_name
  <span class="token property">acl</span>    <span class="token punctuation">=</span> <span class="token string">"private"</span>
  <span class="token property">policy</span> <span class="token punctuation">=</span> data.aws_iam_policy_document.website_s3_policy.json

  <span class="token keyword">website</span> <span class="token punctuation">{</span>
    <span class="token property">index_document</span> <span class="token punctuation">=</span> <span class="token string">"index.html"</span>
    <span class="token property">error_document</span> <span class="token punctuation">=</span> <span class="token string">"404.html"</span>
  <span class="token punctuation">}</span>

  <span class="token property">tags</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">Environment</span> <span class="token punctuation">=</span> var.env_tags
    <span class="token property">Created_with</span> <span class="token punctuation">=</span> <span class="token string">"Terraform"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_s3_bucket"</span></span> <span class="token string">"log_bucket"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">local</span><span class="token punctuation">.</span><span class="token type variable">bucket_name</span><span class="token punctuation">}</span></span>-logs"</span>
  <span class="token property">acl</span>    <span class="token punctuation">=</span> <span class="token string">"log-delivery-write"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<h2>Policies</h2>
<ul>
<li>This policie only allows access via CloudFront to serve the webcontent
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./policies.tf)</span>
<span class="token keyword">data <span class="token type variable">"aws_iam_policy_document"</span></span> <span class="token string">"website_s3_policy"</span> <span class="token punctuation">{</span>
  <span class="token keyword">statement</span> <span class="token punctuation">{</span>
    <span class="token property">actions</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">]</span>
    <span class="token property">resources</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"arn:aws:s3:::<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">local</span><span class="token punctuation">.</span><span class="token type variable">bucket_name</span><span class="token punctuation">}</span></span>/*"</span><span class="token punctuation">]</span>

    <span class="token keyword">principals</span> <span class="token punctuation">{</span>
      <span class="token property">type</span>        <span class="token punctuation">=</span> <span class="token string">"AWS"</span>
      <span class="token property">identifiers</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_cloudfront_origin_access_identity<span class="token punctuation">.</span>website_origin_access_identity<span class="token punctuation">.</span>iam_arn<span class="token punctuation">}</span></span>"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<h2>Route53</h2>
<ul>
<li>Make sure that you purchase your domain name beforehand because we will need the Hosted Zone Id</li>
<li>We will use TF to create an <code>A</code> record to connect to the CloudFront instance
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./route53.tf)</span>
<span class="token keyword">resource <span class="token type variable">"aws_route53_record"</span></span> <span class="token string">"domain"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>    <span class="token punctuation">=</span> local.domain_name
  <span class="token property">zone_id</span> <span class="token punctuation">=</span> data.aws_route53_zone.base.zone_id
  <span class="token property">type</span>    <span class="token punctuation">=</span> <span class="token string">"A"</span>
  <span class="token keyword">alias</span> <span class="token punctuation">{</span>
    <span class="token property">name</span>                   <span class="token punctuation">=</span> aws_cloudfront_distribution.website_cdn.domain_name
    <span class="token property">zone_id</span>                <span class="token punctuation">=</span> aws_cloudfront_distribution.website_cdn.hosted_zone_id
    <span class="token property">evaluate_target_health</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">data <span class="token type variable">"aws_route53_zone"</span></span> <span class="token string">"base"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>         <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">hosted_zone_name</span><span class="token punctuation">}</span></span>."</span>
  <span class="token property">private_zone</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<h2>ACM for certs</h2>
<ul>
<li>ACM provides an elegant wayt to convert  a cumbersome multi-step process into a single step, however when combined with Terraform this process is a little more complex because some processes have to happen in senquential steps</li>
<li>Some of the TF modules include:
<ul>
<li><code>aws_acm_certificate</code>: To request a certificate for example.com</li>
<li><code>aws_route53_record</code>: To create a DNS record to validate the certificate request</li>
<li><code>aws_certificate_validation</code>: To ensure that ACM validates our DNS record before certificate use</li>
</ul>
</li>
<li>In an effort to reduce the timming steps, <a href="https://www.azavea.com/">azavea's team</a> assembled a reusable <a href="https://github.com/azavea/terraform-aws-acm-certificate">Terraform module</a> to encapsulate the ACM and Route 53 resources used. Using the output from the validation resource ensures that Terraform will wait for ACM to validate the certificate before resolving its ARN. Now, the process of creating, validating, and waiting for a valid certificate looks like this:
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./certs.tf)</span>
<span class="token keyword">data <span class="token type variable">"aws_route53_zone"</span></span> <span class="token string">"base"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>         <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">hosted_zone_name</span><span class="token punctuation">}</span></span>."</span>
  <span class="token property">private_zone</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">"us-east-1"</span>
  <span class="token property">alias</span>  <span class="token punctuation">=</span> <span class="token string">"certificates"</span>
<span class="token punctuation">}</span>

<span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span> <span class="token punctuation">=</span> var.region
  <span class="token property">alias</span>  <span class="token punctuation">=</span> <span class="token string">"dns"</span>
<span class="token punctuation">}</span>

<span class="token keyword">module<span class="token type variable"> "cert" </span></span><span class="token punctuation">{</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"github.com/azavea/terraform-aws-acm-certificate?ref=3.0.0"</span>

  <span class="token property">providers</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">aws.acm_account</span>     <span class="token punctuation">=</span> aws.certificates
    <span class="token property">aws.route53_account</span> <span class="token punctuation">=</span> aws.dns
  <span class="token punctuation">}</span>

  <span class="token property">domain_name</span>                       <span class="token punctuation">=</span> local.domain_name
  <span class="token property">hosted_zone_id</span>                    <span class="token punctuation">=</span> data.aws_route53_zone.base.zone_id
  <span class="token property">validation_record_ttl</span>             <span class="token punctuation">=</span> <span class="token string">"60"</span>
  <span class="token property">allow_validation_record_overwrite</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_route53_record"</span></span> <span class="token string">"domain"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>    <span class="token punctuation">=</span> local.domain_name
  <span class="token property">zone_id</span> <span class="token punctuation">=</span> data.aws_route53_zone.base.zone_id
  <span class="token property">type</span>    <span class="token punctuation">=</span> <span class="token string">"A"</span>
  <span class="token keyword">alias</span> <span class="token punctuation">{</span>
    <span class="token property">name</span>                   <span class="token punctuation">=</span> aws_cloudfront_distribution.website_cdn.domain_name
    <span class="token property">zone_id</span>                <span class="token punctuation">=</span> aws_cloudfront_distribution.website_cdn.hosted_zone_id
    <span class="token property">evaluate_target_health</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<h1>CloudFront</h1>
<ul>
<li>CloudFront allows for global distribution of our web content with the ability to cache content at AWS edge locations</li>
<li>The CloudFront configuration is kind of a beast
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./cloudfront.tf)</span>
<span class="token keyword">resource <span class="token type variable">"aws_cloudfront_origin_access_identity"</span></span> <span class="token string">"website_origin_access_identity"</span> <span class="token punctuation">{</span>
  <span class="token property">comment</span> <span class="token punctuation">=</span> <span class="token string">"site <span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">terraform</span><span class="token punctuation">.</span><span class="token type variable">workspace</span><span class="token punctuation">}</span></span> Access Identity"</span>
<span class="token punctuation">}</span>


<span class="token keyword">resource <span class="token type variable">"aws_cloudfront_distribution"</span></span> <span class="token string">"website_cdn"</span> <span class="token punctuation">{</span>
  <span class="token keyword">origin</span> <span class="token punctuation">{</span>
    <span class="token property">domain_name</span> <span class="token punctuation">=</span> aws_s3_bucket.site.bucket_regional_domain_name
    <span class="token property">origin_id</span>   <span class="token punctuation">=</span> <span class="token string">"origin-bucket-<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_s3_bucket<span class="token punctuation">.</span>site<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span>

    <span class="token keyword">s3_origin_config</span> <span class="token punctuation">{</span>
      <span class="token property">origin_access_identity</span> <span class="token punctuation">=</span> aws_cloudfront_origin_access_identity.website_origin_access_identity.cloudfront_access_identity_path
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token property">enabled</span>             <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">is_ipv6_enabled</span>     <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">default_root_object</span> <span class="token punctuation">=</span> <span class="token string">"index.html"</span>

  <span class="token keyword">logging_config</span> <span class="token punctuation">{</span>
    <span class="token property">include_cookies</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
    <span class="token property">bucket</span>          <span class="token punctuation">=</span> aws_s3_bucket.log_bucket.bucket_domain_name
    <span class="token property">prefix</span>          <span class="token punctuation">=</span> <span class="token string">"cloudfront_logs"</span>
  <span class="token punctuation">}</span>

  <span class="token property">aliases</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>local.domain_name<span class="token punctuation">]</span>

  <span class="token keyword">default_cache_behavior</span> <span class="token punctuation">{</span>
    <span class="token property">allowed_methods</span>  <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"DELETE"</span>, <span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span>, <span class="token string">"PATCH"</span>, <span class="token string">"POST"</span>, <span class="token string">"PUT"</span><span class="token punctuation">]</span>
    <span class="token property">cached_methods</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span><span class="token punctuation">]</span>
    <span class="token property">target_origin_id</span> <span class="token punctuation">=</span> <span class="token string">"origin-bucket-<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_s3_bucket<span class="token punctuation">.</span>site<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span>

    <span class="token keyword">forwarded_values</span> <span class="token punctuation">{</span>
      <span class="token property">query_string</span> <span class="token punctuation">=</span> <span class="token string">"true"</span>

      <span class="token keyword">cookies</span> <span class="token punctuation">{</span>
        <span class="token property">forward</span> <span class="token punctuation">=</span> <span class="token string">"none"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token property">viewer_protocol_policy</span> <span class="token punctuation">=</span> <span class="token string">"redirect-to-https"</span>
    <span class="token property">compress</span>               <span class="token punctuation">=</span> <span class="token boolean">true</span>
    <span class="token property">min_ttl</span>                <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">default_ttl</span>            <span class="token punctuation">=</span> <span class="token number">300</span>
    <span class="token property">max_ttl</span>                <span class="token punctuation">=</span> <span class="token number">1200</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># Cache behavior with precedence 0</span>
  <span class="token keyword">ordered_cache_behavior</span> <span class="token punctuation">{</span>
    <span class="token property">path_pattern</span>     <span class="token punctuation">=</span> <span class="token string">"/index.html"</span>
    <span class="token property">allowed_methods</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"DELETE"</span>, <span class="token string">"OPTIONS"</span>, <span class="token string">"PATCH"</span>, <span class="token string">"POST"</span>, <span class="token string">"PUT"</span><span class="token punctuation">]</span>
    <span class="token property">cached_methods</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span><span class="token punctuation">]</span>
    <span class="token property">target_origin_id</span> <span class="token punctuation">=</span> <span class="token string">"origin-bucket-<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_s3_bucket<span class="token punctuation">.</span>site<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span>

    <span class="token keyword">forwarded_values</span> <span class="token punctuation">{</span>
      <span class="token property">query_string</span> <span class="token punctuation">=</span> <span class="token string">"true"</span>

      <span class="token keyword">cookies</span> <span class="token punctuation">{</span>
        <span class="token property">forward</span> <span class="token punctuation">=</span> <span class="token string">"none"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token property">min_ttl</span>                <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">default_ttl</span>            <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">max_ttl</span>                <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">compress</span>               <span class="token punctuation">=</span> <span class="token boolean">true</span>
    <span class="token property">viewer_protocol_policy</span> <span class="token punctuation">=</span> <span class="token string">"redirect-to-https"</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">custom_error_response</span> <span class="token punctuation">{</span>
    <span class="token property">error_code</span> <span class="token punctuation">=</span> <span class="token string">"404"</span>
    <span class="token property">response_code</span>      <span class="token punctuation">=</span> <span class="token string">"200"</span>
    <span class="token property">response_page_path</span> <span class="token punctuation">=</span> <span class="token string">"/index.html"</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">custom_error_response</span> <span class="token punctuation">{</span>
    <span class="token property">error_code</span> <span class="token punctuation">=</span> <span class="token string">"403"</span>
    <span class="token property">response_code</span>      <span class="token punctuation">=</span> <span class="token string">"200"</span>
    <span class="token property">response_page_path</span> <span class="token punctuation">=</span> <span class="token string">"/index.html"</span>
  <span class="token punctuation">}</span>

  <span class="token property">price_class</span> <span class="token punctuation">=</span> <span class="token string">"PriceClass_100"</span> <span class="token comment"># https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PriceClass.html</span>

  <span class="token keyword">restrictions</span> <span class="token punctuation">{</span>
    <span class="token keyword">geo_restriction</span> <span class="token punctuation">{</span>
      <span class="token property">restriction_type</span> <span class="token punctuation">=</span> <span class="token string">"none"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">viewer_certificate</span> <span class="token punctuation">{</span>
    <span class="token property">acm_certificate_arn</span>      <span class="token punctuation">=</span> module.cert.arn
    <span class="token property">ssl_support_method</span>       <span class="token punctuation">=</span> <span class="token string">"sni-only"</span>
    <span class="token property">minimum_protocol_version</span> <span class="token punctuation">=</span> <span class="token string">"TLSv1"</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">lifecycle</span> <span class="token punctuation">{</span>
    <span class="token property">ignore_changes</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>tags<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token property">tags</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">Environment</span> <span class="token punctuation">=</span> var.env_tags
    <span class="token property">Created_with</span> <span class="token punctuation">=</span> <span class="token string">"Terraform"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<h2>Finally the <code>.tfvars</code> file</h2>
<ul>
<li>Creating a <code>.tfvar</code> file allows you to deploy this applications to multiple environments (dev|statging|prod)
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./env_configs/prod.tfvars)</span>
<span class="token property">domain_name</span>      <span class="token punctuation">=</span> <span class="token string">"myawesomesite.com"</span>
<span class="token property">hosted_zone_name</span> <span class="token punctuation">=</span> <span class="token string">"myawesomesite.com"</span>
<span class="token property">env_tags</span>          <span class="token punctuation">=</span> <span class="token string">"Production"</span>
</code></pre></div>
</li>
<li>Now running this
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token comment"># *NOTE* run these commands in the terraform folder</span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_PROFILE</span><span class="token operator">=</span><span class="token string">"&#x3C;YOUR_AWS_PROFILE_HERE>"</span>
<span class="token assign-left variable">CLIENT_BUCKET_NAME</span><span class="token operator">=</span><span class="token string">"&#x3C;YOUR_AWS_S3_BUCKET_NAME>"</span>
<span class="token assign-left variable">TERRAFORM_STATE_BUCKET_NAME</span><span class="token operator">=</span><span class="token string">"&#x3C;YOUR_TF_REMOTE_STATE_BUCKET_NAME>"</span>

<span class="token comment"># Environment variables</span>
<span class="token assign-left variable">WORKSPACE</span><span class="token operator">=</span><span class="token string">"prod"</span>
<span class="token assign-left variable">VAR_FILE</span><span class="token operator">=</span><span class="token string">"./env/prod.tfvars"</span>

<span class="token comment"># TF version</span>
<span class="token assign-left variable">tf_ver</span><span class="token operator">=</span><span class="token string">"v0.13.5"</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token variable"><span class="token variable">$(</span>Terraform --version<span class="token variable">)</span></span> <span class="token operator">=~</span> <span class="token string">"Terraform <span class="token variable">$tf_ver</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token builtin class-name">echo</span> <span class="token string">"Terraform <span class="token variable">$tf_ver</span> is required"</span><span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">fi</span>

<span class="token comment"># Cleanup .terraform</span>
<span class="token function">rm</span> -rf .terraform/

<span class="token comment"># Deploy terraform</span>
<span class="token builtin class-name">echo</span> <span class="token string">"[Running] terraform"</span>
terraform init -backend-config <span class="token assign-left variable">bucket</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${TERRAFORM_STATE_BUCKET_NAME}</span>"</span>

<span class="token comment"># If the workspace does not exist, create it.</span>
<span class="token keyword">if</span> <span class="token operator">!</span> terraform workspace <span class="token keyword">select</span> <span class="token variable">${WORKSPACE}</span><span class="token punctuation">;</span> <span class="token keyword">then</span> terraform workspace new <span class="token variable">${WORKSPACE}</span><span class="token punctuation">;</span> <span class="token keyword">fi</span>
terraform apply -auto-approve -var-file<span class="token operator">=</span><span class="token variable">$VAR_FILE</span>

<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span> <span class="token comment"># where the package.json file exist</span>

<span class="token comment"># Build the static files</span>
<span class="token builtin class-name">echo</span> <span class="token string">"[Build] production version of the website]"</span>
<span class="token function">yarn</span>
<span class="token function">yarn</span> run build

<span class="token comment"># Upload the source code to AWS S3</span>
<span class="token builtin class-name">echo</span> <span class="token string">"[Upload] website content"</span>
aws s3 <span class="token function">rm</span> s3://<span class="token variable">$CLIENT_BUCKET_NAME</span>/  --recursive
aws s3 <span class="token function">sync</span> dist/ s3://<span class="token variable">$CLIENT_BUCKET_NAME</span>/ --exclude <span class="token punctuation">\</span>"*.DS_Store*<span class="token punctuation">\</span>"
aws s3 <span class="token function">cp</span> dist/index.html s3://<span class="token variable">$CLIENT_BUCKET_NAME</span>/ --cache-control max-age<span class="token operator">=</span><span class="token number">0</span>
</code></pre></div>
</li>
</ul>
<h2>CloudFront add a secondary failover origin</h2>
<ul>
<li>Create a bucket and a CloudFront ditribution:
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl">variable <span class="token string">"primary_bucket_name"</span><span class="token punctuation">{</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"my-awesome-site"</span>
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> "s3_origin_id" </span></span><span class="token punctuation">{</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"myS3Origin"</span>
<span class="token punctuation">}</span>

<span class="token comment"># Primary Origin</span>
<span class="token keyword">data <span class="token type variable">"aws_iam_policy_document"</span></span> <span class="token string">"primary_origin_website_s3_policy"</span> <span class="token punctuation">{</span>
  <span class="token keyword">statement</span> <span class="token punctuation">{</span>
    <span class="token property">sid</span>       <span class="token punctuation">=</span> <span class="token string">"bucket_policy_for_primary"</span>
    <span class="token property">actions</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">]</span>
    <span class="token property">effect</span>    <span class="token punctuation">=</span> <span class="token string">"Allow"</span>
    <span class="token property">resources</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"arn:aws:s3:::<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">primary_bucket_name</span><span class="token punctuation">}</span></span>/*"</span><span class="token punctuation">]</span>

    <span class="token keyword">principals</span> <span class="token punctuation">{</span>
      <span class="token property">type</span>        <span class="token punctuation">=</span> <span class="token string">"AWS"</span>
      <span class="token property">identifiers</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>aws_cloudfront_origin_access_identity.website_origin_access_identity.iam_arn<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">resource <span class="token type variable">"aws_s3_bucket"</span></span> <span class="token string">"primary_origin"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> var.primary_bucket_name
  <span class="token property">acl</span>    <span class="token punctuation">=</span> <span class="token string">"private"</span>
  <span class="token property">policy</span> <span class="token punctuation">=</span> data.aws_iam_policy_document.primary_origin_website_s3_policy.json

  <span class="token keyword">website</span> <span class="token punctuation">{</span>
    <span class="token property">index_document</span> <span class="token punctuation">=</span> <span class="token string">"index.html"</span>
    <span class="token property">error_document</span> <span class="token punctuation">=</span> <span class="token string">"404.html"</span>
  <span class="token punctuation">}</span>

  <span class="token property">tags</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token property">force_destroy</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>



<span class="token comment"># CloudFront (With single origin)</span>
<span class="token keyword">resource <span class="token type variable">"aws_cloudfront_origin_access_identity"</span></span> <span class="token string">"website_origin_access_identity"</span> <span class="token punctuation">{</span>
  <span class="token property">comment</span> <span class="token punctuation">=</span> <span class="token string">"site <span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">terraform</span><span class="token punctuation">.</span><span class="token type variable">workspace</span><span class="token punctuation">}</span></span> Access Identity"</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_cloudfront_distribution"</span></span> <span class="token string">"s3_distribution"</span> <span class="token punctuation">{</span>
  <span class="token keyword">origin</span> <span class="token punctuation">{</span>
    <span class="token property">domain_name</span> <span class="token punctuation">=</span> aws_s3_bucket.primary_origin.bucket_regional_domain_name
    <span class="token property">origin_id</span>   <span class="token punctuation">=</span> var.s3_origin_id

    <span class="token keyword">s3_origin_config</span> <span class="token punctuation">{</span>
      <span class="token property">origin_access_identity</span> <span class="token punctuation">=</span> aws_cloudfront_origin_access_identity.website_origin_access_identity.cloudfront_access_identity_path
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token property">enabled</span>             <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">is_ipv6_enabled</span>     <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">comment</span>             <span class="token punctuation">=</span> <span class="token string">"Some comment"</span>
  <span class="token property">default_root_object</span> <span class="token punctuation">=</span> <span class="token string">"index.html"</span>

  <span class="token keyword">logging_config</span> <span class="token punctuation">{</span>
    <span class="token property">include_cookies</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
    <span class="token property">bucket</span>          <span class="token punctuation">=</span> <span class="token string">"mylogs.s3.amazonaws.com"</span>
    <span class="token property">prefix</span>          <span class="token punctuation">=</span> <span class="token string">"myprefix"</span>
  <span class="token punctuation">}</span>

  <span class="token property">aliases</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"mysite.example.com"</span>, <span class="token string">"yoursite.example.com"</span><span class="token punctuation">]</span>

  <span class="token keyword">default_cache_behavior</span> <span class="token punctuation">{</span>
    <span class="token property">allowed_methods</span>  <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"DELETE"</span>, <span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span>, <span class="token string">"PATCH"</span>, <span class="token string">"POST"</span>, <span class="token string">"PUT"</span><span class="token punctuation">]</span>
    <span class="token property">cached_methods</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span><span class="token punctuation">]</span>
    <span class="token property">target_origin_id</span> <span class="token punctuation">=</span> var.s3_origin_id

    <span class="token keyword">forwarded_values</span> <span class="token punctuation">{</span>
      <span class="token property">query_string</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>

      <span class="token keyword">cookies</span> <span class="token punctuation">{</span>
        <span class="token property">forward</span> <span class="token punctuation">=</span> <span class="token string">"none"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token property">viewer_protocol_policy</span> <span class="token punctuation">=</span> <span class="token string">"allow-all"</span>
    <span class="token property">min_ttl</span>                <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">default_ttl</span>            <span class="token punctuation">=</span> <span class="token number">3600</span>
    <span class="token property">max_ttl</span>                <span class="token punctuation">=</span> <span class="token number">86400</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># Cache behavior with precedence 0</span>
  <span class="token keyword">ordered_cache_behavior</span> <span class="token punctuation">{</span>
    <span class="token property">path_pattern</span> <span class="token punctuation">=</span> <span class="token string">"/index.html"</span>
    <span class="token property">allowed_methods</span>  <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span><span class="token punctuation">]</span>
    <span class="token property">cached_methods</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span><span class="token punctuation">]</span>
    <span class="token property">target_origin_id</span> <span class="token punctuation">=</span> var.s3_origin_id

    <span class="token keyword">forwarded_values</span> <span class="token punctuation">{</span>
      <span class="token property">query_string</span> <span class="token punctuation">=</span> <span class="token string">"true"</span>
      <span class="token keyword">cookies</span> <span class="token punctuation">{</span>
        <span class="token property">forward</span> <span class="token punctuation">=</span> <span class="token string">"none"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token property">min_ttl</span>                <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">default_ttl</span>            <span class="token punctuation">=</span> <span class="token number">86400</span>
    <span class="token property">max_ttl</span>                <span class="token punctuation">=</span> <span class="token number">31536000</span>
    <span class="token property">compress</span>               <span class="token punctuation">=</span> <span class="token boolean">true</span>
    <span class="token property">viewer_protocol_policy</span> <span class="token punctuation">=</span> <span class="token string">"redirect-to-https"</span>
  <span class="token punctuation">}</span>

  <span class="token property">price_class</span> <span class="token punctuation">=</span> <span class="token string">"PriceClass_200"</span>

  <span class="token keyword">restrictions</span> <span class="token punctuation">{</span>
    <span class="token keyword">geo_restriction</span> <span class="token punctuation">{</span>
      <span class="token property">restriction_type</span> <span class="token punctuation">=</span> <span class="token string">"none"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token property">tags</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">Environment</span> <span class="token punctuation">=</span> <span class="token string">"production"</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">viewer_certificate</span> <span class="token punctuation">{</span>
    <span class="token property">cloudfront_default_certificate</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>Now add a second bucket in another region and update your CloudFront config block to allow for secondary origin
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># Add a bucket in another region</span>
<span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">"eu-west-1"</span>
  <span class="token property">alias</span>  <span class="token punctuation">=</span> <span class="token string">"failover_region"</span>
<span class="token punctuation">}</span>

variable <span class="token string">"secondary_bucket_name"</span><span class="token punctuation">{</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"my-awesome-site-failover"</span>
<span class="token punctuation">}</span>

<span class="token comment"># Secondary Bucket</span>
<span class="token keyword">data <span class="token type variable">"aws_iam_policy_document"</span></span> <span class="token string">"secondary_origin_website_s3_policy"</span> <span class="token punctuation">{</span>
  <span class="token property">provider</span> <span class="token punctuation">=</span> aws.failover_region

  <span class="token keyword">statement</span> <span class="token punctuation">{</span>
    <span class="token property">sid</span>       <span class="token punctuation">=</span> <span class="token string">"bucket_policy_for_secondary"</span>
    <span class="token property">actions</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">]</span>
    <span class="token property">effect</span>    <span class="token punctuation">=</span> <span class="token string">"Allow"</span>
    <span class="token property">resources</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"arn:aws:s3:::<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">secondary_bucket_name</span><span class="token punctuation">}</span></span>/*"</span><span class="token punctuation">]</span>

    <span class="token keyword">principals</span> <span class="token punctuation">{</span>
      <span class="token property">type</span>        <span class="token punctuation">=</span> <span class="token string">"AWS"</span>
      <span class="token property">identifiers</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>aws_cloudfront_origin_access_identity.website_origin_access_identity.iam_arn<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">resource <span class="token type variable">"aws_s3_bucket"</span></span> <span class="token string">"secondary_origin"</span> <span class="token punctuation">{</span>
  <span class="token property">provider</span> <span class="token punctuation">=</span> aws.failover_region

  <span class="token property">bucket</span> <span class="token punctuation">=</span> var.secondary_bucket_name
  <span class="token property">acl</span>    <span class="token punctuation">=</span> <span class="token string">"private"</span>
  <span class="token property">policy</span> <span class="token punctuation">=</span> data.aws_iam_policy_document.secondary_origin_website_s3_policy.json

  <span class="token keyword">website</span> <span class="token punctuation">{</span>
    <span class="token property">index_document</span> <span class="token punctuation">=</span> <span class="token string">"index.html"</span>
    <span class="token property">error_document</span> <span class="token punctuation">=</span> <span class="token string">"404.html"</span>
  <span class="token punctuation">}</span>

  <span class="token property">tags</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token property">force_destroy</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>


<span class="token comment"># Update your cloudfront distribution</span>
<span class="token keyword">resource <span class="token type variable">"aws_cloudfront_distribution"</span></span> <span class="token string">"s3_distribution"</span> <span class="token punctuation">{</span>
  <span class="token comment"># Add an `origin group`</span>
  <span class="token keyword">origin_group</span> <span class="token punctuation">{</span>
    <span class="token property">origin_id</span> <span class="token punctuation">=</span> <span class="token string">"OriginWithFailover"</span>

    <span class="token keyword">failover_criteria</span> <span class="token punctuation">{</span>
      <span class="token property">status_codes</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token number">403</span>, <span class="token number">404</span>, <span class="token number">500</span>, <span class="token number">502</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># *NOTE: this order matters! (first one will be the primary)</span>
    <span class="token keyword">member</span> <span class="token punctuation">{</span>
      <span class="token property">origin_id</span> <span class="token punctuation">=</span> <span class="token string">"primaryS3"</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">member</span> <span class="token punctuation">{</span>
      <span class="token property">origin_id</span> <span class="token punctuation">=</span> <span class="token string">"failoverS3"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># Add a second origin</span>
  <span class="token keyword">origin</span> <span class="token punctuation">{</span>
    <span class="token property">domain_name</span> <span class="token punctuation">=</span> aws_s3_bucket.secondary_origin.bucket_regional_domain_name
    <span class="token property">origin_id</span>   <span class="token punctuation">=</span> <span class="token string">"failoverS3"</span>

    <span class="token keyword">s3_origin_config</span> <span class="token punctuation">{</span>
      <span class="token property">origin_access_identity</span> <span class="token punctuation">=</span> aws_cloudfront_origin_access_identity.website_origin_access_identity.cloudfront_access_identity_path
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">default_cache_behavior</span> <span class="token punctuation">{</span>
    <span class="token property">target_origin_id</span> <span class="token punctuation">=</span> <span class="token string">"OriginWithFailover"</span>

    <span class="token property">allowed_methods</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span><span class="token punctuation">]</span>
    <span class="token property">cached_methods</span>  <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span><span class="token punctuation">]</span>
    <span class="token comment"># *...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">ordered_cache_behavior</span> <span class="token punctuation">{</span>
    <span class="token property">target_origin_id</span> <span class="token punctuation">=</span> <span class="token string">"OriginWithFailover"</span>

    <span class="token property">allowed_methods</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span><span class="token punctuation">]</span> <span class="token comment"># Note </span>
    <span class="token property">cached_methods</span>  <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span><span class="token punctuation">]</span>
    <span class="token comment"># *...</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># *...</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>Now you can test it by uploading this below HTML to the bucket in the <code>eu-west-1</code> and leave the <code>us-west-2</code> empty for now
<div class="remark-highlight"><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>title</span><span class="token punctuation">></span></span>eu-west-1<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h1</span><span class="token punctuation">></span></span>eu-west-1<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
</code></pre></div>
</li>
<li>If you go to the CloudFront URL, you should see a site that says <code>eu-west-1</code></li>
<li>Now Add the below html to the <code>us-west-2</code> bucket:
<div class="remark-highlight"><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>title</span><span class="token punctuation">></span></span>us-west-2<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h1</span><span class="token punctuation">></span></span>us-west-2<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
</code></pre></div>
</li>
<li>If you refresh your browser you should now see <code>us-west-2</code></li>
</ul>
<h1>AWS CDK (AWS Cloud Development Kit)</h1>
<ul>
<li>The AWS CDK (Amazon Web Services Cloud Development Kit) is a <a href="https://github.com/aws/aws-cdk">new open source framework</a> to define cloud infrastructure in code (Infrastructure as Code) and provisioning it through AWS CloudFormation.</li>
<li>CDK provides many high level components to allow rapid code development requiring much less input compared to the typical CloudFormation templates.</li>
<li>CDK is available in TypeScript, Python, Java and C#.
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token comment"># Install globally </span>
$ <span class="token function">npm</span> i -g aws-cdk

$ <span class="token function">mkdir</span> my-app <span class="token operator">&#x26;&#x26;</span> <span class="token builtin class-name">cd</span> my-app
$ cdk init app --language<span class="token operator">=</span>typescript

$ <span class="token function">npm</span> i @aws-cdk/aws-apigatewayv2 @aws-cdk/aws-apigatewayv2-integrations @aws-cdk/aws-ec2 @aws-cdk/aws-lambda @aws-cdk/aws-rds @aws-cdk/core source-map-support
</code></pre></div>
</li>
</ul>
<h1>PostGIS</h1>
<ul>
<li><a href="https://www.martinpeters.ie/2020/02/01/cdk-rds-postgis-setup/"></a></li>
</ul>
<h1>AWS SAM (AWS Serverless Application Model)</h1>
<ul>
<li>SAM is an open-source framework for building serverless applications.</li>
<li>You define the services you want in YAML and during the deployment SAM will convert it to CloudFormation syntax</li>
<li>SAM can be installed with <code>Homebrew</code></li>
<li>SAM allows you to run your application locally so you can test it out and debug</li>
<li>SAM is Infrastructure as Code</li>
</ul>
<h2>Installing SAM on MacOS</h2>
<ul>
<li><a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install-mac.html">How to install SAM</a>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ brew tap aws/tap
$ brew <span class="token function">install</span> aws-sam-cli
$ sam --version

$ brew upgrade aws-sam-cli
</code></pre></div>
</li>
</ul>
<h2>Get setup</h2>
<ul>
<li>Start by scaffolding your application
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token comment"># Step 1 - Download a sample application</span>
$ sam init
<span class="token comment"># 1 - AWS Quick Start Templates</span>
<span class="token comment"># 1 - Zip (artifact is a zip uploaded to S3)</span>
<span class="token comment"># 1 - nodejs14.x</span>
<span class="token comment"># AWS quick start application templates:</span>
<span class="token comment">#    1 - Hello World Example</span>
<span class="token comment">#    2 - Step Functions Sample App (Stock Trader)</span>
<span class="token comment">#    3 - Quick Start: From Scratch</span>
<span class="token comment">#    4 - Quick Start: Scheduled Events</span>
<span class="token comment">#    5 - Quick Start: S3</span>
<span class="token comment">#    6 - Quick Start: SNS</span>
<span class="token comment">#    7 - Quick Start: SQS</span>
<span class="token comment">#    8 - Quick Start: Web Backend</span>

<span class="token comment"># Step 2 run your code locally</span>
$ sam <span class="token builtin class-name">local</span> start-api

<span class="token comment"># Step 3 - Build your application</span>
$ <span class="token builtin class-name">cd</span> sam-app
$ sam build

<span class="token comment"># Step 4 - Deploy your application</span>
$ sam deploy --guided
<span class="token comment"># Once everything is deployed it will print out the REST Endpoint `https://&#x3C;RANDOM_STRING>.execute-api.us-west-2.amazonaws.com/Prod/`</span>
</code></pre></div>
</li>
</ul>
<h2>Check your stuff out in AWS Console</h2>
<ul>
<li>You can view your SAM application in AWS Console by going to <code>Lambda</code> > <code>Applications</code>
<img src="/assets/blog/aws/aws-console_serverless-application.png" alt="aws-console_serverless-application"></li>
<li>You can view your stack my clicking the <code>CloudFormation</code></li>
</ul>
<h2>Check your stuff within VSCode with the <code>Serverless Console</code> extension</h2>
<ul>
<li>
<p>You can use a vscode extension <a href="https://marketplace.visualstudio.com/items?itemName=devAdvice.serverlessconsole">Serverless Console</a> to view all the logs</p>
<ul>
<li>In vscode click the lighting bolt in the quick look panel</li>
<li>Create a connection</li>
</ul>
<p><img src="/assets/blog/aws/serverless-console_connect.png" alt="serverless-console_connect"></p>
<p><img src="/assets/blog/aws/serverless-console_panel.png" alt="serverless-console_panel"></p>
</li>
<li>
<p>Invoke your Lambda function directly</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ sam <span class="token builtin class-name">local</span> invoke <span class="token string">"HelloWorldFunction"</span> -e events/event.json
</code></pre></div>
</li>
</ul>
<h2>Cleanup</h2>
<ul>
<li>
<p>To delete the sample application that you created, use the AWS CLI. Assuming you used your project name for the stack name, you can run the following:</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">aws cloudformation delete-stack --stack-name <span class="token operator">&#x3C;</span>STACK_NAME<span class="token operator">></span>
</code></pre></div>
</li>
</ul>
</div></div></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5"><div class="py-28 flex flex-col lg:flex-row items-center"><div class="flex flex-col lg:flex-row justify-center items-center lg:pl-4 lg:w-1/2"><a href="/">Learn something else</a></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"aws","slug":"aws","content":"\u003ch1\u003eAWS CLI\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eInstalling the AWS CLI \u003ca href=\"https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html\"\u003eDocs here\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eFor macOS \u003ca href=\"https://awscli.amazonaws.com/AWSCLIV2.pkg\"\u003edownload\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003eYou can install to any folder, or choose the recommended default folder of \u003ccode\u003e/usr/local/aws-cli\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eThe installer automatically creates a symlink at \u003ccode\u003e/usr/local/bin/aws\u003c/code\u003e that links to the main program in the installation folder you chose.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eCheck to see if it's installed properly\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ \u003cspan class=\"token function\"\u003ewhich\u003c/span\u003e aws\n/usr/local/bin/aws \n$ aws --version\naws-cli/2.4.5 Python/3.8.8 Darwin/18.7.0 botocore/2.4.5\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eYou can access your AWS services via:\n\u003col\u003e\n\u003cli\u003eNamed profiles\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eAWS uses \u003ccode\u003e~./aws/credentials\u003c/code\u003e file for accessing your AWS accounts where you can have multiple profiles but you should probably have a \u003ccode\u003edefault\u003c/code\u003e profile\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003edefault\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eaws_access_key_id\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eAAAAAAAAAAAAAEXAMPLE\n\u003cspan class=\"token assign-left variable\"\u003eaws_secret_access_key\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e123456789123456789\u003c/span\u003e\n\n\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003euser1\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eaws_access_key_id\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eBBBBBBBBBBBBBEXAMPLE\n\u003cspan class=\"token assign-left variable\"\u003eaws_secret_access_key\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e12345678923456789\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eYou can also define the default regions for each profile in \u003ccode\u003e~/.aws/config\u003c/code\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003edefault\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eregion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eus-west-2\n\u003cspan class=\"token assign-left variable\"\u003eoutput\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003ejson\n\n\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eprofile user1\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eregion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eus-east-1\n\u003cspan class=\"token assign-left variable\"\u003eoutput\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003etext\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eAccessing a specific profile's resources you just have to pass in the \u003ccode\u003e--profile \u0026#x3C;PROFILE_NAME\u003e\u003c/code\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ aws s3 \u003cspan class=\"token function\"\u003els\u003c/span\u003e --profile default\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eEnvironment variables\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eYou can also pass in environment variables access key/secrets\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ \u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_ACCESS_KEY_ID\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eBBBBBBBBBBBBBEXAMPLE\n$ \u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_SECRET_ACCESS_KEY\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e12345678923456789\u003c/span\u003e\n$ \u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_DEFAULT_REGION\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eus-west-2\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eNow, getting your \u003ccode\u003eAWS_ACCESS_KEY_ID\u003c/code\u003e \u0026#x26; \u003ccode\u003eAWS_SECRET_ACCESS_KEY\u003c/code\u003e values\n\u003col\u003e\n\u003cli\u003eGo to Amazon Web Services console and click on the name of your account (it is located in the top right corner of the console). Then, in the expanded drop-down list, select \u003ccode\u003eSecurity Credentials\u003c/code\u003e.\n\u003cimg src=\"public/assets/blog/aws/credentials_1.jpg\" alt=\"Security Page\"\u003e\u003c/li\u003e\n\u003cli\u003eClick the \u003ccode\u003eAccess keys (access key ID and secret access key)\u003c/code\u003e accordion title and click \u003ccode\u003eCreate New Access Key\u003c/code\u003e\n\u003cimg src=\"public/assets/blog/aws/credentials_2.jpg\" alt=\"Security Page\"\u003e\u003c/li\u003e\n\u003cli\u003eClick \u003ccode\u003eShow Access Key\u003c/code\u003e to have it displayed on the screen. Note, that you can download it to your machine as a file and open it whenever needed. To download it, just click the \u003ccode\u003eDownload Key File\u003c/code\u003e button.\n\u003cimg src=\"public/assets/blog/aws/credentials_2.jpg\" alt=\"Security Page\"\u003e\u003c/li\u003e\n\u003cli\u003eNow update your \u003ccode\u003e~/.aws/credentials\u003c/code\u003e file with this key pair\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003edefault\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eaws_access_key_id\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eAAAAAAAAAAAAAEXAMPLE\n\u003cspan class=\"token assign-left variable\"\u003eaws_secret_access_key\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e123456789123456789\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eS3\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eStorage\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eCLoudFront\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eDistribute your static content at AWS edge locations\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eACM\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eAWS Certificate Manager is a service provided by Amazon that issues on-demand TLS certificates at no cost. Much like Letâ€™s Encrypt, Amazon controls the Certificate Authority (Amazon Trust Services, LLC) behind the certificates, as well as the accompanying API to manage them.\u003c/li\u003e\n\u003cli\u003eAmazon Certificate Manager (ACM) provides an elegant wayt to convert  a cumbersome multi-step process (the process of provisioning, validating, and configuring Transport Layer Security (TLS) certificates) into a single step\u003c/li\u003e\n\u003cli\u003eACM certificates can only be associated with AWS Elastic and Application Load Balancers, CloudFront distributions, and API Gateway endpoints.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eRoute53\u003c/h1\u003e\n\u003ch1\u003eAPI Gateway\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eAllows you to make RESTful applications\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eLambda\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eServerless functions\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eDynamoDB\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eDynamoDB is a NoSQL database service\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eRDS\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eRelational Database Service (RDS)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eAurora DB\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eMySQL and PostgreSQL-compatible relational database built for the cloud. Performance and availability of commercial-grade databases at 1/10th the cost.\u003c/li\u003e\n\u003cli\u003eAmazon Aurora is a MySQL and PostgreSQL-compatible relational database built for the cloud, that combines the performance and availability of traditional enterprise databases with the simplicity and cost-effectiveness of open source databases.\u003c/li\u003e\n\u003cli\u003eAmazon Aurora is up to five times faster than standard MySQL databases and three times faster than standard PostgreSQL databases.\u003c/li\u003e\n\u003cli\u003eDB normally run on an EC and it a pain to scale\u003c/li\u003e\n\u003cli\u003eAurora scale automatically,\u003c/li\u003e\n\u003cli\u003eAurora make 6 copies of your data distributes around multiple locations\u003c/li\u003e\n\u003cli\u003eContinuously backs it up to S3 so your data is safe\u003c/li\u003e\n\u003cli\u003eAurora can also replicate around multiple regions\u003c/li\u003e\n\u003cli\u003eIt's fully managed\u003c/li\u003e\n\u003cli\u003eAurora comes in 2 flavors\n\u003cul\u003e\n\u003cli\u003eAurora Basic\u003c/li\u003e\n\u003cli\u003eAurora Serverless (scales as much as you need and shuts down when you don't need it)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eAurora uses a data API to access the data, which is different to how you normally connect to a relational database (via connections)\n\u003cul\u003e\n\u003cli\u003eWorking with Relational Database you have to connect to the DB, do your operations, then closing the connections\u003c/li\u003e\n\u003cli\u003eIn the world of Serverless it become a little problematic cause you can have multiple lambda functions and they will all be handling the connections independenly which can lead to problems in your database like running out of open connections, your killing the memory, making it preform really bad\u003c/li\u003e\n\u003cli\u003eYou can use an AWS Proxy that sits between your Database and your lambda functions and will handle the connections\u003c/li\u003e\n\u003cli\u003eYou should really just use this if you have legacy DB\u003c/li\u003e\n\u003cli\u003eIf you are building a new application, just use the Aurora Serverless and save yourself the headache\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eDynamoDB used the model of accessing the DB via the API\u003c/li\u003e\n\u003cli\u003eIn the serverless world dealing with DB connections is a pain,\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eTerraform (Infrastructure as Code) to build out your services\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eWhy?\n\u003cul\u003e\n\u003cli\u003eTo document all the services that are being used\u003c/li\u003e\n\u003cli\u003eRepeatable \u0026#x26; reusable solution\u003c/li\u003e\n\u003cli\u003eTare down all the services created with Terraform because TF creates an inventory of all the services in a state file\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eTerraform for a client-side static web application\u003c/h1\u003e\n\u003ch2\u003eThe variable file\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eThis file is the only \u003ccode\u003e.tf\u003c/code\u003e file where you need to update values the rest of the \u003ccode\u003e.tf\u003c/code\u003e files are totally project agnostic\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./varables.tf)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Required variables (values passed in via command)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e domain_name \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e hosted_zone_name \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e env_tags \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# TF version \u0026#x26; State file config\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ebackend\u003cspan class=\"token type variable\"\u003e \"s3\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ekey\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u0026#x3C;YOUR_PROJECT_NAME_HERE\u003e\"\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# this will define the TF state file\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003erequired_version\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003e= 0.13.5\"\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003erequired_providers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eaws\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003esource\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hashicorp/aws\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"~\u003e3.4\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Default region\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"region\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.region\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Interpolated Values\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elocals\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003edomain_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003edomain_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Data\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_caller_identity\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"current\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eS3\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eUse S3 to store the static web files and a second bucket for logging\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./s3.tf)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_s3_bucket\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"site\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e local.bucket_name\n  \u003cspan class=\"token property\"\u003eacl\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"private\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003epolicy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.aws_iam_policy_document.website_s3_policy.json\n\n  \u003cspan class=\"token keyword\"\u003ewebsite\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eindex_document\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index.html\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eerror_document\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"404.html\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003etags\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eEnvironment\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.env_tags\n    \u003cspan class=\"token property\"\u003eCreated_with\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Terraform\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_s3_bucket\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"log_bucket\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elocal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003ebucket_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e-logs\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eacl\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"log-delivery-write\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003ePolicies\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eThis policie only allows access via CloudFront to serve the webcontent\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./policies.tf)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"website_s3_policy\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003estatement\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eactions\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"s3:GetObject\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresources\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"arn:aws:s3:::\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elocal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003ebucket_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e/*\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprincipals\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"AWS\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eidentifiers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_cloudfront_origin_access_identity\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewebsite_origin_access_identity\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eiam_arn\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eRoute53\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eMake sure that you purchase your domain name beforehand because we will need the Hosted Zone Id\u003c/li\u003e\n\u003cli\u003eWe will use TF to create an \u003ccode\u003eA\u003c/code\u003e record to connect to the CloudFront instance\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./route53.tf)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_route53_record\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"domain\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e local.domain_name\n  \u003cspan class=\"token property\"\u003ezone_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.aws_route53_zone.base.zone_id\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"A\"\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ealias\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ename\u003c/span\u003e                   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_distribution.website_cdn.domain_name\n    \u003cspan class=\"token property\"\u003ezone_id\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_distribution.website_cdn.hosted_zone_id\n    \u003cspan class=\"token property\"\u003eevaluate_target_health\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_route53_zone\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"base\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e         \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003ehosted_zone_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e.\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eprivate_zone\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eACM for certs\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eACM provides an elegant wayt to convert  a cumbersome multi-step process into a single step, however when combined with Terraform this process is a little more complex because some processes have to happen in senquential steps\u003c/li\u003e\n\u003cli\u003eSome of the TF modules include:\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eaws_acm_certificate\u003c/code\u003e: To request a certificate for example.com\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eaws_route53_record\u003c/code\u003e: To create a DNS record to validate the certificate request\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eaws_certificate_validation\u003c/code\u003e: To ensure that ACM validates our DNS record before certificate use\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eIn an effort to reduce the timming steps, \u003ca href=\"https://www.azavea.com/\"\u003eazavea's team\u003c/a\u003e assembled a reusable \u003ca href=\"https://github.com/azavea/terraform-aws-acm-certificate\"\u003eTerraform module\u003c/a\u003e to encapsulate the ACM and Route 53 resources used. Using the output from the validation resource ensures that Terraform will wait for ACM to validate the certificate before resolving its ARN. Now, the process of creating, validating, and waiting for a valid certificate looks like this:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./certs.tf)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_route53_zone\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"base\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e         \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003ehosted_zone_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e.\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eprivate_zone\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-east-1\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ealias\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"certificates\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.region\n  \u003cspan class=\"token property\"\u003ealias\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"dns\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003emodule\u003cspan class=\"token type variable\"\u003e \"cert\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esource\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"github.com/azavea/terraform-aws-acm-certificate?ref=3.0.0\"\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eproviders\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eaws.acm_account\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws.certificates\n    \u003cspan class=\"token property\"\u003eaws.route53_account\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws.dns\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e                       \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e local.domain_name\n  \u003cspan class=\"token property\"\u003ehosted_zone_id\u003c/span\u003e                    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.aws_route53_zone.base.zone_id\n  \u003cspan class=\"token property\"\u003evalidation_record_ttl\u003c/span\u003e             \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"60\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eallow_validation_record_overwrite\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_route53_record\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"domain\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e local.domain_name\n  \u003cspan class=\"token property\"\u003ezone_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.aws_route53_zone.base.zone_id\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"A\"\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ealias\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ename\u003c/span\u003e                   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_distribution.website_cdn.domain_name\n    \u003cspan class=\"token property\"\u003ezone_id\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_distribution.website_cdn.hosted_zone_id\n    \u003cspan class=\"token property\"\u003eevaluate_target_health\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eCloudFront\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eCloudFront allows for global distribution of our web content with the ability to cache content at AWS edge locations\u003c/li\u003e\n\u003cli\u003eThe CloudFront configuration is kind of a beast\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./cloudfront.tf)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_cloudfront_origin_access_identity\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"website_origin_access_identity\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ecomment\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"site \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003eworkspace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e Access Identity\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_cloudfront_distribution\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"website_cdn\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eorigin\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_s3_bucket.site.bucket_regional_domain_name\n    \u003cspan class=\"token property\"\u003eorigin_id\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"origin-bucket-\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_s3_bucket\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esite\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003es3_origin_config\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eorigin_access_identity\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_origin_access_identity.website_origin_access_identity.cloudfront_access_identity_path\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eenabled\u003c/span\u003e             \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eis_ipv6_enabled\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault_root_object\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index.html\"\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003elogging_config\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003einclude_cookies\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_s3_bucket.log_bucket.bucket_domain_name\n    \u003cspan class=\"token property\"\u003eprefix\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"cloudfront_logs\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003ealiases\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003elocal.domain_name\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003edefault_cache_behavior\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eallowed_methods\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"DELETE\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"PATCH\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"PUT\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecached_methods\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_origin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"origin-bucket-\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_s3_bucket\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esite\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eforwarded_values\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003equery_string\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"true\"\u003c/span\u003e\n\n      \u003cspan class=\"token keyword\"\u003ecookies\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003eforward\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"none\"\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token property\"\u003eviewer_protocol_policy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"redirect-to-https\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecompress\u003c/span\u003e               \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emin_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edefault_ttl\u003c/span\u003e            \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e300\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emax_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1200\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# Cache behavior with precedence 0\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eordered_cache_behavior\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003epath_pattern\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/index.html\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eallowed_methods\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"DELETE\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"PATCH\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"PUT\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecached_methods\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_origin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"origin-bucket-\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_s3_bucket\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esite\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eforwarded_values\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003equery_string\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"true\"\u003c/span\u003e\n\n      \u003cspan class=\"token keyword\"\u003ecookies\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003eforward\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"none\"\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token property\"\u003emin_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edefault_ttl\u003c/span\u003e            \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emax_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecompress\u003c/span\u003e               \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eviewer_protocol_policy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"redirect-to-https\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003ecustom_error_response\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eerror_code\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"404\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresponse_code\u003c/span\u003e      \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"200\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresponse_page_path\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/index.html\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \n  \u003cspan class=\"token keyword\"\u003ecustom_error_response\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eerror_code\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"403\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresponse_code\u003c/span\u003e      \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"200\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresponse_page_path\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/index.html\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eprice_class\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"PriceClass_100\"\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PriceClass.html\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003erestrictions\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003egeo_restriction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003erestriction_type\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"none\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eviewer_certificate\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eacm_certificate_arn\u003c/span\u003e      \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e module.cert.arn\n    \u003cspan class=\"token property\"\u003essl_support_method\u003c/span\u003e       \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"sni-only\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eminimum_protocol_version\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"TLSv1\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003elifecycle\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eignore_changes\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003etags\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003etags\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eEnvironment\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.env_tags\n    \u003cspan class=\"token property\"\u003eCreated_with\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Terraform\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eFinally the \u003ccode\u003e.tfvars\u003c/code\u003e file\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eCreating a \u003ccode\u003e.tfvar\u003c/code\u003e file allows you to deploy this applications to multiple environments (dev|statging|prod)\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./env_configs/prod.tfvars)\u003c/span\u003e\n\u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e      \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"myawesomesite.com\"\u003c/span\u003e\n\u003cspan class=\"token property\"\u003ehosted_zone_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"myawesomesite.com\"\u003c/span\u003e\n\u003cspan class=\"token property\"\u003eenv_tags\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Production\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eNow running this\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token comment\"\u003e# *NOTE* run these commands in the terraform folder\u003c/span\u003e\n\n\u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_PROFILE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u0026#x3C;YOUR_AWS_PROFILE_HERE\u003e\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eCLIENT_BUCKET_NAME\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u0026#x3C;YOUR_AWS_S3_BUCKET_NAME\u003e\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eTERRAFORM_STATE_BUCKET_NAME\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u0026#x3C;YOUR_TF_REMOTE_STATE_BUCKET_NAME\u003e\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Environment variables\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eWORKSPACE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"prod\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eVAR_FILE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"./env/prod.tfvars\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# TF version\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003etf_ver\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"v0.13.5\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003e \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003eTerraform --version\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=~\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Terraform \u003cspan class=\"token variable\"\u003e$tf_ver\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Terraform \u003cspan class=\"token variable\"\u003e$tf_ver\u003c/span\u003e is required\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003eexit\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Cleanup .terraform\u003c/span\u003e\n\u003cspan class=\"token function\"\u003erm\u003c/span\u003e -rf .terraform/\n\n\u003cspan class=\"token comment\"\u003e# Deploy terraform\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"[Running] terraform\"\u003c/span\u003e\nterraform init -backend-config \u003cspan class=\"token assign-left variable\"\u003ebucket\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e${TERRAFORM_STATE_BUCKET_NAME}\u003c/span\u003e\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# If the workspace does not exist, create it.\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003e terraform workspace \u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token variable\"\u003e${WORKSPACE}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e terraform workspace new \u003cspan class=\"token variable\"\u003e${WORKSPACE}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\nterraform apply -auto-approve -var-file\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$VAR_FILE\u003c/span\u003e\n\n\u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# where the package.json file exist\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Build the static files\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"[Build] production version of the website]\"\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eyarn\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eyarn\u003c/span\u003e run build\n\n\u003cspan class=\"token comment\"\u003e# Upload the source code to AWS S3\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"[Upload] website content\"\u003c/span\u003e\naws s3 \u003cspan class=\"token function\"\u003erm\u003c/span\u003e s3://\u003cspan class=\"token variable\"\u003e$CLIENT_BUCKET_NAME\u003c/span\u003e/  --recursive\naws s3 \u003cspan class=\"token function\"\u003esync\u003c/span\u003e dist/ s3://\u003cspan class=\"token variable\"\u003e$CLIENT_BUCKET_NAME\u003c/span\u003e/ --exclude \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\"*.DS_Store*\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\"\naws s3 \u003cspan class=\"token function\"\u003ecp\u003c/span\u003e dist/index.html s3://\u003cspan class=\"token variable\"\u003e$CLIENT_BUCKET_NAME\u003c/span\u003e/ --cache-control max-age\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eCloudFront add a secondary failover origin\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eCreate a bucket and a CloudFront ditribution:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003evariable \u003cspan class=\"token string\"\u003e\"primary_bucket_name\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my-awesome-site\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"s3_origin_id\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"myS3Origin\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Primary Origin\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"primary_origin_website_s3_policy\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003estatement\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003esid\u003c/span\u003e       \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"bucket_policy_for_primary\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eactions\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"s3:GetObject\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eeffect\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Allow\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresources\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"arn:aws:s3:::\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003eprimary_bucket_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e/*\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprincipals\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"AWS\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eidentifiers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eaws_cloudfront_origin_access_identity.website_origin_access_identity.iam_arn\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_s3_bucket\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"primary_origin\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.primary_bucket_name\n  \u003cspan class=\"token property\"\u003eacl\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"private\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003epolicy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.aws_iam_policy_document.primary_origin_website_s3_policy.json\n\n  \u003cspan class=\"token keyword\"\u003ewebsite\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eindex_document\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index.html\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eerror_document\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"404.html\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003etags\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eforce_destroy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\n\u003cspan class=\"token comment\"\u003e# CloudFront (With single origin)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_cloudfront_origin_access_identity\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"website_origin_access_identity\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ecomment\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"site \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003eworkspace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e Access Identity\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_cloudfront_distribution\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"s3_distribution\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eorigin\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_s3_bucket.primary_origin.bucket_regional_domain_name\n    \u003cspan class=\"token property\"\u003eorigin_id\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.s3_origin_id\n\n    \u003cspan class=\"token keyword\"\u003es3_origin_config\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eorigin_access_identity\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_origin_access_identity.website_origin_access_identity.cloudfront_access_identity_path\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eenabled\u003c/span\u003e             \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eis_ipv6_enabled\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ecomment\u003c/span\u003e             \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Some comment\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault_root_object\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index.html\"\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003elogging_config\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003einclude_cookies\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"mylogs.s3.amazonaws.com\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eprefix\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"myprefix\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003ealiases\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"mysite.example.com\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"yoursite.example.com\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003edefault_cache_behavior\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eallowed_methods\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"DELETE\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"PATCH\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"PUT\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecached_methods\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_origin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.s3_origin_id\n\n    \u003cspan class=\"token keyword\"\u003eforwarded_values\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003equery_string\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\n      \u003cspan class=\"token keyword\"\u003ecookies\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003eforward\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"none\"\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token property\"\u003eviewer_protocol_policy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"allow-all\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emin_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edefault_ttl\u003c/span\u003e            \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e3600\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emax_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e86400\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# Cache behavior with precedence 0\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eordered_cache_behavior\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003epath_pattern\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/index.html\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eallowed_methods\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecached_methods\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_origin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.s3_origin_id\n\n    \u003cspan class=\"token keyword\"\u003eforwarded_values\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003equery_string\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"true\"\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003ecookies\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003eforward\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"none\"\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token property\"\u003emin_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edefault_ttl\u003c/span\u003e            \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e86400\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emax_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e31536000\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecompress\u003c/span\u003e               \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eviewer_protocol_policy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"redirect-to-https\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eprice_class\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"PriceClass_200\"\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003erestrictions\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003egeo_restriction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003erestriction_type\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"none\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003etags\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eEnvironment\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"production\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eviewer_certificate\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecloudfront_default_certificate\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eNow add a second bucket in another region and update your CloudFront config block to allow for secondary origin\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# Add a bucket in another region\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"eu-west-1\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ealias\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"failover_region\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\nvariable \u003cspan class=\"token string\"\u003e\"secondary_bucket_name\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my-awesome-site-failover\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Secondary Bucket\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"secondary_origin_website_s3_policy\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eprovider\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws.failover_region\n\n  \u003cspan class=\"token keyword\"\u003estatement\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003esid\u003c/span\u003e       \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"bucket_policy_for_secondary\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eactions\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"s3:GetObject\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eeffect\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Allow\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresources\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"arn:aws:s3:::\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003esecondary_bucket_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e/*\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprincipals\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"AWS\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eidentifiers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eaws_cloudfront_origin_access_identity.website_origin_access_identity.iam_arn\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_s3_bucket\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"secondary_origin\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eprovider\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws.failover_region\n\n  \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.secondary_bucket_name\n  \u003cspan class=\"token property\"\u003eacl\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"private\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003epolicy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.aws_iam_policy_document.secondary_origin_website_s3_policy.json\n\n  \u003cspan class=\"token keyword\"\u003ewebsite\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eindex_document\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index.html\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eerror_document\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"404.html\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003etags\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eforce_destroy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"token comment\"\u003e# Update your cloudfront distribution\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_cloudfront_distribution\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"s3_distribution\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# Add an `origin group`\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eorigin_group\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eorigin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"OriginWithFailover\"\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003efailover_criteria\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003estatus_codes\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e403\u003c/span\u003e, \u003cspan class=\"token number\"\u003e404\u003c/span\u003e, \u003cspan class=\"token number\"\u003e500\u003c/span\u003e, \u003cspan class=\"token number\"\u003e502\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# *NOTE: this order matters! (first one will be the primary)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003emember\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eorigin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"primaryS3\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003emember\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eorigin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"failoverS3\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# Add a second origin\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eorigin\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_s3_bucket.secondary_origin.bucket_regional_domain_name\n    \u003cspan class=\"token property\"\u003eorigin_id\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"failoverS3\"\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003es3_origin_config\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eorigin_access_identity\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_origin_access_identity.website_origin_access_identity.cloudfront_access_identity_path\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003edefault_cache_behavior\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_origin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"OriginWithFailover\"\u003c/span\u003e\n\n    \u003cspan class=\"token property\"\u003eallowed_methods\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecached_methods\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# *...\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eordered_cache_behavior\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_origin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"OriginWithFailover\"\u003c/span\u003e\n\n    \u003cspan class=\"token property\"\u003eallowed_methods\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Note \u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecached_methods\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# *...\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# *...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eNow you can test it by uploading this below HTML to the bucket in the \u003ccode\u003eeu-west-1\u003c/code\u003e and leave the \u003ccode\u003eus-west-2\u003c/code\u003e empty for now\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003e\u003cspan class=\"token doctype\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;!\u003c/span\u003e\u003cspan class=\"token doctype-tag\"\u003edoctype\u003c/span\u003e \u003cspan class=\"token name\"\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ehtml\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003elang\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003een\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003etitle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003eeu-west-1\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003etitle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eh1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003eeu-west-1\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003eh1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eimg\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003esrc\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eimage.jpg\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eIf you go to the CloudFront URL, you should see a site that says \u003ccode\u003eeu-west-1\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eNow Add the below html to the \u003ccode\u003eus-west-2\u003c/code\u003e bucket:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003e\u003cspan class=\"token doctype\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;!\u003c/span\u003e\u003cspan class=\"token doctype-tag\"\u003edoctype\u003c/span\u003e \u003cspan class=\"token name\"\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ehtml\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003elang\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003een\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003etitle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003eus-west-2\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003etitle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eh1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003eus-west-2\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003eh1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eimg\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003esrc\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eimage.jpg\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eIf you refresh your browser you should now see \u003ccode\u003eus-west-2\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eAWS CDK (AWS Cloud Development Kit)\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eThe AWS CDK (Amazon Web Services Cloud Development Kit) is a \u003ca href=\"https://github.com/aws/aws-cdk\"\u003enew open source framework\u003c/a\u003e to define cloud infrastructure in code (Infrastructure as Code) and provisioning it through AWS CloudFormation.\u003c/li\u003e\n\u003cli\u003eCDK provides many high level components to allow rapid code development requiring much less input compared to the typical CloudFormation templates.\u003c/li\u003e\n\u003cli\u003eCDK is available in TypeScript, Python, Java and C#.\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token comment\"\u003e# Install globally \u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003enpm\u003c/span\u003e i -g aws-cdk\n\n$ \u003cspan class=\"token function\"\u003emkdir\u003c/span\u003e my-app \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e my-app\n$ cdk init app --language\u003cspan class=\"token operator\"\u003e=\u003c/span\u003etypescript\n\n$ \u003cspan class=\"token function\"\u003enpm\u003c/span\u003e i @aws-cdk/aws-apigatewayv2 @aws-cdk/aws-apigatewayv2-integrations @aws-cdk/aws-ec2 @aws-cdk/aws-lambda @aws-cdk/aws-rds @aws-cdk/core source-map-support\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003ePostGIS\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.martinpeters.ie/2020/02/01/cdk-rds-postgis-setup/\"\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eAWS SAM (AWS Serverless Application Model)\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eSAM is an open-source framework for building serverless applications.\u003c/li\u003e\n\u003cli\u003eYou define the services you want in YAML and during the deployment SAM will convert it to CloudFormation syntax\u003c/li\u003e\n\u003cli\u003eSAM can be installed with \u003ccode\u003eHomebrew\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eSAM allows you to run your application locally so you can test it out and debug\u003c/li\u003e\n\u003cli\u003eSAM is Infrastructure as Code\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eInstalling SAM on MacOS\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install-mac.html\"\u003eHow to install SAM\u003c/a\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ brew tap aws/tap\n$ brew \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e aws-sam-cli\n$ sam --version\n\n$ brew upgrade aws-sam-cli\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eGet setup\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eStart by scaffolding your application\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token comment\"\u003e# Step 1 - Download a sample application\u003c/span\u003e\n$ sam init\n\u003cspan class=\"token comment\"\u003e# 1 - AWS Quick Start Templates\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# 1 - Zip (artifact is a zip uploaded to S3)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# 1 - nodejs14.x\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# AWS quick start application templates:\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    1 - Hello World Example\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    2 - Step Functions Sample App (Stock Trader)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    3 - Quick Start: From Scratch\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    4 - Quick Start: Scheduled Events\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    5 - Quick Start: S3\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    6 - Quick Start: SNS\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    7 - Quick Start: SQS\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    8 - Quick Start: Web Backend\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Step 2 run your code locally\u003c/span\u003e\n$ sam \u003cspan class=\"token builtin class-name\"\u003elocal\u003c/span\u003e start-api\n\n\u003cspan class=\"token comment\"\u003e# Step 3 - Build your application\u003c/span\u003e\n$ \u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e sam-app\n$ sam build\n\n\u003cspan class=\"token comment\"\u003e# Step 4 - Deploy your application\u003c/span\u003e\n$ sam deploy --guided\n\u003cspan class=\"token comment\"\u003e# Once everything is deployed it will print out the REST Endpoint `https://\u0026#x3C;RANDOM_STRING\u003e.execute-api.us-west-2.amazonaws.com/Prod/`\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eCheck your stuff out in AWS Console\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eYou can view your SAM application in AWS Console by going to \u003ccode\u003eLambda\u003c/code\u003e \u003e \u003ccode\u003eApplications\u003c/code\u003e\n\u003cimg src=\"/assets/blog/aws/aws-console_serverless-application.png\" alt=\"aws-console_serverless-application\"\u003e\u003c/li\u003e\n\u003cli\u003eYou can view your stack my clicking the \u003ccode\u003eCloudFormation\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eCheck your stuff within VSCode with the \u003ccode\u003eServerless Console\u003c/code\u003e extension\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eYou can use a vscode extension \u003ca href=\"https://marketplace.visualstudio.com/items?itemName=devAdvice.serverlessconsole\"\u003eServerless Console\u003c/a\u003e to view all the logs\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIn vscode click the lighting bolt in the quick look panel\u003c/li\u003e\n\u003cli\u003eCreate a connection\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/assets/blog/aws/serverless-console_connect.png\" alt=\"serverless-console_connect\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/blog/aws/serverless-console_panel.png\" alt=\"serverless-console_panel\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eInvoke your Lambda function directly\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ sam \u003cspan class=\"token builtin class-name\"\u003elocal\u003c/span\u003e invoke \u003cspan class=\"token string\"\u003e\"HelloWorldFunction\"\u003c/span\u003e -e events/event.json\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eCleanup\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eTo delete the sample application that you created, use the AWS CLI. Assuming you used your project name for the stack name, you can run the following:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003eaws cloudformation delete-stack --stack-name \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eSTACK_NAME\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","ogImage":{"url":"/assets/covers/aws.jpg"},"coverImage":"/assets/covers/aws.jpg"}},"__N_SSG":true},"page":"/learn/[slug]","query":{"slug":"aws"},"buildId":"uOEqA3AejMNRXWmH9me8c","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>