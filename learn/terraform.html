<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="Not another learning site."/><meta property="og:image" content="https://og-image.now.sh/Next.js%20Blog%20Starter%20Example.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><title>Not another learning site.</title><meta property="og:image" content="/assets/covers/terraform.jpg"/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/d8d6bd39d8240bb4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d8d6bd39d8240bb4.css" data-n-g=""/><link rel="preload" href="/_next/static/css/cf121497002c184d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cf121497002c184d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-779b41245c009d2a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-156acf25c3b6001c.js" defer=""></script><script src="/_next/static/chunks/664-4243e6d8b13d56da.js" defer=""></script><script src="/_next/static/chunks/pages/learn/%5Bslug%5D-f7c40571bdb12048.js" defer=""></script><script src="/_next/static/EkTy0ofHgnF_2CImAlSoL/_buildManifest.js" defer=""></script><script src="/_next/static/EkTy0ofHgnF_2CImAlSoL/_ssgManifest.js" defer=""></script><script src="/_next/static/EkTy0ofHgnF_2CImAlSoL/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="min-h-screen"><main><div class="container mx-auto px-5"><div style="position:fixed;background-color:rgba(255,255,255,0.9);backdrop-filter:blur(10px);width:100%;left:0px;z-index:1000"><h2 class="text-2xl md:text-4xl font-bold tracking-tight md:tracking-tighter leading-tight mb-20 mt-8" style="padding:0;padding-left:10px;margin-bottom:20px"><a class="hover:underline" href="/">Learn</a>.</h2></div><article class="mb-32"><div style="height:100px"></div><h1 class="text-6xl md:text-7xl lg:text-8xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">terraform</h1><div class="mb-8 md:mb-16 sm:mx-0"><div class="sm:mx-0"><img src="/assets/covers/terraform.jpg" alt="Cover Image for terraform" class="shadow-sm" layout="responsive" width="1240" height="620"/></div></div><div class="max-w-2xl mx-auto"><div class="block md:hidden mb-6"><div>TODO: add language chip here</div></div></div><div class="max-w-2xl mx-auto"><div class="markdown-styles_markdown__h_8de"><details>
<summary>What is Terraform</summary>
<ul>
<li>
<p>Terraform is <code>Infrasture as code</code></p>
</li>
<li>
<p>Other "infrasture-as-code" are: chef, puppet, anisble, SaltStack, CloudFoundation</p>
</li>
<li>
<p>The major building pieces to TF are:</p>
<ul>
<li>variable (variables)</li>
<li>locals (variables with interpellation)</li>
<li>provider (aws|azure|google)</li>
<li>provisioners (execute scripts on a local or remote machine as part of the creation or destruction)</li>
<li>data (get information on existing services)</li>
<li>resource (create resource)</li>
<li>module (isolate configuration)</li>
</ul>
</li>
<li>
<p>Links:</p>
<ul>
<li><a href="https://blog.gruntwork.io/an-introduction-to-terraform-f17df9c6d180">intro</a></li>
<li><a href="https://medium.com/@pavloosadchyi/terraform-patterns-and-tricks-i-use-every-day-117861531173">medium post</a></li>
</ul>
</li>
<li>
<p>Terraform is <code>declarative</code>, it says "I declare therefore i am"</p>
</li>
<li>
<p>non-Terraform services do not get auto-magicly added to your state, Terraform only tracks the things it makes</p>
<ol>
<li>configurations: i declare the intent</li>
<li>State: current state</li>
</ol>
</li>
<li>
<p>dry run <code>$ terraform plan</code></p>
</li>
<li>
<p><strong>NOTE</strong> Terraform ignores subfolders, in order to use subfolders you have to configure the subfolders to be a <code>terraform module</code>, then include those modules in your <code>main.tf</code> file</p>
</li>
</ul>
</details>
<details>
<summary>Install</summary>
<ul>
<li>You can install TF with homebrew but it's better to install it with <code>tfswitch</code> with homebrew</li>
<li><a href="https://warrensbox.github.io/terraform-switcher/">Terraform version manager</a></li>
<li>this will allow you to switch version very easily
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">$ brew install warrensbox/tap/tfswitch
$ tfswitch 0.12.4
$ terraform -v</code></pre></div>
</li>
</ul>
</details>
<details>
<summary>Save remote-state in S3</summary>
<ul>
<li>
<p><a href="https://www.terraform.io/docs/backends/types/s3.html">docs</a></p>
</li>
<li>
<p>It is highly recommended that you enable Bucket Versioning on the S3 bucket to allow for state recovery in the case of accidental deletions and human error.</p>
</li>
<li>
<p>Paths to the state file inside the bucket: <em><code>&#x3C;bucket>/&#x3C;workspace_key_prefix>/&#x3C;workspace_name>/&#x3C;key></code></em></p>
<div class="remark-highlight"><pre class="language-html"><code class="language-html">"Amazon S3"/<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>BUCKET_NAME_FOR_TF_STATE</span><span class="token punctuation">></span></span>/env:/dev/<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>TF_STATE_KEY</span><span class="token punctuation">></span></span>
"Amazon S3"/<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>BUCKET_NAME_FOR_TF_STATE</span><span class="token punctuation">></span></span>/env:/staging/<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>TF_STATE_KEY</span><span class="token punctuation">></span></span>
"Amazon S3"/<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>BUCKET_NAME_FOR_TF_STATE</span><span class="token punctuation">></span></span>/env:/prod/<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>TF_STATE_KEY</span><span class="token punctuation">></span></span>
</code></pre></div>
</li>
<li>
<p>Here is the format for the terraform remote state code block</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token keyword">backend<span class="token type variable"> "s3" </span></span><span class="token punctuation">{</span>
    <span class="token property">bucket</span> <span class="token punctuation">=</span> <span class="token string">"mybucket"</span>
    <span class="token property">key</span>    <span class="token punctuation">=</span> <span class="token string">"path/to/my/key"</span>     <span class="token comment"># &#x3C;TF_STATE_KEY>, it can just be a single string</span>
    <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">"us-east-1"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p>Here is an example for the terraform remote state code block</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token keyword">backend<span class="token type variable"> "s3" </span></span><span class="token punctuation">{</span>
    <span class="token property">key</span>    <span class="token punctuation">=</span> <span class="token string">"someawesomesite"</span>
    <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">"us-west-2"</span>
  <span class="token punctuation">}</span>
  <span class="token property">required_version</span> <span class="token punctuation">=</span> <span class="token string">">= 0.13.5"</span>
  <span class="token keyword">required_providers</span> <span class="token punctuation">{</span>
    <span class="token property">aws</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">"hashicorp/aws"</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">"~>3.4"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p>Key: the path to the state file inside the bucket. When using a non-default workspace, the state path will be /workspace_key_prefix/workspace_name/key</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">data <span class="token type variable">"terraform_remote_state"</span></span> <span class="token string">"network"</span> <span class="token punctuation">{</span>
  <span class="token property">backend</span> <span class="token punctuation">=</span> <span class="token string">"s3"</span>
  <span class="token property">config</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">bucket</span> <span class="token punctuation">=</span> <span class="token string">"terraform-state-prod"</span>
    <span class="token property">key</span>    <span class="token punctuation">=</span> <span class="token string">"network/terraform.tfstate"</span>
    <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">"us-east-1"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p>Or you can have a blank terraform.backend and configure it with bash command</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token assign-left variable">state_key</span><span class="token operator">=</span><span class="token string">"prod/some-app/<span class="token variable">${ENVIRONMENT}</span>.tfstate"</span>
terraform init <span class="token punctuation">\</span>
  -backend-config <span class="token assign-left variable">bucket</span><span class="token operator">=</span><span class="token string">"my-terraform-state-bucket"</span> <span class="token punctuation">\</span>
  -backend-config<span class="token operator">=</span><span class="token string">"key=<span class="token variable">${state_key}</span>"</span> <span class="token punctuation">\</span>
  -backend-config<span class="token operator">=</span><span class="token string">"encrypt=true"</span> <span class="token punctuation">\</span>
  -backend-config<span class="token operator">=</span><span class="token string">"region=us-west-2"</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token keyword">backend<span class="token type variable"> "s3" </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
</details>
<details>
<summary>Terraform CLI</summary>
<ul>
<li>
<p><a href="https://www.terraform.io/docs/commands/index.html">Terraform CLI</a></p>
</li>
<li>
<p><code>$ terraform workspace (list|select|new|delete|show)</code></p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ terraform init
$ terraform validate
$ terraform <span class="token function">fmt</span>   <span class="token comment"># format all terraform at the current folder level </span>
$ terraform plan
$ terraform apply
$ terraform apply -auto-approve
$ terraform output
$ terraform workspace

$ terraform <span class="token function">import</span> aws_s3_bucket.bucket <span class="token operator">&#x3C;</span>bucket-name<span class="token operator">></span>
</code></pre></div>
</li>
<li>
<p>The terraform output command is used to extract the value of an output variable from the state file.</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ terraform plan
$ terraform output

$ <span class="token builtin class-name">cd</span> to-base-of-tf-directory
$ terraform output

$ terraform workspace <span class="token keyword">select</span> prod <span class="token operator">&#x26;&#x26;</span> terraform refresh
</code></pre></div>
</li>
</ul>
</details>
<details>
<summary>Terraform Plugins</summary>
<ul>
<li>Terraform relies on plugins called "providers" to interact with remote systems</li>
<li>Defining your providers:
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token keyword">required_providers</span> <span class="token punctuation">{</span>
    <span class="token property">mycloud</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">"mycorp/mycloud"</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">"~> 1.0"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>The <code>required_providers</code> block must be nested inside the top-level <code>terraform</code> block (which can also contain other settings).</li>
<li><a href="https://registry.terraform.io/namespaces/hashicorp">main providers</a>
<ul>
<li>Lifecycle management of AWS resources, including EC2, Lambda, EKS, ECS, VPC, S3, RDS, DynamoDB, and more. This provider is maintained internally by the HashiCorp AWS Provider team.</li>
</ul>
</li>
</ul>
</details>
<details>
<summary>Variable</summary>
<ul>
<li>
<p>You can define variables and provide <code>type</code>, <code>default</code> value, <code>description</code></p>
</li>
<li>
<p>Varaibles have to be hard-coded (you cannot interpolating values)</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">variable<span class="token type variable"> "some_variable" </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span> <span class="token punctuation">=</span> string
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"hello"</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">"This is an example of a variable that has a string type"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p>Basic variable types are: string/list/map:</p>
</li>
<li>
<p>The basic structure of defining a variable is:</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">variable<span class="token type variable"> "some_key" </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span>    <span class="token punctuation">=</span> <span class="token string">"&#x3C;string|list|map>"</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"&#x3C;SOME_DEFAULT_VALUE>"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p>All variables used have to be defined beforehand</p>
</li>
<li>
<p>Example of the 3 basic types:</p>
<ul>
<li>String
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">variable<span class="token type variable"> some_string </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span> <span class="token punctuation">=</span> <span class="token string">"string"</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"hello terraform string"</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">"this is a simple string"</span>
<span class="token punctuation">}</span>

<span class="token comment"># Use into the resource</span>
<span class="token property">some-parameter</span> <span class="token punctuation">=</span> "$<span class="token punctuation">{</span>var.some_string<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>List
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">variable<span class="token type variable"> some_list </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span> <span class="token punctuation">=</span> <span class="token string">"list"</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>
    <span class="token string">"subnet1"</span>,
    <span class="token string">"subnet2"</span>,
    <span class="token string">"subnet3"</span>,
  <span class="token punctuation">]</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">"this is a list"</span>
<span class="token punctuation">}</span>
<span class="token comment"># Use into the resource</span>
<span class="token property">some-parameter</span> <span class="token punctuation">=</span> "$<span class="token punctuation">{</span>var.some_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>Map
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">variable<span class="token type variable"> some_map </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span> <span class="token punctuation">=</span> <span class="token string">"map"</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">subnet1</span> <span class="token punctuation">=</span> <span class="token string">"subnet1"</span>,
    <span class="token property">subnet2</span> <span class="token punctuation">=</span> <span class="token string">"subnet2"</span>,
    <span class="token property">subnet3</span> <span class="token punctuation">=</span> <span class="token string">"subnet3"</span>,
  <span class="token punctuation">}</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">"this is a map"</span>
<span class="token punctuation">}</span>

<span class="token comment"># Use into the resource</span>
<span class="token property">some-parameter</span> <span class="token punctuation">=</span> "$<span class="token punctuation">{</span>var.some_map<span class="token punctuation">[</span><span class="token string">"subnet1"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
</li>
<li>
<p><code>null</code> value is a special value that has no type</p>
<ul>
<li>a value that represents absence or omission</li>
<li>If you set an argument of a resource or module to null, Terraform behaves as though you had completely omitted it</li>
</ul>
</li>
<li>
<p>When you run terraform all the empty variables (ones without a default value) if not provided in the command will be asked before terraform does it magic.</p>
</li>
<li>
<p>You can also override any variables by passing in them as a flag when you run a terraform command</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ terraform apply -var <span class="token assign-left variable">some_key</span><span class="token operator">=</span><span class="token string">"this rocks"</span>
</code></pre></div>
</li>
<li>
<p>Providing a <code>Variables File</code></p>
<ul>
<li>All <code>*.tfvars</code> will get picked up when you run terraform, sometimes you want to load specific variable files based on the environment you want to deploy so passing supply <code>-var-file=&#x3C;FILE_NAME>.tfvars</code> with variable values might a great way to deal with different variables for different environments</li>
<li><code>tfvar</code> file
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token property">domain_suffix</span> <span class="token punctuation">=</span> <span class="token string">"-dev"</span>
<span class="token property">hosted_zone_name</span> <span class="token punctuation">=</span> <span class="token string">"someawesomesite.com"</span>
<span class="token property">env_tag</span>          <span class="token punctuation">=</span> <span class="token string">"Development"</span>
</code></pre></div>
</li>
<li><code>main.tf</code> file
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">variable<span class="token type variable"> domain_suffix </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">variable<span class="token type variable"> hosted_zone_name </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">variable<span class="token type variable"> env_tag </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div>
</li>
<li><code>Plan</code> script
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token comment"># `plan.sh` script to run a plan</span>
<span class="token assign-left variable">WORKSPACE</span><span class="token operator">=</span><span class="token string">"dev"</span>
<span class="token assign-left variable">VAR_FILE</span><span class="token operator">=</span><span class="token string">"./env_configs/dev.tfvars"</span>
<span class="token assign-left variable">terraform_state_bucket</span><span class="token operator">=</span><span class="token string">"&#x3C;TERRAFORM_S3_STATE_BUCKET>"</span>
<span class="token function">rm</span> -rf .terraform/
terraform init -backend-config <span class="token assign-left variable">bucket</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${terraform_state_bucket}</span>"</span>
<span class="token keyword">if</span> <span class="token operator">!</span> terraform workspace <span class="token keyword">select</span> <span class="token variable">${WORKSPACE}</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  terraform workspace new <span class="token variable">${WORKSPACE}</span>
<span class="token keyword">fi</span>
terraform plan -var-file<span class="token operator">=</span><span class="token variable">$VAR_FILE</span>
</code></pre></div>
</li>
</ul>
</li>
<li>
<p>You can provide variables via the terminal</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">terraform apply -auto-approve <span class="token punctuation">\</span>
  -var<span class="token operator">=</span><span class="token string">"SOME_VAR_NAME=SOME_VALUE"</span> <span class="token punctuation">\</span>
  -var<span class="token operator">=</span><span class="token string">"SOME_OTHER_VAR_NAME=SOME_VALUE"</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">variable<span class="token type variable"> "SOME_VAR_NAME" </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span> <span class="token punctuation">=</span> string
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> "SOME_OTHER_VAR_NAME" </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span> <span class="token punctuation">=</span> string
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
</details>
<details>
<summary>Locals (Local Value Configuration)</summary>
<ul>
<li>
<p>locals are like variables that you can pass in ${dynamic} values</p>
</li>
<li>
<p>A local value assigns a name to an expression, so you can use it multiple times within a module without repeating it.</p>
</li>
<li>
<p>DRY principles, allows you to preform logic to create a value where you don't have to write every time</p>
</li>
<li>
<p>You can also reference the a local variable inside the locals code block</p>
</li>
<li>
<p>eg of locals</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">locals</span> <span class="token punctuation">{</span>
  <span class="token property">bucket_name</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">app_namespace</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>-<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">terraform</span><span class="token punctuation">.</span><span class="token type variable">workspace</span><span class="token punctuation">}</span></span>-client"</span>
  <span class="token property">domain_name</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">domain_name</span><span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">domain_suffix</span><span class="token punctuation">}</span></span>.<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">hosted_zone_name</span><span class="token punctuation">}</span></span>"</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># Ids for multiple sets of EC2 instances, merged together</span>
<span class="token keyword">locals</span> <span class="token punctuation">{</span>
  <span class="token property">instance_ids</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token function">concat</span><span class="token punctuation">(</span>aws_instance<span class="token punctuation">.</span>blue<span class="token punctuation">.</span><span class="token punctuation">*</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> aws_instance<span class="token punctuation">.</span>green<span class="token punctuation">.</span><span class="token punctuation">*</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">}</span></span>"</span>
<span class="token punctuation">}</span>

<span class="token comment"># A computed default name prefix</span>
<span class="token keyword">locals</span> <span class="token punctuation">{</span>
  <span class="token property">default_name_prefix</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">project_name</span><span class="token punctuation">}</span></span>-web"</span>
  <span class="token property">name_prefix</span>         <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">name_prefix</span> <span class="token punctuation">!</span><span class="token punctuation">=</span> <span class="token string">""</span> <span class="token punctuation">?</span> <span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">name_prefix</span> <span class="token punctuation">:</span> <span class="token keyword">local</span><span class="token punctuation">.</span><span class="token type variable">default_name_prefix</span><span class="token punctuation">}</span></span>"</span>
<span class="token punctuation">}</span>

<span class="token comment"># Local values can be interpolated elsewhere using the "local." prefix.</span>
<span class="token keyword">resource <span class="token type variable">"aws_s3_bucket"</span></span> <span class="token string">"files"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">local</span><span class="token punctuation">.</span><span class="token type variable">name_prefix</span><span class="token punctuation">}</span></span>-files"</span>
  <span class="token comment"># ...</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
</details>
<details>
<summary>Provider</summary>
<ul>
<li>
<p><a href="https://www.terraform.io/docs/providers/index.html">providers</a></p>
</li>
<li>
<p>Providers are basically cloud providers as a service</p>
<ul>
<li>IaaS (infrastruture as a Service) like AWS, Azure, GCP</li>
<li>PaaS (Platform as a Service) like Heroku</li>
<li>SaaS (Software as a Service) like DNSimple, CloudFlare</li>
</ul>
</li>
<li>
<p><a href="https://www.terraform.io/docs/providers/aws/index.html">AWS</a></p>
<ul>
<li>you can pass in your access-key/secret-key via environment variables, or hardcoded (not recommended)</li>
</ul>
</li>
<li>
<p><a href="https://alimac.io/static-websites-with-s3-and-hugo-part-1/">tut</a></p>
</li>
<li>
<p>Different ways to define providers:</p>
<ol>
<li>aws creds</li>
</ol>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token comment"># access_key = "${var.aws_access_key}"</span>
  <span class="token comment"># secret_key = "${var.aws_secret_key}"</span>
  <span class="token property">region</span>     <span class="token punctuation">=</span> <span class="token string">"us-east-2"</span>
<span class="token punctuation">}</span>
</code></pre></div>
<ol start="2">
<li>hard-coded:</li>
</ol>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span>     <span class="token punctuation">=</span> <span class="token string">"us-west-2"</span>
  <span class="token property">access_key</span> <span class="token punctuation">=</span> <span class="token string">"my-access-key"</span>
  <span class="token property">secret_key</span> <span class="token punctuation">=</span> <span class="token string">"my-secret-key"</span>
<span class="token punctuation">}</span>
</code></pre></div>
<ol start="3">
<li>via Environment variables</li>
</ol>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_ACCESS_KEY_ID</span><span class="token operator">=</span><span class="token string">"anaccesskey"</span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_SECRET_ACCESS_KEY</span><span class="token operator">=</span><span class="token string">"asecretkey"</span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_DEFAULT_REGION</span><span class="token operator">=</span><span class="token string">"us-west-2"</span>
$ terraform plan
</code></pre></div>
<ol start="4">
<li>shared credentials:</li>
</ol>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span>                  <span class="token punctuation">=</span> <span class="token string">"us-west-2"</span>
  <span class="token property">shared_credentials_file</span> <span class="token punctuation">=</span> <span class="token string">"/Users/tf_user/.aws/creds"</span>
  <span class="token property">profile</span>                 <span class="token punctuation">=</span> <span class="token string">"customprofile"</span>
<span class="token punctuation">}</span>
</code></pre></div>
<ul>
<li><a href="https://www.terraform.io/docs/configuration/providers.html#alias-multiple-provider-instances">using multiple providers</a></li>
</ul>
</li>
</ul>
</details>
<details>
<summary>Data</summary>
<ul>
<li>Get information on an existing resource</li>
<li>aws_route53_zone</li>
<li>aws_caller_identity</li>
<li>aws_acm_certificate</li>
</ul>
</details>
<details>
<summary>Resource</summary>
<ul>
<li>Create AWS resources:
<ul>
<li>aws_iam_policy_document</li>
<li>aws_acm_certificate</li>
<li>aws_acm_certificate_validation</li>
<li>aws_route53_record</li>
<li>aws_s3_bucket</li>
<li>aws_cloudfront_distribution</li>
<li>aws_cloudfront_origin_access_identity</li>
</ul>
</li>
<li>*** you can make a resource optionally if you pass in a count***
<ul>
<li>if you want the resource to be created if var.env == prod
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token property">count</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">env</span> <span class="token punctuation">=</span><span class="token punctuation">=</span> <span class="token string">"prod"</span> <span class="token punctuation">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span></span>"</span>
</code></pre></div>
</li>
</ul>
</li>
</ul>
</details>
<details>
<summary>Provisioners</summary>
<ul>
<li>used to execute scripts on a local or remote machine as part of the creation or destruction</li>
<li>creation-time provisioners
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"aws_instance"</span></span> <span class="token string">"web"</span> <span class="token punctuation">{</span>
  <span class="token comment"># ...</span>
  <span class="token keyword">provisioner<span class="token type variable"> "local-exec" </span></span><span class="token punctuation">{</span>
    <span class="token property">command</span> <span class="token punctuation">=</span> <span class="token string">"echo <span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token type variable">private_ip</span><span class="token punctuation">}</span></span> > file.txt"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>by default provisioners run when a resource is created, not during the updating or any other lifecycle</li>
<li>it is meant for bootstrapping a system</li>
<li>if a creation-time provisioner fails, the resource will be flagged as <em>tainted</em>, and will be planned for destruction upon the next <em>$ terraform apply</em></li>
<li>destroy-time provisioner
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"aws_instance"</span></span> <span class="token string">"web"</span> <span class="token punctuation">{</span>
  <span class="token comment"># ...</span>
  <span class="token keyword">provisioner<span class="token type variable"> "local-exec" </span></span><span class="token punctuation">{</span>
    <span class="token property">when</span>    <span class="token punctuation">=</span> <span class="token string">"destroy"</span>
    <span class="token property">command</span> <span class="token punctuation">=</span> <span class="token string">"echo 'Destroy-time provisioner'"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>multiple provisioners
<ul>
<li>you can add multiple provisioners and they will run in the order they are defined</li>
</ul>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"aws_instance"</span></span> <span class="token string">"web"</span> <span class="token punctuation">{</span>
  <span class="token comment"># ...</span>
  <span class="token keyword">provisioner<span class="token type variable"> "local-exec" </span></span><span class="token punctuation">{</span>
    <span class="token property">command</span> <span class="token punctuation">=</span> <span class="token string">"echo first"</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">provisioner<span class="token type variable"> "local-exec" </span></span><span class="token punctuation">{</span>
    <span class="token property">command</span> <span class="token punctuation">=</span> <span class="token string">"echo second"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
</details>
<details>
<summary>Outputs</summary>
<ul>
<li>
<p>You can print out the values that terraform will generate, when you run it with with <code>$ terraform output</code> it will output all the variable that is provided from the tfstate file</p>
</li>
<li>
<p>When you make a module you can define the <code>output</code> your module provides as getters</p>
</li>
<li>
<p>You can create bash variables from terraform <code>output</code></p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">output<span class="token type variable"> "bucket_name" </span></span><span class="token punctuation">{</span>
  <span class="token property">value</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">local</span><span class="token punctuation">.</span><span class="token type variable">s3_bucket_website_name</span><span class="token punctuation">}</span></span>"</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">terraform apply -auto-approve
<span class="token assign-left variable">bucket_name</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>terraform output bucket_name<span class="token variable">)</span></span>
<span class="token function">npm</span> run build
aws s3 <span class="token function">rm</span> s3://<span class="token variable">$bucket_name</span>/  --recursive
aws s3 <span class="token function">sync</span> build/ s3://<span class="token variable">$bucket_name</span>/ --exclude <span class="token punctuation">\</span>"*.DS_Store*<span class="token punctuation">\</span>"
aws s3 <span class="token function">cp</span> build/index.html s3://<span class="token variable">$bucket_name</span>/ --cache-control max-age<span class="token operator">=</span><span class="token number">0</span>
</code></pre></div>
</li>
</ul>
</details>
<details>
<summary>Workspace</summary>
<ul>
<li><a href="https://www.terraform.io/docs/state/workspaces.html">docs</a></li>
<li>if you don't define a workspace then you only worked on the "default" workspace</li>
<li>defines how operations are executed</li>
<li>where persistent data are stored (for example terraform-state file)</li>
<li>Creating a new workspace:
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ <span class="token assign-left variable">terraform_state_bucket</span><span class="token operator">=</span><span class="token string">"ngp-terraform-remote-config"</span>
$ terraform init -backend-config <span class="token assign-left variable">bucket</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${terraform_state_bucket}</span>"</span>

$ <span class="token assign-left variable">ENVIRONMENT</span><span class="token operator">=</span>dev
$ terraform workspace new <span class="token variable">$ENVIRONMENT</span>
</code></pre></div>
</li>
<li>Using an existing workspace:
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ <span class="token assign-left variable">terraform_state_bucket</span><span class="token operator">=</span><span class="token string">"ngp-terraform-remote-config"</span>
$ terraform init -backend-config <span class="token assign-left variable">bucket</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${terraform_state_bucket}</span>"</span>

$ <span class="token assign-left variable">ENVIRONMENT</span><span class="token operator">=</span>dev
$ terraform workspace <span class="token keyword">select</span> <span class="token variable">$ENVIRONMENT</span>
</code></pre></div>
</li>
</ul>
</details>
<details>
<summary>Auto approve</summary>
<h1>Terraform auto-approve apply</h1>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ terraform apply -auto-approve
</code></pre></div>
</details>
<details>
<summary>Modules</summary>
<ul>
<li>
<p>Terraform ignores subfolders, in order to use subfolders you have to configure the subfolders to be a <code>terraform module</code>, then include those modules in your <code>main.tf</code> file.</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">module<span class="token type variable"> "custom_module" </span></span><span class="token punctuation">{</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"./modules/custom_module"</span>

  <span class="token property">app_name</span> <span class="token punctuation">=</span> <span class="token string">"app-name"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p>Modules can be created locally or accessed at a url</p>
</li>
<li>
<p>It's like a class for terraform, it encapsulate a piece of configuration</p>
</li>
<li>
<p>A container for multiple resources that are used together.</p>
</li>
<li>
<p>Modules structure:</p>
<ol>
<li><strong>Input variables</strong></li>
</ol>
<ul>
<li>accept values from the calling modules</li>
</ul>
<ol start="2">
<li><strong>Output values</strong></li>
</ol>
<ul>
<li>returns values you can ues to populate arguments elsewhere</li>
</ul>
<ol start="3">
<li><strong>Resources</strong></li>
</ol>
<ul>
<li>define 1-or-more infrastructure objects that the module will manage.</li>
</ul>
</li>
<li>
<p>To define a module, create a new directory and place some <code>.tf</code> files inside of it</p>
</li>
<li>
<p>Terraform can load modules either from local relative paths (prefix with <code>./</code>) or from remote repositories</p>
<ul>
<li><code>"./"</code> prefix indicates that the address is a relative filesystem path.</li>
</ul>
</li>
<li>
<p>minimal folder structure:</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token builtin class-name">.</span>
├── README.md
├── main.tf
├── variables.tf
├── outputs.tf
</code></pre></div>
</li>
<li>
<p>Standard structure with nested module</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token builtin class-name">.</span>
├── README.md
├── main.tf
├── variables.tf
├── outputs.tf
├── <span class="token punctuation">..</span>.
├── modules/
│   ├── nestedA/
│   │   ├── README.md
│   │   ├── variables.tf
│   │   ├── main.tf
│   │   ├── outputs.tf
│   ├── nestedB/
</code></pre></div>
</li>
<li>
<p>Accessing the module's outputs you need to reference the module's outputs inside the root tf files. Example <code>./main.tf</code></p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">output<span class="token type variable"> "root_variable_output_val" </span></span><span class="token punctuation">{</span>
  <span class="token property">value</span> <span class="token punctuation">=</span> <span class="token string">"Hello from the root tf"</span>
<span class="token punctuation">}</span>

<span class="token keyword">output<span class="token type variable"> "module_variable_output_val" </span></span><span class="token punctuation">{</span>
  <span class="token property">value</span> <span class="token punctuation">=</span> module.some_awesome_module
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p>Calling modules <code>module.&#x3C;MODULE_NAME>.&#x3C;OUPUT_VALUE></code></p>
</li>
<li>
<p><a href="https://www.terraform.io/docs/modules/sources.html">source modules</a></p>
<ul>
<li>module installer supports:
<ul>
<li>Local paths</li>
<li>Terraform Registry</li>
<li>GitHub</li>
<li>BitbucketGeneric Git, Mercurial repositories</li>
<li>HTTP URLs</li>
<li>S3 buckets</li>
<li>GCS buckets</li>
</ul>
</li>
<li>Example of using modules source
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">module<span class="token type variable"> "consul" </span></span><span class="token punctuation">{</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"./consul"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>Example of using modules source
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">module<span class="token type variable"> "consul" </span></span><span class="token punctuation">{</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"../module_at_parent_level"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>Example of using modules source from Github
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">module<span class="token type variable"> "consul" </span></span><span class="token punctuation">{</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"git::https://github.com/&#x3C;GITHUB_NAMESPACE>/&#x3C;REPO_NAME>.git"</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">module<span class="token type variable"> "consul" </span></span><span class="token punctuation">{</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"git::https://github.com/&#x3C;GITHUB_NAMESPACE>/&#x3C;REPO_NAME>.git?ref=1.2.3"</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">module<span class="token type variable"> "consul" </span></span><span class="token punctuation">{</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"git::https://github.com/&#x3C;GITHUB_NAMESPACE>/&#x3C;REPO_NAME>.git?ref=&#x3C;SOME_BRANCH_NAME>"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
</li>
<li>
<p><a href="https://github.com/azavea/terraform-aws-acm-certificate">terraform-aws-acm-certificate</a></p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">"us-east-1"</span>
  <span class="token property">alias</span>  <span class="token punctuation">=</span> <span class="token string">"certificates"</span>
<span class="token punctuation">}</span>

<span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">"us-west-2"</span>
  <span class="token property">alias</span>  <span class="token punctuation">=</span> <span class="token string">"dns"</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_route53_zone"</span></span> <span class="token string">"default"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">"azavea.com"</span>
<span class="token punctuation">}</span>

<span class="token keyword">module<span class="token type variable"> "cert" </span></span><span class="token punctuation">{</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"github.com/azavea/terraform-aws-acm-certificate?ref=1.1.0"</span>

  <span class="token property">providers</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">aws.acm_account</span>     <span class="token punctuation">=</span> <span class="token string">"aws.certificates"</span>
    <span class="token property">aws.route53_account</span> <span class="token punctuation">=</span> <span class="token string">"aws.dns"</span>
  <span class="token punctuation">}</span>

  <span class="token property">domain_name</span>                       <span class="token punctuation">=</span> <span class="token string">"azavea.com"</span>
  <span class="token property">subject_alternative_names</span>         <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"*.azavea.com"</span><span class="token punctuation">]</span>
  <span class="token property">hosted_zone_id</span>                    <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_route53_zone<span class="token punctuation">.</span>default<span class="token punctuation">.</span>zone_id<span class="token punctuation">}</span></span>"</span>
  <span class="token property">validation_record_ttl</span>             <span class="token punctuation">=</span> <span class="token string">"60"</span>
  <span class="token property">allow_validation_record_overwrite</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p><strong>NOTE:</strong> <em>If you want to conditionally use a module</em>, Terraform 0.13 allows you do add a count to a module. You might want to use this if you only want a module to run in a specific deployment environment</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">variable<span class="token type variable"> forProd </span></span><span class="token punctuation">{</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
<span class="token keyword">resource <span class="token type variable">"resource_type"</span></span> <span class="token string">"resource_name"</span> <span class="token punctuation">{</span>
 <span class="token property">count</span> <span class="token punctuation">=</span> var.forProd ? <span class="token number">1</span> : <span class="token number">0</span>
 ... other resource properties 
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
</details>
<h1>Terraform and Providers</h1>
<details>
<summary>Terraform for New Relic Dashboard</summary>
<ul>
<li>
<p>Assign some variables to the new-relic account id &#x26; api-key</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">variable<span class="token type variable"> account_id </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">variable<span class="token type variable"> api_key </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p>terraform block &#x26; newrelic provider</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token property">required_version</span> <span class="token punctuation">=</span> <span class="token string">">= 0.13.5"</span>
  <span class="token keyword">required_providers</span> <span class="token punctuation">{</span>
    <span class="token property">newrelic</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">"newrelic/newrelic"</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">"~> 2.21.0"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">provider<span class="token type variable"> "newrelic" </span></span><span class="token punctuation">{</span>
  <span class="token property">account_id</span> <span class="token punctuation">=</span> var.account_id
  <span class="token property">api_key</span>    <span class="token punctuation">=</span> var.api_key
  <span class="token property">region</span>     <span class="token punctuation">=</span> <span class="token string">"US"</span> <span class="token comment"># Valid regions are US and EU</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p>Create a new relic one dashboard</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"newrelic_one_dashboard"</span></span> <span class="token string">"nark_dashboard"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span> <span class="token punctuation">=</span> var.dashboard_name

  <span class="token keyword">page</span> <span class="token punctuation">{</span>
    <span class="token property">name</span> <span class="token punctuation">=</span> var.dashboard_name

    <span class="token keyword">widget_markdown</span> <span class="token punctuation">{</span>
      <span class="token property">title</span>  <span class="token punctuation">=</span> <span class="token string">"Dashboard Note"</span>
      <span class="token property">row</span>    <span class="token punctuation">=</span> <span class="token number">1</span>
      <span class="token property">column</span> <span class="token punctuation">=</span> <span class="token number">1</span>
      <span class="token property">text</span> <span class="token punctuation">=</span> <span class="token string">"# A"</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">widget_markdown</span> <span class="token punctuation">{</span>
      <span class="token property">title</span>  <span class="token punctuation">=</span> <span class="token string">"Dashboard Note"</span>
      <span class="token property">row</span>    <span class="token punctuation">=</span> <span class="token number">1</span>
      <span class="token property">column</span> <span class="token punctuation">=</span> <span class="token number">5</span>
      <span class="token property">text</span> <span class="token punctuation">=</span> <span class="token string">"# B"</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">widget_markdown</span> <span class="token punctuation">{</span>
      <span class="token property">title</span>  <span class="token punctuation">=</span> <span class="token string">"Dashboard Note"</span>
      <span class="token property">row</span>    <span class="token punctuation">=</span> <span class="token number">1</span>
      <span class="token property">column</span> <span class="token punctuation">=</span> <span class="token number">9</span>
      <span class="token property">text</span> <span class="token punctuation">=</span> <span class="token string">"# C"</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">widget_markdown</span> <span class="token punctuation">{</span>
      <span class="token property">title</span>  <span class="token punctuation">=</span> <span class="token string">"Dashboard Note"</span>
      <span class="token property">row</span>    <span class="token punctuation">=</span> <span class="token number">5</span>
      <span class="token property">column</span> <span class="token punctuation">=</span> <span class="token number">1</span>
      <span class="token property">text</span> <span class="token punctuation">=</span> <span class="token string">"# D"</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">widget_markdown</span> <span class="token punctuation">{</span>
      <span class="token property">title</span>  <span class="token punctuation">=</span> <span class="token string">"Dashboard Note"</span>
      <span class="token property">row</span>    <span class="token punctuation">=</span> <span class="token number">5</span>
      <span class="token property">column</span> <span class="token punctuation">=</span> <span class="token number">5</span>
      <span class="token property">text</span> <span class="token punctuation">=</span> <span class="token string">"# E"</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">widget_markdown</span> <span class="token punctuation">{</span>
      <span class="token property">title</span>  <span class="token punctuation">=</span> <span class="token string">"Dashboard Note"</span>
      <span class="token property">row</span>    <span class="token punctuation">=</span> <span class="token number">5</span>
      <span class="token property">column</span> <span class="token punctuation">=</span> <span class="token number">6</span>
      <span class="token property">text</span> <span class="token punctuation">=</span> <span class="token string">"# F"</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p>Pass in the newrelic account/api-key which running the terraform script</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ <span class="token assign-left variable">NR_ACCOUNT_NUMBER</span><span class="token operator">=</span><span class="token string">"****"</span>
$ <span class="token assign-left variable">NR_API_KEY</span><span class="token operator">=</span><span class="token string">"****"</span>

$ terraform plan <span class="token punctuation">\</span>
  -var<span class="token operator">=</span><span class="token string">"account_id=<span class="token variable">$NR_ACCOUNT_NUMBER</span>"</span> <span class="token punctuation">\</span>
  -var<span class="token operator">=</span><span class="token string">"api_key=<span class="token variable">$NR_API_KEY</span>"</span>

$ terraform apply -auto-approve <span class="token punctuation">\</span>
  -var<span class="token operator">=</span><span class="token string">"account_id=<span class="token variable">$NR_ACCOUNT_NUMBER</span>"</span> <span class="token punctuation">\</span>
  -var<span class="token operator">=</span><span class="token string">"api_key=<span class="token variable">$NR_API_KEY</span>"</span>
</code></pre></div>
</li>
</ul>
</details>
<details>
<summary>API Gateway</summary>
<ol>
<li>Create a lambda function, <code>src/index.js</code></li>
</ol>
<div class="remark-highlight"><pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">handler</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Event: '</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> responseMessage <span class="token operator">=</span> <span class="token string">'Hello, World!'</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">statusCode</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> responseMessage<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<ol start="2">
<li>Create a <code>.gitignore</code></li>
</ol>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token comment"># Local .terraform directories</span>
**/.terraform/*

<span class="token comment"># .tfstate files</span>
*.tfstate
*.tfstate.*

<span class="token comment"># Crash log files</span>
crash.log

<span class="token comment"># Exclude all .tfvars files, which are likely to contain sentitive data, such as</span>
<span class="token comment"># password, private keys, and other secrets. These should not be part of version </span>
<span class="token comment"># control as they are data points which are potentially sensitive and subject </span>
<span class="token comment"># to change depending on the environment.</span>
<span class="token comment">#</span>
*.tfvars

<span class="token comment"># Ignore override files as they are usually used to override resources locally and so</span>
<span class="token comment"># are not checked in</span>
override.tf
override.tf.json
*_override.tf
*_override.tf.json

<span class="token comment"># Include override files you do wish to add to version control using negated pattern</span>
<span class="token comment">#</span>
<span class="token comment"># !example_override.tf</span>

<span class="token comment"># Include tfplan files to ignore the plan output of command: terraform plan -out=tfplan</span>
<span class="token comment"># example: *tfplan*</span>

<span class="token comment"># Ignore CLI configuration files</span>
.terraformrc
terraform.rc
hello-world.zip
response.json

<span class="token comment"># node packages</span>
node_modules
</code></pre></div>
<ol start="3">
<li>Script for running the lambda file locally</li>
</ol>
<ul>
<li>Create an <code>test/event.json</code> file to pass into your lambda
<div class="remark-highlight"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"/API/PATH"</span><span class="token punctuation">,</span>
  <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/API/PATH"</span><span class="token punctuation">,</span>
  <span class="token property">"httpMethod"</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
  <span class="token property">"headers"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"multiValueHeaders"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"queryStringParameters"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"multiValueQueryStringParameters"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"pathParameters"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"stageVariables"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"requestContext"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"resourceId"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">,</span>
    <span class="token property">"resourcePath"</span><span class="token operator">:</span> <span class="token string">"/api/endpoint"</span><span class="token punctuation">,</span>
    <span class="token property">"httpMethod"</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/env/api/endpoint"</span><span class="token punctuation">,</span>
    <span class="token property">"protocol"</span><span class="token operator">:</span> <span class="token string">"HTTP/1.1"</span><span class="token punctuation">,</span>
    <span class="token property">"stage"</span><span class="token operator">:</span> <span class="token string">"env"</span><span class="token punctuation">,</span>
    <span class="token property">"domainName"</span><span class="token operator">:</span> <span class="token string">"url.us-east-1.amazonaws.com"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"body"</span><span class="token operator">:</span> <span class="token string">"{\n    \"city\": \"Test 1 City\",\n    \"state\": \"NY\",\n    \"zipCode\": \"11549\"\n}"</span><span class="token punctuation">,</span>
  <span class="token property">"isBase64Encoded"</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>Add a script to run the lambda file locally
<div class="remark-highlight"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"lambda:envoke:local"</span><span class="token operator">:</span> <span class="token string">"node -e \"console.log(require('./src/index.js').handler(require('./test/event.json')));\""</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<ol start="4">
<li>Let's add some terraform files</li>
</ol>
<ul>
<li>Create  <code>./terraform/main.tf</code> and let's add the AWS providers, define the remote config file key
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token keyword">backend<span class="token type variable"> "s3" </span></span><span class="token punctuation">{</span>
    <span class="token property">key</span>    <span class="token punctuation">=</span> <span class="token string">"api-gateway-example"</span>
    <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">"us-west-2"</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">required_providers</span> <span class="token punctuation">{</span>
    <span class="token property">aws</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">"hashicorp/aws"</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">"~> 4.0.0"</span>
    <span class="token punctuation">}</span>
    <span class="token property">archive</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">"hashicorp/archive"</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">"~> 2.2.0"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token property">required_version</span> <span class="token punctuation">=</span> <span class="token string">"~> 1.0"</span>
<span class="token punctuation">}</span>

<span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span> <span class="token punctuation">=</span> var.aws_region
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>Create <code>./terraform/variables.tf</code>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">variable<span class="token type variable"> "aws_region" </span></span><span class="token punctuation">{</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">"AWS region for all resources."</span>

  <span class="token property">type</span>    <span class="token punctuation">=</span> string
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"us-west-2"</span>
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> "project_name" </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span> <span class="token punctuation">=</span> string
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">"Project name to be used throughout the application"</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"example-tf-api-gateway"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<ol start="5">
<li>Manually create an S3 bucket for your terraform state files and call it <code>terraform-remote-config-&#x3C;AWS_ACCOUNT_NUMBER></code></li>
<li>Let's run this</li>
</ol>
<ul>
<li><strong>NOTE</strong> you want to make you have your AWS-CLI credential configured (<a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-quickstart.html">more here</a>) so that Terraform can push to the right account.</li>
<li>Create a <code>./deploy.sh</code> file
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token builtin class-name">set</span> -e

<span class="token comment"># Environments</span>
<span class="token keyword">case</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token keyword">in</span>
  dev<span class="token punctuation">)</span> 
    <span class="token assign-left variable">WORKSPACE</span><span class="token operator">=</span><span class="token string">"dev"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  prod<span class="token punctuation">)</span> 
    <span class="token assign-left variable">WORKSPACE</span><span class="token operator">=</span><span class="token string">"prod"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  *<span class="token punctuation">)</span>
    <span class="token builtin class-name">echo</span> $<span class="token string">"Usage: <span class="token variable">$0</span> {dev|prod}"</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">esac</span>
<span class="token builtin class-name">echo</span> <span class="token string">"Running tf-deploy on <span class="token variable">${WORKSPACE}</span>"</span>

<span class="token comment"># Terraform state, bucket name</span>
<span class="token assign-left variable">AWS_ACCOUNT_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>aws sts get-caller-identity <span class="token operator">|</span> jq -r <span class="token string">'.Account'</span><span class="token variable">)</span></span>
<span class="token assign-left variable">terraform_state_bucket</span><span class="token operator">=</span><span class="token string">"terraform-remote-config-<span class="token variable">$AWS_ACCOUNT_ID</span>"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"Using Terraform state bucket: <span class="token variable">$terraform_state_bucket</span>"</span>

<span class="token function">pushd</span> terraform

<span class="token comment"># Cleanup .terraform</span>
<span class="token function">rm</span> -rf .terraform/

<span class="token comment"># Deploy terraform</span>
terraform init -backend-config <span class="token assign-left variable">bucket</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${terraform_state_bucket}</span>"</span>

<span class="token comment"># If the workspace does not exist, create it.</span>
<span class="token keyword">if</span> <span class="token operator">!</span> terraform workspace <span class="token keyword">select</span> <span class="token variable">${WORKSPACE}</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  terraform workspace new <span class="token variable">${WORKSPACE}</span>
<span class="token keyword">fi</span>
terraform apply -auto-approve
<span class="token function">popd</span>

<span class="token builtin class-name">echo</span> <span class="token string">"DONE!"</span>
</code></pre></div>
</li>
<li>Run the script
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token comment"># Allow the deploy script to be run </span>
$ <span class="token function">chmod</span> +x deploy.sh

$ ./deploy.sh
</code></pre></div>
</li>
<li>Now if you go to AWS console and look in your <code>terraform-remote-config-&#x3C;AWS_ACCOUNT_NUMBER></code> bucket yo should have <code>./env:/dev/api-gateway-example</code> file</li>
<li>Sweet now we have terraform setup that will update the state file in AWS so others can work on this project instead of the state file only being on your machine,</li>
</ul>
<ol start="7">
<li>Create and upload Lambda function archive to S3</li>
</ol>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"aws_s3_bucket"</span></span> <span class="token string">"rest_api_source"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> var.project_name

  <span class="token property">tags</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">Name</span>        <span class="token punctuation">=</span> <span class="token string">"My bucket for API Gateway source code"</span>
    <span class="token property">Environment</span> <span class="token punctuation">=</span> <span class="token string">"Dev"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_s3_bucket_acl"</span></span> <span class="token string">"example"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> aws_s3_bucket.rest_api_source.id
  <span class="token property">acl</span>    <span class="token punctuation">=</span> <span class="token string">"private"</span>
<span class="token punctuation">}</span>

<span class="token keyword">data <span class="token type variable">"archive_file"</span></span> <span class="token string">"rest_api_source"</span> <span class="token punctuation">{</span>
  <span class="token property">type</span> <span class="token punctuation">=</span> <span class="token string">"zip"</span>

  <span class="token property">source_dir</span>  <span class="token punctuation">=</span> <span class="token string">"../rest-api/<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">path</span><span class="token punctuation">.</span><span class="token type variable">module</span><span class="token punctuation">}</span></span>/src"</span>
  <span class="token property">output_path</span> <span class="token punctuation">=</span> <span class="token string">"../rest-api/<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">path</span><span class="token punctuation">.</span><span class="token type variable">module</span><span class="token punctuation">}</span></span>/dist/rest-api-source.zip"</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_s3_object"</span></span> <span class="token string">"rest_api_source"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> aws_s3_bucket.rest_api_source.id

  <span class="token property">key</span>    <span class="token punctuation">=</span> <span class="token string">"rest-api-source.zip"</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> data.archive_file.rest_api_source.output_path

  <span class="token property">etag</span> <span class="token punctuation">=</span> filemd5(data.archive_file.rest_api_source.output_path)
<span class="token punctuation">}</span>
</code></pre></div>
<ol start="8">
<li>Create the lambda function from the S3 zipped file</li>
</ol>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"aws_lambda_function"</span></span> <span class="token string">"rest_api"</span> <span class="token punctuation">{</span>
  <span class="token property">function_name</span> <span class="token punctuation">=</span> var.project_name

  <span class="token property">s3_bucket</span> <span class="token punctuation">=</span> aws_s3_bucket.rest_api_source.id
  <span class="token property">s3_key</span>    <span class="token punctuation">=</span> aws_s3_object.rest_api_source.key

  <span class="token property">runtime</span> <span class="token punctuation">=</span> <span class="token string">"nodejs12.x"</span>
  <span class="token property">handler</span> <span class="token punctuation">=</span> <span class="token string">"index.handler"</span>

  <span class="token property">source_code_hash</span> <span class="token punctuation">=</span> data.archive_file.rest_api_source.output_base64sha256

  <span class="token property">role</span> <span class="token punctuation">=</span> aws_iam_role.lambda_exec.arn
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_cloudwatch_log_group"</span></span> <span class="token string">"rest_api"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">"/aws/lambda/<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_lambda_function<span class="token punctuation">.</span>rest_api<span class="token punctuation">.</span>function_name<span class="token punctuation">}</span></span>"</span>

  <span class="token property">retention_in_days</span> <span class="token punctuation">=</span> <span class="token number">30</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_iam_role"</span></span> <span class="token string">"lambda_exec"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">"serverless_lambda"</span>

  <span class="token property">assume_role_policy</span> <span class="token punctuation">=</span> jsonencode(<span class="token punctuation">{</span>
    <span class="token property">Version</span> <span class="token punctuation">=</span> <span class="token string">"2012-10-17"</span>
    <span class="token property">Statement</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token property">Action</span> <span class="token punctuation">=</span> <span class="token string">"sts:AssumeRole"</span>
      <span class="token property">Effect</span> <span class="token punctuation">=</span> <span class="token string">"Allow"</span>
      <span class="token property">Sid</span>    <span class="token punctuation">=</span> <span class="token string">""</span>
      <span class="token property">Principal</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
        <span class="token property">Service</span> <span class="token punctuation">=</span> <span class="token string">"lambda.amazonaws.com"</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>)
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_iam_role_policy_attachment"</span></span> <span class="token string">"lambda_policy"</span> <span class="token punctuation">{</span>
  <span class="token property">role</span>       <span class="token punctuation">=</span> aws_iam_role.lambda_exec.name
  <span class="token property">policy_arn</span> <span class="token punctuation">=</span> <span class="token string">"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"</span>
<span class="token punctuation">}</span>
</code></pre></div>
<ul>
<li>Custom Authorizer needs to return IAM Policy, <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-lambda-authorizer-output.html">learn more here</a>, for example:
<div class="remark-highlight"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"principalId"</span><span class="token operator">:</span> <span class="token string">"yyyyyyyy"</span><span class="token punctuation">,</span> <span class="token comment">// The principal user identification associated with the token sent by the client.</span>
  <span class="token property">"policyDocument"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"execute-api:Invoke"</span><span class="token punctuation">,</span>
        <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow|Deny"</span><span class="token punctuation">,</span>
        <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:execute-api:{regionId}:{accountId}:{apiId}/{stage}/{httpVerb}/[{resource}/[{child-resources}]]"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"context"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"stringKey"</span><span class="token operator">:</span> <span class="token string">"value"</span><span class="token punctuation">,</span>
    <span class="token property">"numberKey"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
    <span class="token property">"booleanKey"</span><span class="token operator">:</span> <span class="token string">"true"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"usageIdentifierKey"</span><span class="token operator">:</span> <span class="token string">"{api-key}"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>The <code>context</code> object is optional</li>
<li><a href="https://awspolicygen.s3.amazonaws.com/policygen.html">Policy Generator</a></li>
</ul>
</details>
<h1>Terraform (Infrastructure as Code) to build out your services</h1>
<ul>
<li>Why?
<ul>
<li>To document all the services that are being used</li>
<li>Repeatable &#x26; reusable solution</li>
<li>Tare down all the services created with Terraform because TF creates an inventory of all the services in a state file</li>
</ul>
</li>
</ul>
<h1>Terraform for a client-side static web application</h1>
<h2>The variable file</h2>
<ul>
<li>This file is the only <code>.tf</code> file where you need to update values the rest of the <code>.tf</code> files are totally project agnostic
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./varables.tf)</span>
<span class="token comment">#-------------------------------------------</span>
<span class="token comment"># Required variables (values passed in via command)</span>
<span class="token comment">#-------------------------------------------</span>
<span class="token keyword">variable<span class="token type variable"> domain_name </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">variable<span class="token type variable"> hosted_zone_name </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">variable<span class="token type variable"> env_tags </span></span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">#-------------------------------------------</span>
<span class="token comment"># TF version &#x26; State file config</span>
<span class="token comment">#-------------------------------------------</span>
<span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token keyword">backend<span class="token type variable"> "s3" </span></span><span class="token punctuation">{</span>
    <span class="token property">key</span>    <span class="token punctuation">=</span> <span class="token string">"&#x3C;YOUR_PROJECT_NAME_HERE>"</span> <span class="token comment"># this will define the TF state file</span>
    <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">"us-west-2"</span>
  <span class="token punctuation">}</span>
  <span class="token property">required_version</span> <span class="token punctuation">=</span> <span class="token string">">= 0.13.5"</span>
  <span class="token keyword">required_providers</span> <span class="token punctuation">{</span>
    <span class="token property">aws</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">"hashicorp/aws"</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">"~>3.4"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">#-------------------------------------------</span>
<span class="token comment"># Default region</span>
<span class="token comment">#-------------------------------------------</span>
<span class="token keyword">variable<span class="token type variable"> "region" </span></span><span class="token punctuation">{</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"us-west-2"</span>
<span class="token punctuation">}</span>
<span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span> <span class="token punctuation">=</span> var.region
<span class="token punctuation">}</span>

<span class="token comment">#-------------------------------------------</span>
<span class="token comment"># Interpolated Values</span>
<span class="token comment">#-------------------------------------------</span>
<span class="token keyword">locals</span> <span class="token punctuation">{</span>
  <span class="token property">bucket_name</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">domain_name</span><span class="token punctuation">}</span></span>"</span>
  <span class="token property">domain_name</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">domain_name</span><span class="token punctuation">}</span></span>"</span>
<span class="token punctuation">}</span>

<span class="token comment">#-------------------------------------------</span>
<span class="token comment"># Data</span>
<span class="token comment">#-------------------------------------------</span>
<span class="token keyword">data <span class="token type variable">"aws_caller_identity"</span></span> <span class="token string">"current"</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<h2>S3</h2>
<ul>
<li>Use S3 to store the static web files and a second bucket for logging
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./s3.tf)</span>
<span class="token keyword">resource <span class="token type variable">"aws_s3_bucket"</span></span> <span class="token string">"site"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> local.bucket_name
  <span class="token property">acl</span>    <span class="token punctuation">=</span> <span class="token string">"private"</span>
  <span class="token property">policy</span> <span class="token punctuation">=</span> data.aws_iam_policy_document.website_s3_policy.json

  <span class="token keyword">website</span> <span class="token punctuation">{</span>
    <span class="token property">index_document</span> <span class="token punctuation">=</span> <span class="token string">"index.html"</span>
    <span class="token property">error_document</span> <span class="token punctuation">=</span> <span class="token string">"404.html"</span>
  <span class="token punctuation">}</span>

  <span class="token property">tags</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">Environment</span> <span class="token punctuation">=</span> var.env_tags
    <span class="token property">Created_with</span> <span class="token punctuation">=</span> <span class="token string">"Terraform"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_s3_bucket"</span></span> <span class="token string">"log_bucket"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">local</span><span class="token punctuation">.</span><span class="token type variable">bucket_name</span><span class="token punctuation">}</span></span>-logs"</span>
  <span class="token property">acl</span>    <span class="token punctuation">=</span> <span class="token string">"log-delivery-write"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<h2>Policies</h2>
<ul>
<li>This policie only allows access via CloudFront to serve the webcontent
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./policies.tf)</span>
<span class="token keyword">data <span class="token type variable">"aws_iam_policy_document"</span></span> <span class="token string">"website_s3_policy"</span> <span class="token punctuation">{</span>
  <span class="token keyword">statement</span> <span class="token punctuation">{</span>
    <span class="token property">actions</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">]</span>
    <span class="token property">resources</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"arn:aws:s3:::<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">local</span><span class="token punctuation">.</span><span class="token type variable">bucket_name</span><span class="token punctuation">}</span></span>/*"</span><span class="token punctuation">]</span>

    <span class="token keyword">principals</span> <span class="token punctuation">{</span>
      <span class="token property">type</span>        <span class="token punctuation">=</span> <span class="token string">"AWS"</span>
      <span class="token property">identifiers</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_cloudfront_origin_access_identity<span class="token punctuation">.</span>website_origin_access_identity<span class="token punctuation">.</span>iam_arn<span class="token punctuation">}</span></span>"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<h2>Route53</h2>
<ul>
<li>Make sure that you purchase your domain name beforehand because we will need the Hosted Zone Id</li>
<li>We will use TF to create an <code>A</code> record to connect to the CloudFront instance
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./route53.tf)</span>
<span class="token keyword">resource <span class="token type variable">"aws_route53_record"</span></span> <span class="token string">"domain"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>    <span class="token punctuation">=</span> local.domain_name
  <span class="token property">zone_id</span> <span class="token punctuation">=</span> data.aws_route53_zone.base.zone_id
  <span class="token property">type</span>    <span class="token punctuation">=</span> <span class="token string">"A"</span>
  <span class="token keyword">alias</span> <span class="token punctuation">{</span>
    <span class="token property">name</span>                   <span class="token punctuation">=</span> aws_cloudfront_distribution.website_cdn.domain_name
    <span class="token property">zone_id</span>                <span class="token punctuation">=</span> aws_cloudfront_distribution.website_cdn.hosted_zone_id
    <span class="token property">evaluate_target_health</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">data <span class="token type variable">"aws_route53_zone"</span></span> <span class="token string">"base"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>         <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">hosted_zone_name</span><span class="token punctuation">}</span></span>."</span>
  <span class="token property">private_zone</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<h2>ACM for certs</h2>
<ul>
<li>ACM provides an elegant wayt to convert  a cumbersome multi-step process into a single step, however when combined with Terraform this process is a little more complex because some processes have to happen in senquential steps</li>
<li>Some of the TF modules include:
<ul>
<li><code>aws_acm_certificate</code>: To request a certificate for example.com</li>
<li><code>aws_route53_record</code>: To create a DNS record to validate the certificate request</li>
<li><code>aws_certificate_validation</code>: To ensure that ACM validates our DNS record before certificate use</li>
</ul>
</li>
<li>In an effort to reduce the timming steps, <a href="https://www.azavea.com/">azavea's team</a> assembled a reusable <a href="https://github.com/azavea/terraform-aws-acm-certificate">Terraform module</a> to encapsulate the ACM and Route 53 resources used. Using the output from the validation resource ensures that Terraform will wait for ACM to validate the certificate before resolving its ARN. Now, the process of creating, validating, and waiting for a valid certificate looks like this:
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./certs.tf)</span>
<span class="token keyword">data <span class="token type variable">"aws_route53_zone"</span></span> <span class="token string">"base"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>         <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">hosted_zone_name</span><span class="token punctuation">}</span></span>."</span>
  <span class="token property">private_zone</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">"us-east-1"</span>
  <span class="token property">alias</span>  <span class="token punctuation">=</span> <span class="token string">"certificates"</span>
<span class="token punctuation">}</span>

<span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span> <span class="token punctuation">=</span> var.region
  <span class="token property">alias</span>  <span class="token punctuation">=</span> <span class="token string">"dns"</span>
<span class="token punctuation">}</span>

<span class="token keyword">module<span class="token type variable"> "cert" </span></span><span class="token punctuation">{</span>
  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"github.com/azavea/terraform-aws-acm-certificate?ref=3.0.0"</span>

  <span class="token property">providers</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">aws.acm_account</span>     <span class="token punctuation">=</span> aws.certificates
    <span class="token property">aws.route53_account</span> <span class="token punctuation">=</span> aws.dns
  <span class="token punctuation">}</span>

  <span class="token property">domain_name</span>                       <span class="token punctuation">=</span> local.domain_name
  <span class="token property">hosted_zone_id</span>                    <span class="token punctuation">=</span> data.aws_route53_zone.base.zone_id
  <span class="token property">validation_record_ttl</span>             <span class="token punctuation">=</span> <span class="token string">"60"</span>
  <span class="token property">allow_validation_record_overwrite</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_route53_record"</span></span> <span class="token string">"domain"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>    <span class="token punctuation">=</span> local.domain_name
  <span class="token property">zone_id</span> <span class="token punctuation">=</span> data.aws_route53_zone.base.zone_id
  <span class="token property">type</span>    <span class="token punctuation">=</span> <span class="token string">"A"</span>
  <span class="token keyword">alias</span> <span class="token punctuation">{</span>
    <span class="token property">name</span>                   <span class="token punctuation">=</span> aws_cloudfront_distribution.website_cdn.domain_name
    <span class="token property">zone_id</span>                <span class="token punctuation">=</span> aws_cloudfront_distribution.website_cdn.hosted_zone_id
    <span class="token property">evaluate_target_health</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<h1>CloudFront</h1>
<ul>
<li>CloudFront allows for global distribution of our web content with the ability to cache content at AWS edge locations</li>
<li>The CloudFront configuration is kind of a beast
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./cloudfront.tf)</span>
<span class="token keyword">resource <span class="token type variable">"aws_cloudfront_origin_access_identity"</span></span> <span class="token string">"website_origin_access_identity"</span> <span class="token punctuation">{</span>
  <span class="token property">comment</span> <span class="token punctuation">=</span> <span class="token string">"site <span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">terraform</span><span class="token punctuation">.</span><span class="token type variable">workspace</span><span class="token punctuation">}</span></span> Access Identity"</span>
<span class="token punctuation">}</span>


<span class="token keyword">resource <span class="token type variable">"aws_cloudfront_distribution"</span></span> <span class="token string">"website_cdn"</span> <span class="token punctuation">{</span>
  <span class="token keyword">origin</span> <span class="token punctuation">{</span>
    <span class="token property">domain_name</span> <span class="token punctuation">=</span> aws_s3_bucket.site.bucket_regional_domain_name
    <span class="token property">origin_id</span>   <span class="token punctuation">=</span> <span class="token string">"origin-bucket-<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_s3_bucket<span class="token punctuation">.</span>site<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span>

    <span class="token keyword">s3_origin_config</span> <span class="token punctuation">{</span>
      <span class="token property">origin_access_identity</span> <span class="token punctuation">=</span> aws_cloudfront_origin_access_identity.website_origin_access_identity.cloudfront_access_identity_path
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token property">enabled</span>             <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">is_ipv6_enabled</span>     <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">default_root_object</span> <span class="token punctuation">=</span> <span class="token string">"index.html"</span>

  <span class="token keyword">logging_config</span> <span class="token punctuation">{</span>
    <span class="token property">include_cookies</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
    <span class="token property">bucket</span>          <span class="token punctuation">=</span> aws_s3_bucket.log_bucket.bucket_domain_name
    <span class="token property">prefix</span>          <span class="token punctuation">=</span> <span class="token string">"cloudfront_logs"</span>
  <span class="token punctuation">}</span>

  <span class="token property">aliases</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>local.domain_name<span class="token punctuation">]</span>

  <span class="token keyword">default_cache_behavior</span> <span class="token punctuation">{</span>
    <span class="token property">allowed_methods</span>  <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"DELETE"</span>, <span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span>, <span class="token string">"PATCH"</span>, <span class="token string">"POST"</span>, <span class="token string">"PUT"</span><span class="token punctuation">]</span>
    <span class="token property">cached_methods</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span><span class="token punctuation">]</span>
    <span class="token property">target_origin_id</span> <span class="token punctuation">=</span> <span class="token string">"origin-bucket-<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_s3_bucket<span class="token punctuation">.</span>site<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span>

    <span class="token keyword">forwarded_values</span> <span class="token punctuation">{</span>
      <span class="token property">query_string</span> <span class="token punctuation">=</span> <span class="token string">"true"</span>

      <span class="token keyword">cookies</span> <span class="token punctuation">{</span>
        <span class="token property">forward</span> <span class="token punctuation">=</span> <span class="token string">"none"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token property">viewer_protocol_policy</span> <span class="token punctuation">=</span> <span class="token string">"redirect-to-https"</span>
    <span class="token property">compress</span>               <span class="token punctuation">=</span> <span class="token boolean">true</span>
    <span class="token property">min_ttl</span>                <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">default_ttl</span>            <span class="token punctuation">=</span> <span class="token number">300</span>
    <span class="token property">max_ttl</span>                <span class="token punctuation">=</span> <span class="token number">1200</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># Cache behavior with precedence 0</span>
  <span class="token keyword">ordered_cache_behavior</span> <span class="token punctuation">{</span>
    <span class="token property">path_pattern</span>     <span class="token punctuation">=</span> <span class="token string">"/index.html"</span>
    <span class="token property">allowed_methods</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"DELETE"</span>, <span class="token string">"OPTIONS"</span>, <span class="token string">"PATCH"</span>, <span class="token string">"POST"</span>, <span class="token string">"PUT"</span><span class="token punctuation">]</span>
    <span class="token property">cached_methods</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span><span class="token punctuation">]</span>
    <span class="token property">target_origin_id</span> <span class="token punctuation">=</span> <span class="token string">"origin-bucket-<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_s3_bucket<span class="token punctuation">.</span>site<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span>

    <span class="token keyword">forwarded_values</span> <span class="token punctuation">{</span>
      <span class="token property">query_string</span> <span class="token punctuation">=</span> <span class="token string">"true"</span>

      <span class="token keyword">cookies</span> <span class="token punctuation">{</span>
        <span class="token property">forward</span> <span class="token punctuation">=</span> <span class="token string">"none"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token property">min_ttl</span>                <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">default_ttl</span>            <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">max_ttl</span>                <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">compress</span>               <span class="token punctuation">=</span> <span class="token boolean">true</span>
    <span class="token property">viewer_protocol_policy</span> <span class="token punctuation">=</span> <span class="token string">"redirect-to-https"</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">custom_error_response</span> <span class="token punctuation">{</span>
    <span class="token property">error_code</span> <span class="token punctuation">=</span> <span class="token string">"404"</span>
    <span class="token property">response_code</span>      <span class="token punctuation">=</span> <span class="token string">"200"</span>
    <span class="token property">response_page_path</span> <span class="token punctuation">=</span> <span class="token string">"/index.html"</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">custom_error_response</span> <span class="token punctuation">{</span>
    <span class="token property">error_code</span> <span class="token punctuation">=</span> <span class="token string">"403"</span>
    <span class="token property">response_code</span>      <span class="token punctuation">=</span> <span class="token string">"200"</span>
    <span class="token property">response_page_path</span> <span class="token punctuation">=</span> <span class="token string">"/index.html"</span>
  <span class="token punctuation">}</span>

  <span class="token property">price_class</span> <span class="token punctuation">=</span> <span class="token string">"PriceClass_100"</span> <span class="token comment"># https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PriceClass.html</span>

  <span class="token keyword">restrictions</span> <span class="token punctuation">{</span>
    <span class="token keyword">geo_restriction</span> <span class="token punctuation">{</span>
      <span class="token property">restriction_type</span> <span class="token punctuation">=</span> <span class="token string">"none"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">viewer_certificate</span> <span class="token punctuation">{</span>
    <span class="token property">acm_certificate_arn</span>      <span class="token punctuation">=</span> module.cert.arn
    <span class="token property">ssl_support_method</span>       <span class="token punctuation">=</span> <span class="token string">"sni-only"</span>
    <span class="token property">minimum_protocol_version</span> <span class="token punctuation">=</span> <span class="token string">"TLSv1"</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">lifecycle</span> <span class="token punctuation">{</span>
    <span class="token property">ignore_changes</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>tags<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token property">tags</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">Environment</span> <span class="token punctuation">=</span> var.env_tags
    <span class="token property">Created_with</span> <span class="token punctuation">=</span> <span class="token string">"Terraform"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<h2>Finally the <code>.tfvars</code> file</h2>
<ul>
<li>Creating a <code>.tfvar</code> file allows you to deploy this applications to multiple environments (dev|statging|prod)
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># (./env_configs/prod.tfvars)</span>
<span class="token property">domain_name</span>      <span class="token punctuation">=</span> <span class="token string">"myawesomesite.com"</span>
<span class="token property">hosted_zone_name</span> <span class="token punctuation">=</span> <span class="token string">"myawesomesite.com"</span>
<span class="token property">env_tags</span>          <span class="token punctuation">=</span> <span class="token string">"Production"</span>
</code></pre></div>
</li>
<li>Now running this
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token comment"># *NOTE* run these commands in the terraform folder</span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_PROFILE</span><span class="token operator">=</span><span class="token string">"&#x3C;YOUR_AWS_PROFILE_HERE>"</span>
<span class="token assign-left variable">CLIENT_BUCKET_NAME</span><span class="token operator">=</span><span class="token string">"&#x3C;YOUR_AWS_S3_BUCKET_NAME>"</span>
<span class="token assign-left variable">TERRAFORM_STATE_BUCKET_NAME</span><span class="token operator">=</span><span class="token string">"&#x3C;YOUR_TF_REMOTE_STATE_BUCKET_NAME>"</span>

<span class="token comment"># Environment variables</span>
<span class="token assign-left variable">WORKSPACE</span><span class="token operator">=</span><span class="token string">"prod"</span>
<span class="token assign-left variable">VAR_FILE</span><span class="token operator">=</span><span class="token string">"./env/prod.tfvars"</span>

<span class="token comment"># TF version</span>
<span class="token assign-left variable">tf_ver</span><span class="token operator">=</span><span class="token string">"v0.13.5"</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token variable"><span class="token variable">$(</span>Terraform --version<span class="token variable">)</span></span> <span class="token operator">=~</span> <span class="token string">"Terraform <span class="token variable">$tf_ver</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token builtin class-name">echo</span> <span class="token string">"Terraform <span class="token variable">$tf_ver</span> is required"</span><span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">fi</span>

<span class="token comment"># Cleanup .terraform</span>
<span class="token function">rm</span> -rf .terraform/

<span class="token comment"># Deploy terraform</span>
<span class="token builtin class-name">echo</span> <span class="token string">"[Running] terraform"</span>
terraform init -backend-config <span class="token assign-left variable">bucket</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${TERRAFORM_STATE_BUCKET_NAME}</span>"</span>

<span class="token comment"># If the workspace does not exist, create it.</span>
<span class="token keyword">if</span> <span class="token operator">!</span> terraform workspace <span class="token keyword">select</span> <span class="token variable">${WORKSPACE}</span><span class="token punctuation">;</span> <span class="token keyword">then</span> terraform workspace new <span class="token variable">${WORKSPACE}</span><span class="token punctuation">;</span> <span class="token keyword">fi</span>
terraform apply -auto-approve -var-file<span class="token operator">=</span><span class="token variable">$VAR_FILE</span>

<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span> <span class="token comment"># where the package.json file exist</span>

<span class="token comment"># Build the static files</span>
<span class="token builtin class-name">echo</span> <span class="token string">"[Build] production version of the website]"</span>
<span class="token function">yarn</span>
<span class="token function">yarn</span> run build

<span class="token comment"># Upload the source code to AWS S3</span>
<span class="token builtin class-name">echo</span> <span class="token string">"[Upload] website content"</span>
aws s3 <span class="token function">rm</span> s3://<span class="token variable">$CLIENT_BUCKET_NAME</span>/  --recursive
aws s3 <span class="token function">sync</span> dist/ s3://<span class="token variable">$CLIENT_BUCKET_NAME</span>/ --exclude <span class="token punctuation">\</span>"*.DS_Store*<span class="token punctuation">\</span>"
aws s3 <span class="token function">cp</span> dist/index.html s3://<span class="token variable">$CLIENT_BUCKET_NAME</span>/ --cache-control max-age<span class="token operator">=</span><span class="token number">0</span>
</code></pre></div>
</li>
</ul>
<h2>CloudFront add a secondary failover origin</h2>
<ul>
<li>Create a bucket and a CloudFront ditribution:
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl">variable <span class="token string">"primary_bucket_name"</span><span class="token punctuation">{</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"my-awesome-site"</span>
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> "s3_origin_id" </span></span><span class="token punctuation">{</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"myS3Origin"</span>
<span class="token punctuation">}</span>

<span class="token comment"># Primary Origin</span>
<span class="token keyword">data <span class="token type variable">"aws_iam_policy_document"</span></span> <span class="token string">"primary_origin_website_s3_policy"</span> <span class="token punctuation">{</span>
  <span class="token keyword">statement</span> <span class="token punctuation">{</span>
    <span class="token property">sid</span>       <span class="token punctuation">=</span> <span class="token string">"bucket_policy_for_primary"</span>
    <span class="token property">actions</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">]</span>
    <span class="token property">effect</span>    <span class="token punctuation">=</span> <span class="token string">"Allow"</span>
    <span class="token property">resources</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"arn:aws:s3:::<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">primary_bucket_name</span><span class="token punctuation">}</span></span>/*"</span><span class="token punctuation">]</span>

    <span class="token keyword">principals</span> <span class="token punctuation">{</span>
      <span class="token property">type</span>        <span class="token punctuation">=</span> <span class="token string">"AWS"</span>
      <span class="token property">identifiers</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>aws_cloudfront_origin_access_identity.website_origin_access_identity.iam_arn<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">resource <span class="token type variable">"aws_s3_bucket"</span></span> <span class="token string">"primary_origin"</span> <span class="token punctuation">{</span>
  <span class="token property">bucket</span> <span class="token punctuation">=</span> var.primary_bucket_name
  <span class="token property">acl</span>    <span class="token punctuation">=</span> <span class="token string">"private"</span>
  <span class="token property">policy</span> <span class="token punctuation">=</span> data.aws_iam_policy_document.primary_origin_website_s3_policy.json

  <span class="token keyword">website</span> <span class="token punctuation">{</span>
    <span class="token property">index_document</span> <span class="token punctuation">=</span> <span class="token string">"index.html"</span>
    <span class="token property">error_document</span> <span class="token punctuation">=</span> <span class="token string">"404.html"</span>
  <span class="token punctuation">}</span>

  <span class="token property">tags</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token property">force_destroy</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>



<span class="token comment"># CloudFront (With single origin)</span>
<span class="token keyword">resource <span class="token type variable">"aws_cloudfront_origin_access_identity"</span></span> <span class="token string">"website_origin_access_identity"</span> <span class="token punctuation">{</span>
  <span class="token property">comment</span> <span class="token punctuation">=</span> <span class="token string">"site <span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">terraform</span><span class="token punctuation">.</span><span class="token type variable">workspace</span><span class="token punctuation">}</span></span> Access Identity"</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_cloudfront_distribution"</span></span> <span class="token string">"s3_distribution"</span> <span class="token punctuation">{</span>
  <span class="token keyword">origin</span> <span class="token punctuation">{</span>
    <span class="token property">domain_name</span> <span class="token punctuation">=</span> aws_s3_bucket.primary_origin.bucket_regional_domain_name
    <span class="token property">origin_id</span>   <span class="token punctuation">=</span> var.s3_origin_id

    <span class="token keyword">s3_origin_config</span> <span class="token punctuation">{</span>
      <span class="token property">origin_access_identity</span> <span class="token punctuation">=</span> aws_cloudfront_origin_access_identity.website_origin_access_identity.cloudfront_access_identity_path
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token property">enabled</span>             <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">is_ipv6_enabled</span>     <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">comment</span>             <span class="token punctuation">=</span> <span class="token string">"Some comment"</span>
  <span class="token property">default_root_object</span> <span class="token punctuation">=</span> <span class="token string">"index.html"</span>

  <span class="token keyword">logging_config</span> <span class="token punctuation">{</span>
    <span class="token property">include_cookies</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
    <span class="token property">bucket</span>          <span class="token punctuation">=</span> <span class="token string">"mylogs.s3.amazonaws.com"</span>
    <span class="token property">prefix</span>          <span class="token punctuation">=</span> <span class="token string">"myprefix"</span>
  <span class="token punctuation">}</span>

  <span class="token property">aliases</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"mysite.example.com"</span>, <span class="token string">"yoursite.example.com"</span><span class="token punctuation">]</span>

  <span class="token keyword">default_cache_behavior</span> <span class="token punctuation">{</span>
    <span class="token property">allowed_methods</span>  <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"DELETE"</span>, <span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span>, <span class="token string">"PATCH"</span>, <span class="token string">"POST"</span>, <span class="token string">"PUT"</span><span class="token punctuation">]</span>
    <span class="token property">cached_methods</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span><span class="token punctuation">]</span>
    <span class="token property">target_origin_id</span> <span class="token punctuation">=</span> var.s3_origin_id

    <span class="token keyword">forwarded_values</span> <span class="token punctuation">{</span>
      <span class="token property">query_string</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>

      <span class="token keyword">cookies</span> <span class="token punctuation">{</span>
        <span class="token property">forward</span> <span class="token punctuation">=</span> <span class="token string">"none"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token property">viewer_protocol_policy</span> <span class="token punctuation">=</span> <span class="token string">"allow-all"</span>
    <span class="token property">min_ttl</span>                <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">default_ttl</span>            <span class="token punctuation">=</span> <span class="token number">3600</span>
    <span class="token property">max_ttl</span>                <span class="token punctuation">=</span> <span class="token number">86400</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># Cache behavior with precedence 0</span>
  <span class="token keyword">ordered_cache_behavior</span> <span class="token punctuation">{</span>
    <span class="token property">path_pattern</span> <span class="token punctuation">=</span> <span class="token string">"/index.html"</span>
    <span class="token property">allowed_methods</span>  <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span><span class="token punctuation">]</span>
    <span class="token property">cached_methods</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span><span class="token punctuation">]</span>
    <span class="token property">target_origin_id</span> <span class="token punctuation">=</span> var.s3_origin_id

    <span class="token keyword">forwarded_values</span> <span class="token punctuation">{</span>
      <span class="token property">query_string</span> <span class="token punctuation">=</span> <span class="token string">"true"</span>
      <span class="token keyword">cookies</span> <span class="token punctuation">{</span>
        <span class="token property">forward</span> <span class="token punctuation">=</span> <span class="token string">"none"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token property">min_ttl</span>                <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">default_ttl</span>            <span class="token punctuation">=</span> <span class="token number">86400</span>
    <span class="token property">max_ttl</span>                <span class="token punctuation">=</span> <span class="token number">31536000</span>
    <span class="token property">compress</span>               <span class="token punctuation">=</span> <span class="token boolean">true</span>
    <span class="token property">viewer_protocol_policy</span> <span class="token punctuation">=</span> <span class="token string">"redirect-to-https"</span>
  <span class="token punctuation">}</span>

  <span class="token property">price_class</span> <span class="token punctuation">=</span> <span class="token string">"PriceClass_200"</span>

  <span class="token keyword">restrictions</span> <span class="token punctuation">{</span>
    <span class="token keyword">geo_restriction</span> <span class="token punctuation">{</span>
      <span class="token property">restriction_type</span> <span class="token punctuation">=</span> <span class="token string">"none"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token property">tags</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">Environment</span> <span class="token punctuation">=</span> <span class="token string">"production"</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">viewer_certificate</span> <span class="token punctuation">{</span>
    <span class="token property">cloudfront_default_certificate</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>Now add a second bucket in another region and update your CloudFront config block to allow for secondary origin
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># Add a bucket in another region</span>
<span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span> <span class="token punctuation">=</span> <span class="token string">"eu-west-1"</span>
  <span class="token property">alias</span>  <span class="token punctuation">=</span> <span class="token string">"failover_region"</span>
<span class="token punctuation">}</span>

variable <span class="token string">"secondary_bucket_name"</span><span class="token punctuation">{</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"my-awesome-site-failover"</span>
<span class="token punctuation">}</span>

<span class="token comment"># Secondary Bucket</span>
<span class="token keyword">data <span class="token type variable">"aws_iam_policy_document"</span></span> <span class="token string">"secondary_origin_website_s3_policy"</span> <span class="token punctuation">{</span>
  <span class="token property">provider</span> <span class="token punctuation">=</span> aws.failover_region

  <span class="token keyword">statement</span> <span class="token punctuation">{</span>
    <span class="token property">sid</span>       <span class="token punctuation">=</span> <span class="token string">"bucket_policy_for_secondary"</span>
    <span class="token property">actions</span>   <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">]</span>
    <span class="token property">effect</span>    <span class="token punctuation">=</span> <span class="token string">"Allow"</span>
    <span class="token property">resources</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"arn:aws:s3:::<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">secondary_bucket_name</span><span class="token punctuation">}</span></span>/*"</span><span class="token punctuation">]</span>

    <span class="token keyword">principals</span> <span class="token punctuation">{</span>
      <span class="token property">type</span>        <span class="token punctuation">=</span> <span class="token string">"AWS"</span>
      <span class="token property">identifiers</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>aws_cloudfront_origin_access_identity.website_origin_access_identity.iam_arn<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">resource <span class="token type variable">"aws_s3_bucket"</span></span> <span class="token string">"secondary_origin"</span> <span class="token punctuation">{</span>
  <span class="token property">provider</span> <span class="token punctuation">=</span> aws.failover_region

  <span class="token property">bucket</span> <span class="token punctuation">=</span> var.secondary_bucket_name
  <span class="token property">acl</span>    <span class="token punctuation">=</span> <span class="token string">"private"</span>
  <span class="token property">policy</span> <span class="token punctuation">=</span> data.aws_iam_policy_document.secondary_origin_website_s3_policy.json

  <span class="token keyword">website</span> <span class="token punctuation">{</span>
    <span class="token property">index_document</span> <span class="token punctuation">=</span> <span class="token string">"index.html"</span>
    <span class="token property">error_document</span> <span class="token punctuation">=</span> <span class="token string">"404.html"</span>
  <span class="token punctuation">}</span>

  <span class="token property">tags</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token property">force_destroy</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>


<span class="token comment"># Update your cloudfront distribution</span>
<span class="token keyword">resource <span class="token type variable">"aws_cloudfront_distribution"</span></span> <span class="token string">"s3_distribution"</span> <span class="token punctuation">{</span>
  <span class="token comment"># Add an `origin group`</span>
  <span class="token keyword">origin_group</span> <span class="token punctuation">{</span>
    <span class="token property">origin_id</span> <span class="token punctuation">=</span> <span class="token string">"OriginWithFailover"</span>

    <span class="token keyword">failover_criteria</span> <span class="token punctuation">{</span>
      <span class="token property">status_codes</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token number">403</span>, <span class="token number">404</span>, <span class="token number">500</span>, <span class="token number">502</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># *NOTE: this order matters! (first one will be the primary)</span>
    <span class="token keyword">member</span> <span class="token punctuation">{</span>
      <span class="token property">origin_id</span> <span class="token punctuation">=</span> <span class="token string">"primaryS3"</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">member</span> <span class="token punctuation">{</span>
      <span class="token property">origin_id</span> <span class="token punctuation">=</span> <span class="token string">"failoverS3"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># Add a second origin</span>
  <span class="token keyword">origin</span> <span class="token punctuation">{</span>
    <span class="token property">domain_name</span> <span class="token punctuation">=</span> aws_s3_bucket.secondary_origin.bucket_regional_domain_name
    <span class="token property">origin_id</span>   <span class="token punctuation">=</span> <span class="token string">"failoverS3"</span>

    <span class="token keyword">s3_origin_config</span> <span class="token punctuation">{</span>
      <span class="token property">origin_access_identity</span> <span class="token punctuation">=</span> aws_cloudfront_origin_access_identity.website_origin_access_identity.cloudfront_access_identity_path
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">default_cache_behavior</span> <span class="token punctuation">{</span>
    <span class="token property">target_origin_id</span> <span class="token punctuation">=</span> <span class="token string">"OriginWithFailover"</span>

    <span class="token property">allowed_methods</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span><span class="token punctuation">]</span>
    <span class="token property">cached_methods</span>  <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span><span class="token punctuation">]</span>
    <span class="token comment"># *...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">ordered_cache_behavior</span> <span class="token punctuation">{</span>
    <span class="token property">target_origin_id</span> <span class="token punctuation">=</span> <span class="token string">"OriginWithFailover"</span>

    <span class="token property">allowed_methods</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span>, <span class="token string">"OPTIONS"</span><span class="token punctuation">]</span> <span class="token comment"># Note </span>
    <span class="token property">cached_methods</span>  <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"GET"</span>, <span class="token string">"HEAD"</span><span class="token punctuation">]</span>
    <span class="token comment"># *...</span>
  <span class="token punctuation">}</span>

  <span class="token comment"># *...</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>Now you can test it by uploading this below HTML to the bucket in the <code>eu-west-1</code> and leave the <code>us-west-2</code> empty for now
<div class="remark-highlight"><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>title</span><span class="token punctuation">></span></span>eu-west-1<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h1</span><span class="token punctuation">></span></span>eu-west-1<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
</code></pre></div>
</li>
<li>If you go to the CloudFront URL, you should see a site that says <code>eu-west-1</code></li>
<li>Now Add the below html to the <code>us-west-2</code> bucket:
<div class="remark-highlight"><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>title</span><span class="token punctuation">></span></span>us-west-2<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h1</span><span class="token punctuation">></span></span>us-west-2<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
</code></pre></div>
</li>
<li>If you refresh your browser you should now see <code>us-west-2</code></li>
</ul>
</div></div></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5"><div class="py-28 flex flex-col lg:flex-row items-center"><div class="flex flex-col lg:flex-row justify-center items-center lg:pl-4 lg:w-1/2"><a href="/">Learn something else</a></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"terraform","slug":"terraform","content":"\u003cdetails\u003e\n\u003csummary\u003eWhat is Terraform\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eTerraform is \u003ccode\u003eInfrasture as code\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOther \"infrasture-as-code\" are: chef, puppet, anisble, SaltStack, CloudFoundation\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe major building pieces to TF are:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003evariable (variables)\u003c/li\u003e\n\u003cli\u003elocals (variables with interpellation)\u003c/li\u003e\n\u003cli\u003eprovider (aws|azure|google)\u003c/li\u003e\n\u003cli\u003eprovisioners (execute scripts on a local or remote machine as part of the creation or destruction)\u003c/li\u003e\n\u003cli\u003edata (get information on existing services)\u003c/li\u003e\n\u003cli\u003eresource (create resource)\u003c/li\u003e\n\u003cli\u003emodule (isolate configuration)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eLinks:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://blog.gruntwork.io/an-introduction-to-terraform-f17df9c6d180\"\u003eintro\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://medium.com/@pavloosadchyi/terraform-patterns-and-tricks-i-use-every-day-117861531173\"\u003emedium post\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eTerraform is \u003ccode\u003edeclarative\u003c/code\u003e, it says \"I declare therefore i am\"\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003enon-Terraform services do not get auto-magicly added to your state, Terraform only tracks the things it makes\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003econfigurations: i declare the intent\u003c/li\u003e\n\u003cli\u003eState: current state\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003edry run \u003ccode\u003e$ terraform plan\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e Terraform ignores subfolders, in order to use subfolders you have to configure the subfolders to be a \u003ccode\u003eterraform module\u003c/code\u003e, then include those modules in your \u003ccode\u003emain.tf\u003c/code\u003e file\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eInstall\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003eYou can install TF with homebrew but it's better to install it with \u003ccode\u003etfswitch\u003c/code\u003e with homebrew\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://warrensbox.github.io/terraform-switcher/\"\u003eTerraform version manager\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ethis will allow you to switch version very easily\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e$ brew install warrensbox/tap/tfswitch\n$ tfswitch 0.12.4\n$ terraform -v\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eSave remote-state in S3\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://www.terraform.io/docs/backends/types/s3.html\"\u003edocs\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIt is highly recommended that you enable Bucket Versioning on the S3 bucket to allow for state recovery in the case of accidental deletions and human error.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePaths to the state file inside the bucket: \u003cem\u003e\u003ccode\u003e\u0026#x3C;bucket\u003e/\u0026#x3C;workspace_key_prefix\u003e/\u0026#x3C;workspace_name\u003e/\u0026#x3C;key\u003e\u003c/code\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003e\"Amazon S3\"/\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eBUCKET_NAME_FOR_TF_STATE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e/env:/dev/\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eTF_STATE_KEY\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\"Amazon S3\"/\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eBUCKET_NAME_FOR_TF_STATE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e/env:/staging/\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eTF_STATE_KEY\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\"Amazon S3\"/\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eBUCKET_NAME_FOR_TF_STATE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e/env:/prod/\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eTF_STATE_KEY\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eHere is the format for the terraform remote state code block\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ebackend\u003cspan class=\"token type variable\"\u003e \"s3\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"mybucket\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ekey\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"path/to/my/key\"\u003c/span\u003e     \u003cspan class=\"token comment\"\u003e# \u0026#x3C;TF_STATE_KEY\u003e, it can just be a single string\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-east-1\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eHere is an example for the terraform remote state code block\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ebackend\u003cspan class=\"token type variable\"\u003e \"s3\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ekey\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"someawesomesite\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003erequired_version\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003e= 0.13.5\"\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003erequired_providers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eaws\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003esource\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hashicorp/aws\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"~\u003e3.4\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eKey: the path to the state file inside the bucket. When using a non-default workspace, the state path will be /workspace_key_prefix/workspace_name/key\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"terraform_remote_state\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"network\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebackend\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"s3\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003econfig\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"terraform-state-prod\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ekey\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"network/terraform.tfstate\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-east-1\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOr you can have a blank terraform.backend and configure it with bash command\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token assign-left variable\"\u003estate_key\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"prod/some-app/\u003cspan class=\"token variable\"\u003e${ENVIRONMENT}\u003c/span\u003e.tfstate\"\u003c/span\u003e\nterraform init \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  -backend-config \u003cspan class=\"token assign-left variable\"\u003ebucket\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"my-terraform-state-bucket\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  -backend-config\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"key=\u003cspan class=\"token variable\"\u003e${state_key}\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  -backend-config\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"encrypt=true\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  -backend-config\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"region=us-west-2\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ebackend\u003cspan class=\"token type variable\"\u003e \"s3\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eTerraform CLI\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://www.terraform.io/docs/commands/index.html\"\u003eTerraform CLI\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003e$ terraform workspace (list|select|new|delete|show)\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ terraform init\n$ terraform validate\n$ terraform \u003cspan class=\"token function\"\u003efmt\u003c/span\u003e   \u003cspan class=\"token comment\"\u003e# format all terraform at the current folder level \u003c/span\u003e\n$ terraform plan\n$ terraform apply\n$ terraform apply -auto-approve\n$ terraform output\n$ terraform workspace\n\n$ terraform \u003cspan class=\"token function\"\u003eimport\u003c/span\u003e aws_s3_bucket.bucket \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003ebucket-name\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe terraform output command is used to extract the value of an output variable from the state file.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ terraform plan\n$ terraform output\n\n$ \u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e to-base-of-tf-directory\n$ terraform output\n\n$ terraform workspace \u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e prod \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e terraform refresh\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eTerraform Plugins\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003eTerraform relies on plugins called \"providers\" to interact with remote systems\u003c/li\u003e\n\u003cli\u003eDefining your providers:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003erequired_providers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emycloud\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003esource\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"mycorp/mycloud\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"~\u003e 1.0\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eThe \u003ccode\u003erequired_providers\u003c/code\u003e block must be nested inside the top-level \u003ccode\u003eterraform\u003c/code\u003e block (which can also contain other settings).\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://registry.terraform.io/namespaces/hashicorp\"\u003emain providers\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003eLifecycle management of AWS resources, including EC2, Lambda, EKS, ECS, VPC, S3, RDS, DynamoDB, and more. This provider is maintained internally by the HashiCorp AWS Provider team.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eVariable\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eYou can define variables and provide \u003ccode\u003etype\u003c/code\u003e, \u003ccode\u003edefault\u003c/code\u003e value, \u003ccode\u003edescription\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eVaraibles have to be hard-coded (you cannot interpolating values)\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"some_variable\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hello\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"This is an example of a variable that has a string type\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eBasic variable types are: string/list/map:\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe basic structure of defining a variable is:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"some_key\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u0026#x3C;string|list|map\u003e\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u0026#x3C;SOME_DEFAULT_VALUE\u003e\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAll variables used have to be defined beforehand\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eExample of the 3 basic types:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eString\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e some_string \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"string\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hello terraform string\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"this is a simple string\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Use into the resource\u003c/span\u003e\n\u003cspan class=\"token property\"\u003esome-parameter\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \"$\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003evar.some_string\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eList\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e some_list \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"list\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"subnet1\"\u003c/span\u003e,\n    \u003cspan class=\"token string\"\u003e\"subnet2\"\u003c/span\u003e,\n    \u003cspan class=\"token string\"\u003e\"subnet3\"\u003c/span\u003e,\n  \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"this is a list\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Use into the resource\u003c/span\u003e\n\u003cspan class=\"token property\"\u003esome-parameter\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \"$\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003evar.some_list\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eMap\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e some_map \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"map\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003esubnet1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"subnet1\"\u003c/span\u003e,\n    \u003cspan class=\"token property\"\u003esubnet2\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"subnet2\"\u003c/span\u003e,\n    \u003cspan class=\"token property\"\u003esubnet3\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"subnet3\"\u003c/span\u003e,\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"this is a map\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Use into the resource\u003c/span\u003e\n\u003cspan class=\"token property\"\u003esome-parameter\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \"$\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003evar.some_map\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"subnet1\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003enull\u003c/code\u003e value is a special value that has no type\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ea value that represents absence or omission\u003c/li\u003e\n\u003cli\u003eIf you set an argument of a resource or module to null, Terraform behaves as though you had completely omitted it\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWhen you run terraform all the empty variables (ones without a default value) if not provided in the command will be asked before terraform does it magic.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eYou can also override any variables by passing in them as a flag when you run a terraform command\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ terraform apply -var \u003cspan class=\"token assign-left variable\"\u003esome_key\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"this rocks\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eProviding a \u003ccode\u003eVariables File\u003c/code\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAll \u003ccode\u003e*.tfvars\u003c/code\u003e will get picked up when you run terraform, sometimes you want to load specific variable files based on the environment you want to deploy so passing supply \u003ccode\u003e-var-file=\u0026#x3C;FILE_NAME\u003e.tfvars\u003c/code\u003e with variable values might a great way to deal with different variables for different environments\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003etfvar\u003c/code\u003e file\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token property\"\u003edomain_suffix\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"-dev\"\u003c/span\u003e\n\u003cspan class=\"token property\"\u003ehosted_zone_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"someawesomesite.com\"\u003c/span\u003e\n\u003cspan class=\"token property\"\u003eenv_tag\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Development\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emain.tf\u003c/code\u003e file\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e domain_suffix \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e hosted_zone_name \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e env_tag \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ePlan\u003c/code\u003e script\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token comment\"\u003e# `plan.sh` script to run a plan\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eWORKSPACE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"dev\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eVAR_FILE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"./env_configs/dev.tfvars\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eterraform_state_bucket\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u0026#x3C;TERRAFORM_S3_STATE_BUCKET\u003e\"\u003c/span\u003e\n\u003cspan class=\"token function\"\u003erm\u003c/span\u003e -rf .terraform/\nterraform init -backend-config \u003cspan class=\"token assign-left variable\"\u003ebucket\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e${terraform_state_bucket}\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003e terraform workspace \u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token variable\"\u003e${WORKSPACE}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e\n  terraform workspace new \u003cspan class=\"token variable\"\u003e${WORKSPACE}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\nterraform plan -var-file\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$VAR_FILE\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eYou can provide variables via the terminal\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003eterraform apply -auto-approve \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  -var\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"SOME_VAR_NAME=SOME_VALUE\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  -var\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"SOME_OTHER_VAR_NAME=SOME_VALUE\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"SOME_VAR_NAME\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"SOME_OTHER_VAR_NAME\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eLocals (Local Value Configuration)\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003elocals are like variables that you can pass in ${dynamic} values\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eA local value assigns a name to an expression, so you can use it multiple times within a module without repeating it.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eDRY principles, allows you to preform logic to create a value where you don't have to write every time\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eYou can also reference the a local variable inside the locals code block\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eeg of locals\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003elocals\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token function\"\u003ereplace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003eapp_namespace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"_\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"-\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e-\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003eworkspace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e-client\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003edomain_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003edomain_suffix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003ehosted_zone_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# Ids for multiple sets of EC2 instances, merged together\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elocals\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003einstance_ids\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token function\"\u003econcat\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaws_instance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eblue\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e*\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e aws_instance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003egreen\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e*\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# A computed default name prefix\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elocals\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault_name_prefix\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003eproject_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e-web\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename_prefix\u003c/span\u003e         \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003ename_prefix\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e?\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003ename_prefix\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003elocal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003edefault_name_prefix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Local values can be interpolated elsewhere using the \"local.\" prefix.\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_s3_bucket\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"files\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elocal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003ename_prefix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e-files\"\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# ...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eProvider\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://www.terraform.io/docs/providers/index.html\"\u003eproviders\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eProviders are basically cloud providers as a service\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIaaS (infrastruture as a Service) like AWS, Azure, GCP\u003c/li\u003e\n\u003cli\u003ePaaS (Platform as a Service) like Heroku\u003c/li\u003e\n\u003cli\u003eSaaS (Software as a Service) like DNSimple, CloudFlare\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://www.terraform.io/docs/providers/aws/index.html\"\u003eAWS\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eyou can pass in your access-key/secret-key via environment variables, or hardcoded (not recommended)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://alimac.io/static-websites-with-s3-and-hugo-part-1/\"\u003etut\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eDifferent ways to define providers:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eaws creds\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# access_key = \"${var.aws_access_key}\"\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# secret_key = \"${var.aws_secret_key}\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-east-2\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003ehard-coded:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eaccess_key\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my-access-key\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esecret_key\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my-secret-key\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003evia Environment variables\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ \u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_ACCESS_KEY_ID\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"anaccesskey\"\u003c/span\u003e\n$ \u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_SECRET_ACCESS_KEY\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"asecretkey\"\u003c/span\u003e\n$ \u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_DEFAULT_REGION\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n$ terraform plan\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col start=\"4\"\u003e\n\u003cli\u003eshared credentials:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e                  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eshared_credentials_file\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/Users/tf_user/.aws/creds\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eprofile\u003c/span\u003e                 \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"customprofile\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.terraform.io/docs/configuration/providers.html#alias-multiple-provider-instances\"\u003eusing multiple providers\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eData\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003eGet information on an existing resource\u003c/li\u003e\n\u003cli\u003eaws_route53_zone\u003c/li\u003e\n\u003cli\u003eaws_caller_identity\u003c/li\u003e\n\u003cli\u003eaws_acm_certificate\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eResource\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003eCreate AWS resources:\n\u003cul\u003e\n\u003cli\u003eaws_iam_policy_document\u003c/li\u003e\n\u003cli\u003eaws_acm_certificate\u003c/li\u003e\n\u003cli\u003eaws_acm_certificate_validation\u003c/li\u003e\n\u003cli\u003eaws_route53_record\u003c/li\u003e\n\u003cli\u003eaws_s3_bucket\u003c/li\u003e\n\u003cli\u003eaws_cloudfront_distribution\u003c/li\u003e\n\u003cli\u003eaws_cloudfront_origin_access_identity\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e*** you can make a resource optionally if you pass in a count***\n\u003cul\u003e\n\u003cli\u003eif you want the resource to be created if var.env == prod\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token property\"\u003ecount\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003eenv\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"prod\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e?\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eProvisioners\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003eused to execute scripts on a local or remote machine as part of the creation or destruction\u003c/li\u003e\n\u003cli\u003ecreation-time provisioners\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_instance\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"web\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# ...\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eprovisioner\u003cspan class=\"token type variable\"\u003e \"local-exec\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecommand\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"echo \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003eprivate_ip\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e \u003e file.txt\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eby default provisioners run when a resource is created, not during the updating or any other lifecycle\u003c/li\u003e\n\u003cli\u003eit is meant for bootstrapping a system\u003c/li\u003e\n\u003cli\u003eif a creation-time provisioner fails, the resource will be flagged as \u003cem\u003etainted\u003c/em\u003e, and will be planned for destruction upon the next \u003cem\u003e$ terraform apply\u003c/em\u003e\u003c/li\u003e\n\u003cli\u003edestroy-time provisioner\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_instance\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"web\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# ...\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eprovisioner\u003cspan class=\"token type variable\"\u003e \"local-exec\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ewhen\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"destroy\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecommand\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"echo 'Destroy-time provisioner'\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003emultiple provisioners\n\u003cul\u003e\n\u003cli\u003eyou can add multiple provisioners and they will run in the order they are defined\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_instance\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"web\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# ...\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eprovisioner\u003cspan class=\"token type variable\"\u003e \"local-exec\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecommand\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"echo first\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eprovisioner\u003cspan class=\"token type variable\"\u003e \"local-exec\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecommand\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"echo second\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eOutputs\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eYou can print out the values that terraform will generate, when you run it with with \u003ccode\u003e$ terraform output\u003c/code\u003e it will output all the variable that is provided from the tfstate file\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWhen you make a module you can define the \u003ccode\u003eoutput\u003c/code\u003e your module provides as getters\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eYou can create bash variables from terraform \u003ccode\u003eoutput\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eoutput\u003cspan class=\"token type variable\"\u003e \"bucket_name\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003evalue\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elocal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003es3_bucket_website_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003eterraform apply -auto-approve\n\u003cspan class=\"token assign-left variable\"\u003ebucket_name\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003eterraform output bucket_name\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token function\"\u003enpm\u003c/span\u003e run build\naws s3 \u003cspan class=\"token function\"\u003erm\u003c/span\u003e s3://\u003cspan class=\"token variable\"\u003e$bucket_name\u003c/span\u003e/  --recursive\naws s3 \u003cspan class=\"token function\"\u003esync\u003c/span\u003e build/ s3://\u003cspan class=\"token variable\"\u003e$bucket_name\u003c/span\u003e/ --exclude \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\"*.DS_Store*\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\"\naws s3 \u003cspan class=\"token function\"\u003ecp\u003c/span\u003e build/index.html s3://\u003cspan class=\"token variable\"\u003e$bucket_name\u003c/span\u003e/ --cache-control max-age\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eWorkspace\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.terraform.io/docs/state/workspaces.html\"\u003edocs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eif you don't define a workspace then you only worked on the \"default\" workspace\u003c/li\u003e\n\u003cli\u003edefines how operations are executed\u003c/li\u003e\n\u003cli\u003ewhere persistent data are stored (for example terraform-state file)\u003c/li\u003e\n\u003cli\u003eCreating a new workspace:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ \u003cspan class=\"token assign-left variable\"\u003eterraform_state_bucket\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ngp-terraform-remote-config\"\u003c/span\u003e\n$ terraform init -backend-config \u003cspan class=\"token assign-left variable\"\u003ebucket\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e${terraform_state_bucket}\u003c/span\u003e\"\u003c/span\u003e\n\n$ \u003cspan class=\"token assign-left variable\"\u003eENVIRONMENT\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003edev\n$ terraform workspace new \u003cspan class=\"token variable\"\u003e$ENVIRONMENT\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eUsing an existing workspace:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ \u003cspan class=\"token assign-left variable\"\u003eterraform_state_bucket\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ngp-terraform-remote-config\"\u003c/span\u003e\n$ terraform init -backend-config \u003cspan class=\"token assign-left variable\"\u003ebucket\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e${terraform_state_bucket}\u003c/span\u003e\"\u003c/span\u003e\n\n$ \u003cspan class=\"token assign-left variable\"\u003eENVIRONMENT\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003edev\n$ terraform workspace \u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ENVIRONMENT\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eAuto approve\u003c/summary\u003e\n\u003ch1\u003eTerraform auto-approve apply\u003c/h1\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ terraform apply -auto-approve\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eModules\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eTerraform ignores subfolders, in order to use subfolders you have to configure the subfolders to be a \u003ccode\u003eterraform module\u003c/code\u003e, then include those modules in your \u003ccode\u003emain.tf\u003c/code\u003e file.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003emodule\u003cspan class=\"token type variable\"\u003e \"custom_module\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esource\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"./modules/custom_module\"\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eapp_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"app-name\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eModules can be created locally or accessed at a url\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIt's like a class for terraform, it encapsulate a piece of configuration\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eA container for multiple resources that are used together.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eModules structure:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eInput variables\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eaccept values from the calling modules\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e\u003cstrong\u003eOutput values\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003ereturns values you can ues to populate arguments elsewhere\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e\u003cstrong\u003eResources\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003edefine 1-or-more infrastructure objects that the module will manage.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eTo define a module, create a new directory and place some \u003ccode\u003e.tf\u003c/code\u003e files inside of it\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eTerraform can load modules either from local relative paths (prefix with \u003ccode\u003e./\u003c/code\u003e) or from remote repositories\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e\"./\"\u003c/code\u003e prefix indicates that the address is a relative filesystem path.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eminimal folder structure:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token builtin class-name\"\u003e.\u003c/span\u003e\n├── README.md\n├── main.tf\n├── variables.tf\n├── outputs.tf\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eStandard structure with nested module\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token builtin class-name\"\u003e.\u003c/span\u003e\n├── README.md\n├── main.tf\n├── variables.tf\n├── outputs.tf\n├── \u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e.\n├── modules/\n│   ├── nestedA/\n│   │   ├── README.md\n│   │   ├── variables.tf\n│   │   ├── main.tf\n│   │   ├── outputs.tf\n│   ├── nestedB/\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAccessing the module's outputs you need to reference the module's outputs inside the root tf files. Example \u003ccode\u003e./main.tf\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eoutput\u003cspan class=\"token type variable\"\u003e \"root_variable_output_val\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003evalue\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Hello from the root tf\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eoutput\u003cspan class=\"token type variable\"\u003e \"module_variable_output_val\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003evalue\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e module.some_awesome_module\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eCalling modules \u003ccode\u003emodule.\u0026#x3C;MODULE_NAME\u003e.\u0026#x3C;OUPUT_VALUE\u003e\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://www.terraform.io/docs/modules/sources.html\"\u003esource modules\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003emodule installer supports:\n\u003cul\u003e\n\u003cli\u003eLocal paths\u003c/li\u003e\n\u003cli\u003eTerraform Registry\u003c/li\u003e\n\u003cli\u003eGitHub\u003c/li\u003e\n\u003cli\u003eBitbucketGeneric Git, Mercurial repositories\u003c/li\u003e\n\u003cli\u003eHTTP URLs\u003c/li\u003e\n\u003cli\u003eS3 buckets\u003c/li\u003e\n\u003cli\u003eGCS buckets\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eExample of using modules source\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003emodule\u003cspan class=\"token type variable\"\u003e \"consul\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esource\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"./consul\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eExample of using modules source\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003emodule\u003cspan class=\"token type variable\"\u003e \"consul\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esource\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"../module_at_parent_level\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eExample of using modules source from Github\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003emodule\u003cspan class=\"token type variable\"\u003e \"consul\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esource\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"git::https://github.com/\u0026#x3C;GITHUB_NAMESPACE\u003e/\u0026#x3C;REPO_NAME\u003e.git\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003emodule\u003cspan class=\"token type variable\"\u003e \"consul\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esource\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"git::https://github.com/\u0026#x3C;GITHUB_NAMESPACE\u003e/\u0026#x3C;REPO_NAME\u003e.git?ref=1.2.3\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003emodule\u003cspan class=\"token type variable\"\u003e \"consul\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esource\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"git::https://github.com/\u0026#x3C;GITHUB_NAMESPACE\u003e/\u0026#x3C;REPO_NAME\u003e.git?ref=\u0026#x3C;SOME_BRANCH_NAME\u003e\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/azavea/terraform-aws-acm-certificate\"\u003eterraform-aws-acm-certificate\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-east-1\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ealias\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"certificates\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ealias\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"dns\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_route53_zone\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"default\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"azavea.com\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003emodule\u003cspan class=\"token type variable\"\u003e \"cert\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esource\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"github.com/azavea/terraform-aws-acm-certificate?ref=1.1.0\"\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eproviders\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eaws.acm_account\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"aws.certificates\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eaws.route53_account\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"aws.dns\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e                       \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"azavea.com\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esubject_alternative_names\u003c/span\u003e         \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"*.azavea.com\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ehosted_zone_id\u003c/span\u003e                    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_route53_zone\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edefault\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ezone_id\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003evalidation_record_ttl\u003c/span\u003e             \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"60\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eallow_validation_record_overwrite\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eNOTE:\u003c/strong\u003e \u003cem\u003eIf you want to conditionally use a module\u003c/em\u003e, Terraform 0.13 allows you do add a count to a module. You might want to use this if you only want a module to run in a specific deployment environment\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e forProd \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"resource_type\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"resource_name\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n \u003cspan class=\"token property\"\u003ecount\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.forProd ? \u003cspan class=\"token number\"\u003e1\u003c/span\u003e : \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n ... other resource properties \n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003ch1\u003eTerraform and Providers\u003c/h1\u003e\n\u003cdetails\u003e\n\u003csummary\u003eTerraform for New Relic Dashboard\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eAssign some variables to the new-relic account id \u0026#x26; api-key\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e account_id \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e api_key \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eterraform block \u0026#x26; newrelic provider\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003erequired_version\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003e= 0.13.5\"\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003erequired_providers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003enewrelic\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003esource\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"newrelic/newrelic\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"~\u003e 2.21.0\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"newrelic\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eaccount_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.account_id\n  \u003cspan class=\"token property\"\u003eapi_key\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.api_key\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"US\"\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Valid regions are US and EU\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eCreate a new relic one dashboard\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"newrelic_one_dashboard\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"nark_dashboard\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.dashboard_name\n\n  \u003cspan class=\"token keyword\"\u003epage\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.dashboard_name\n\n    \u003cspan class=\"token keyword\"\u003ewidget_markdown\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etitle\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Dashboard Note\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003erow\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003ecolumn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etext\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"# A\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewidget_markdown\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etitle\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Dashboard Note\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003erow\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003ecolumn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etext\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"# B\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewidget_markdown\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etitle\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Dashboard Note\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003erow\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003ecolumn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e9\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etext\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"# C\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003ewidget_markdown\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etitle\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Dashboard Note\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003erow\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003ecolumn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etext\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"# D\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewidget_markdown\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etitle\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Dashboard Note\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003erow\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003ecolumn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etext\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"# E\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewidget_markdown\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etitle\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Dashboard Note\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003erow\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003ecolumn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e6\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etext\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"# F\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePass in the newrelic account/api-key which running the terraform script\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ \u003cspan class=\"token assign-left variable\"\u003eNR_ACCOUNT_NUMBER\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"****\"\u003c/span\u003e\n$ \u003cspan class=\"token assign-left variable\"\u003eNR_API_KEY\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"****\"\u003c/span\u003e\n\n$ terraform plan \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  -var\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"account_id=\u003cspan class=\"token variable\"\u003e$NR_ACCOUNT_NUMBER\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  -var\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"api_key=\u003cspan class=\"token variable\"\u003e$NR_API_KEY\u003c/span\u003e\"\u003c/span\u003e\n\n$ terraform apply -auto-approve \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  -var\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"account_id=\u003cspan class=\"token variable\"\u003e$NR_ACCOUNT_NUMBER\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  -var\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"api_key=\u003cspan class=\"token variable\"\u003e$NR_API_KEY\u003c/span\u003e\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eAPI Gateway\u003c/summary\u003e\n\u003col\u003e\n\u003cli\u003eCreate a lambda function, \u003ccode\u003esrc/index.js\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003emodule\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eexports\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method-variable function-variable method function property-access\"\u003ehandler\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eevent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'Event: '\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e event\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e responseMessage \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'Hello, World!'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003estatusCode\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e200\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token string-property property\"\u003e'Content-Type'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'application/json'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ebody\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eJSON\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003estringify\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003emessage\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e responseMessage\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eCreate a \u003ccode\u003e.gitignore\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token comment\"\u003e# Local .terraform directories\u003c/span\u003e\n**/.terraform/*\n\n\u003cspan class=\"token comment\"\u003e# .tfstate files\u003c/span\u003e\n*.tfstate\n*.tfstate.*\n\n\u003cspan class=\"token comment\"\u003e# Crash log files\u003c/span\u003e\ncrash.log\n\n\u003cspan class=\"token comment\"\u003e# Exclude all .tfvars files, which are likely to contain sentitive data, such as\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# password, private keys, and other secrets. These should not be part of version \u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# control as they are data points which are potentially sensitive and subject \u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# to change depending on the environment.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#\u003c/span\u003e\n*.tfvars\n\n\u003cspan class=\"token comment\"\u003e# Ignore override files as they are usually used to override resources locally and so\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# are not checked in\u003c/span\u003e\noverride.tf\noverride.tf.json\n*_override.tf\n*_override.tf.json\n\n\u003cspan class=\"token comment\"\u003e# Include override files you do wish to add to version control using negated pattern\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# !example_override.tf\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Include tfplan files to ignore the plan output of command: terraform plan -out=tfplan\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# example: *tfplan*\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Ignore CLI configuration files\u003c/span\u003e\n.terraformrc\nterraform.rc\nhello-world.zip\nresponse.json\n\n\u003cspan class=\"token comment\"\u003e# node packages\u003c/span\u003e\nnode_modules\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eScript for running the lambda file locally\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eCreate an \u003ccode\u003etest/event.json\u003c/code\u003e file to pass into your lambda\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"resource\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/API/PATH\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"path\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/API/PATH\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"httpMethod\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"headers\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"multiValueHeaders\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"queryStringParameters\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"multiValueQueryStringParameters\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"pathParameters\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"stageVariables\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"requestContext\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"resourceId\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"xxxxx\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"resourcePath\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/api/endpoint\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"httpMethod\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"path\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/env/api/endpoint\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"protocol\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"HTTP/1.1\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"stage\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"env\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"domainName\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"url.us-east-1.amazonaws.com\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"body\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"{\\n    \\\"city\\\": \\\"Test 1 City\\\",\\n    \\\"state\\\": \\\"NY\\\",\\n    \\\"zipCode\\\": \\\"11549\\\"\\n}\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"isBase64Encoded\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eAdd a script to run the lambda file locally\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"scripts\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"lambda:envoke:local\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"node -e \\\"console.log(require('./src/index.js').handler(require('./test/event.json')));\\\"\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"4\"\u003e\n\u003cli\u003eLet's add some terraform files\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eCreate  \u003ccode\u003e./terraform/main.tf\u003c/code\u003e and let's add the AWS providers, define the remote config file key\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ebackend\u003cspan class=\"token type variable\"\u003e \"s3\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ekey\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"api-gateway-example\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003erequired_providers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eaws\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003esource\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hashicorp/aws\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"~\u003e 4.0.0\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003earchive\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003esource\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hashicorp/archive\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"~\u003e 2.2.0\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003erequired_version\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"~\u003e 1.0\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.aws_region\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eCreate \u003ccode\u003e./terraform/variables.tf\u003c/code\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"aws_region\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"AWS region for all resources.\"\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"project_name\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Project name to be used throughout the application\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"example-tf-api-gateway\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"5\"\u003e\n\u003cli\u003eManually create an S3 bucket for your terraform state files and call it \u003ccode\u003eterraform-remote-config-\u0026#x3C;AWS_ACCOUNT_NUMBER\u003e\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eLet's run this\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e you want to make you have your AWS-CLI credential configured (\u003ca href=\"https://docs.aws.amazon.com/cli/latest/userguide/getting-started-quickstart.html\"\u003emore here\u003c/a\u003e) so that Terraform can push to the right account.\u003c/li\u003e\n\u003cli\u003eCreate a \u003ccode\u003e./deploy.sh\u003c/code\u003e file\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token builtin class-name\"\u003eset\u003c/span\u003e -e\n\n\u003cspan class=\"token comment\"\u003e# Environments\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$1\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e\n  dev\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \n    \u003cspan class=\"token assign-left variable\"\u003eWORKSPACE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"dev\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  prod\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \n    \u003cspan class=\"token assign-left variable\"\u003eWORKSPACE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"prod\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  *\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e $\u003cspan class=\"token string\"\u003e\"Usage: \u003cspan class=\"token variable\"\u003e$0\u003c/span\u003e {dev|prod}\"\u003c/span\u003e\n    \u003cspan class=\"token builtin class-name\"\u003eexit\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eesac\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Running tf-deploy on \u003cspan class=\"token variable\"\u003e${WORKSPACE}\u003c/span\u003e\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Terraform state, bucket name\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eAWS_ACCOUNT_ID\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003eaws sts get-caller-identity \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e jq -r \u003cspan class=\"token string\"\u003e'.Account'\u003c/span\u003e\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eterraform_state_bucket\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"terraform-remote-config-\u003cspan class=\"token variable\"\u003e$AWS_ACCOUNT_ID\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Using Terraform state bucket: \u003cspan class=\"token variable\"\u003e$terraform_state_bucket\u003c/span\u003e\"\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003epushd\u003c/span\u003e terraform\n\n\u003cspan class=\"token comment\"\u003e# Cleanup .terraform\u003c/span\u003e\n\u003cspan class=\"token function\"\u003erm\u003c/span\u003e -rf .terraform/\n\n\u003cspan class=\"token comment\"\u003e# Deploy terraform\u003c/span\u003e\nterraform init -backend-config \u003cspan class=\"token assign-left variable\"\u003ebucket\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e${terraform_state_bucket}\u003c/span\u003e\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# If the workspace does not exist, create it.\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003e terraform workspace \u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token variable\"\u003e${WORKSPACE}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e\n  terraform workspace new \u003cspan class=\"token variable\"\u003e${WORKSPACE}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\nterraform apply -auto-approve\n\u003cspan class=\"token function\"\u003epopd\u003c/span\u003e\n\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"DONE!\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eRun the script\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token comment\"\u003e# Allow the deploy script to be run \u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003echmod\u003c/span\u003e +x deploy.sh\n\n$ ./deploy.sh\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eNow if you go to AWS console and look in your \u003ccode\u003eterraform-remote-config-\u0026#x3C;AWS_ACCOUNT_NUMBER\u003e\u003c/code\u003e bucket yo should have \u003ccode\u003e./env:/dev/api-gateway-example\u003c/code\u003e file\u003c/li\u003e\n\u003cli\u003eSweet now we have terraform setup that will update the state file in AWS so others can work on this project instead of the state file only being on your machine,\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"7\"\u003e\n\u003cli\u003eCreate and upload Lambda function archive to S3\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_s3_bucket\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"rest_api_source\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.project_name\n\n  \u003cspan class=\"token property\"\u003etags\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eName\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"My bucket for API Gateway source code\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eEnvironment\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Dev\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_s3_bucket_acl\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"example\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_s3_bucket.rest_api_source.id\n  \u003cspan class=\"token property\"\u003eacl\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"private\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"archive_file\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"rest_api_source\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"zip\"\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003esource_dir\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"../rest-api/\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003epath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003emodule\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e/src\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eoutput_path\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"../rest-api/\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003epath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003emodule\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e/dist/rest-api-source.zip\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_s3_object\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"rest_api_source\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_s3_bucket.rest_api_source.id\n\n  \u003cspan class=\"token property\"\u003ekey\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"rest-api-source.zip\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esource\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.archive_file.rest_api_source.output_path\n\n  \u003cspan class=\"token property\"\u003eetag\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e filemd5(data.archive_file.rest_api_source.output_path)\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col start=\"8\"\u003e\n\u003cli\u003eCreate the lambda function from the S3 zipped file\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_lambda_function\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"rest_api\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003efunction_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.project_name\n\n  \u003cspan class=\"token property\"\u003es3_bucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_s3_bucket.rest_api_source.id\n  \u003cspan class=\"token property\"\u003es3_key\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_s3_object.rest_api_source.key\n\n  \u003cspan class=\"token property\"\u003eruntime\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"nodejs12.x\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ehandler\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index.handler\"\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003esource_code_hash\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.archive_file.rest_api_source.output_base64sha256\n\n  \u003cspan class=\"token property\"\u003erole\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_iam_role.lambda_exec.arn\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_cloudwatch_log_group\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"rest_api\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/aws/lambda/\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_lambda_function\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003erest_api\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efunction_name\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eretention_in_days\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e30\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_iam_role\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"lambda_exec\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"serverless_lambda\"\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eassume_role_policy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e jsonencode(\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eVersion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"2012-10-17\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eStatement\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eAction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"sts:AssumeRole\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eEffect\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Allow\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eSid\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003ePrincipal\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003eService\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"lambda.amazonaws.com\"\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e)\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_iam_role_policy_attachment\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"lambda_policy\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003erole\u003c/span\u003e       \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_iam_role.lambda_exec.name\n  \u003cspan class=\"token property\"\u003epolicy_arn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003eCustom Authorizer needs to return IAM Policy, \u003ca href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-lambda-authorizer-output.html\"\u003elearn more here\u003c/a\u003e, for example:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"principalId\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"yyyyyyyy\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// The principal user identification associated with the token sent by the client.\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"policyDocument\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"Version\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"2012-10-17\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"Statement\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"Action\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"execute-api:Invoke\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"Effect\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Allow|Deny\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"Resource\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"arn:aws:execute-api:{regionId}:{accountId}:{apiId}/{stage}/{httpVerb}/[{resource}/[{child-resources}]]\"\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"context\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"stringKey\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"value\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"numberKey\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"1\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"booleanKey\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"true\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"usageIdentifierKey\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"{api-key}\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eThe \u003ccode\u003econtext\u003c/code\u003e object is optional\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://awspolicygen.s3.amazonaws.com/policygen.html\"\u003ePolicy Generator\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003ch1\u003eTerraform (Infrastructure as Code) to build out your services\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eWhy?\n\u003cul\u003e\n\u003cli\u003eTo document all the services that are being used\u003c/li\u003e\n\u003cli\u003eRepeatable \u0026#x26; reusable solution\u003c/li\u003e\n\u003cli\u003eTare down all the services created with Terraform because TF creates an inventory of all the services in a state file\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eTerraform for a client-side static web application\u003c/h1\u003e\n\u003ch2\u003eThe variable file\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eThis file is the only \u003ccode\u003e.tf\u003c/code\u003e file where you need to update values the rest of the \u003ccode\u003e.tf\u003c/code\u003e files are totally project agnostic\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./varables.tf)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Required variables (values passed in via command)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e domain_name \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e hosted_zone_name \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e env_tags \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# TF version \u0026#x26; State file config\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ebackend\u003cspan class=\"token type variable\"\u003e \"s3\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ekey\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u0026#x3C;YOUR_PROJECT_NAME_HERE\u003e\"\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# this will define the TF state file\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003erequired_version\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003e= 0.13.5\"\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003erequired_providers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eaws\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003esource\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hashicorp/aws\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"~\u003e3.4\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Default region\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"region\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.region\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Interpolated Values\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elocals\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003edomain_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003edomain_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Data\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#-------------------------------------------\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_caller_identity\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"current\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eS3\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eUse S3 to store the static web files and a second bucket for logging\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./s3.tf)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_s3_bucket\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"site\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e local.bucket_name\n  \u003cspan class=\"token property\"\u003eacl\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"private\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003epolicy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.aws_iam_policy_document.website_s3_policy.json\n\n  \u003cspan class=\"token keyword\"\u003ewebsite\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eindex_document\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index.html\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eerror_document\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"404.html\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003etags\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eEnvironment\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.env_tags\n    \u003cspan class=\"token property\"\u003eCreated_with\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Terraform\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_s3_bucket\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"log_bucket\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elocal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003ebucket_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e-logs\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eacl\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"log-delivery-write\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003ePolicies\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eThis policie only allows access via CloudFront to serve the webcontent\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./policies.tf)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"website_s3_policy\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003estatement\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eactions\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"s3:GetObject\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresources\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"arn:aws:s3:::\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elocal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003ebucket_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e/*\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprincipals\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"AWS\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eidentifiers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_cloudfront_origin_access_identity\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewebsite_origin_access_identity\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eiam_arn\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eRoute53\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eMake sure that you purchase your domain name beforehand because we will need the Hosted Zone Id\u003c/li\u003e\n\u003cli\u003eWe will use TF to create an \u003ccode\u003eA\u003c/code\u003e record to connect to the CloudFront instance\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./route53.tf)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_route53_record\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"domain\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e local.domain_name\n  \u003cspan class=\"token property\"\u003ezone_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.aws_route53_zone.base.zone_id\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"A\"\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ealias\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ename\u003c/span\u003e                   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_distribution.website_cdn.domain_name\n    \u003cspan class=\"token property\"\u003ezone_id\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_distribution.website_cdn.hosted_zone_id\n    \u003cspan class=\"token property\"\u003eevaluate_target_health\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_route53_zone\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"base\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e         \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003ehosted_zone_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e.\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eprivate_zone\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eACM for certs\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eACM provides an elegant wayt to convert  a cumbersome multi-step process into a single step, however when combined with Terraform this process is a little more complex because some processes have to happen in senquential steps\u003c/li\u003e\n\u003cli\u003eSome of the TF modules include:\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eaws_acm_certificate\u003c/code\u003e: To request a certificate for example.com\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eaws_route53_record\u003c/code\u003e: To create a DNS record to validate the certificate request\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eaws_certificate_validation\u003c/code\u003e: To ensure that ACM validates our DNS record before certificate use\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eIn an effort to reduce the timming steps, \u003ca href=\"https://www.azavea.com/\"\u003eazavea's team\u003c/a\u003e assembled a reusable \u003ca href=\"https://github.com/azavea/terraform-aws-acm-certificate\"\u003eTerraform module\u003c/a\u003e to encapsulate the ACM and Route 53 resources used. Using the output from the validation resource ensures that Terraform will wait for ACM to validate the certificate before resolving its ARN. Now, the process of creating, validating, and waiting for a valid certificate looks like this:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./certs.tf)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_route53_zone\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"base\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e         \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003ehosted_zone_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e.\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eprivate_zone\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-east-1\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ealias\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"certificates\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.region\n  \u003cspan class=\"token property\"\u003ealias\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"dns\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003emodule\u003cspan class=\"token type variable\"\u003e \"cert\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esource\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"github.com/azavea/terraform-aws-acm-certificate?ref=3.0.0\"\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eproviders\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eaws.acm_account\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws.certificates\n    \u003cspan class=\"token property\"\u003eaws.route53_account\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws.dns\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e                       \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e local.domain_name\n  \u003cspan class=\"token property\"\u003ehosted_zone_id\u003c/span\u003e                    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.aws_route53_zone.base.zone_id\n  \u003cspan class=\"token property\"\u003evalidation_record_ttl\u003c/span\u003e             \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"60\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eallow_validation_record_overwrite\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_route53_record\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"domain\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e local.domain_name\n  \u003cspan class=\"token property\"\u003ezone_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.aws_route53_zone.base.zone_id\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"A\"\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ealias\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ename\u003c/span\u003e                   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_distribution.website_cdn.domain_name\n    \u003cspan class=\"token property\"\u003ezone_id\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_distribution.website_cdn.hosted_zone_id\n    \u003cspan class=\"token property\"\u003eevaluate_target_health\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eCloudFront\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eCloudFront allows for global distribution of our web content with the ability to cache content at AWS edge locations\u003c/li\u003e\n\u003cli\u003eThe CloudFront configuration is kind of a beast\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./cloudfront.tf)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_cloudfront_origin_access_identity\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"website_origin_access_identity\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ecomment\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"site \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003eworkspace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e Access Identity\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_cloudfront_distribution\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"website_cdn\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eorigin\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_s3_bucket.site.bucket_regional_domain_name\n    \u003cspan class=\"token property\"\u003eorigin_id\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"origin-bucket-\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_s3_bucket\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esite\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003es3_origin_config\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eorigin_access_identity\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_origin_access_identity.website_origin_access_identity.cloudfront_access_identity_path\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eenabled\u003c/span\u003e             \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eis_ipv6_enabled\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault_root_object\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index.html\"\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003elogging_config\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003einclude_cookies\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_s3_bucket.log_bucket.bucket_domain_name\n    \u003cspan class=\"token property\"\u003eprefix\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"cloudfront_logs\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003ealiases\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003elocal.domain_name\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003edefault_cache_behavior\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eallowed_methods\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"DELETE\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"PATCH\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"PUT\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecached_methods\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_origin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"origin-bucket-\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_s3_bucket\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esite\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eforwarded_values\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003equery_string\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"true\"\u003c/span\u003e\n\n      \u003cspan class=\"token keyword\"\u003ecookies\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003eforward\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"none\"\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token property\"\u003eviewer_protocol_policy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"redirect-to-https\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecompress\u003c/span\u003e               \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emin_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edefault_ttl\u003c/span\u003e            \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e300\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emax_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1200\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# Cache behavior with precedence 0\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eordered_cache_behavior\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003epath_pattern\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/index.html\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eallowed_methods\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"DELETE\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"PATCH\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"PUT\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecached_methods\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_origin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"origin-bucket-\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_s3_bucket\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esite\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eforwarded_values\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003equery_string\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"true\"\u003c/span\u003e\n\n      \u003cspan class=\"token keyword\"\u003ecookies\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003eforward\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"none\"\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token property\"\u003emin_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edefault_ttl\u003c/span\u003e            \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emax_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecompress\u003c/span\u003e               \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eviewer_protocol_policy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"redirect-to-https\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003ecustom_error_response\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eerror_code\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"404\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresponse_code\u003c/span\u003e      \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"200\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresponse_page_path\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/index.html\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \n  \u003cspan class=\"token keyword\"\u003ecustom_error_response\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eerror_code\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"403\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresponse_code\u003c/span\u003e      \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"200\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresponse_page_path\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/index.html\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eprice_class\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"PriceClass_100\"\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PriceClass.html\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003erestrictions\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003egeo_restriction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003erestriction_type\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"none\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eviewer_certificate\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eacm_certificate_arn\u003c/span\u003e      \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e module.cert.arn\n    \u003cspan class=\"token property\"\u003essl_support_method\u003c/span\u003e       \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"sni-only\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eminimum_protocol_version\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"TLSv1\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003elifecycle\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eignore_changes\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003etags\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003etags\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eEnvironment\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.env_tags\n    \u003cspan class=\"token property\"\u003eCreated_with\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Terraform\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eFinally the \u003ccode\u003e.tfvars\u003c/code\u003e file\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eCreating a \u003ccode\u003e.tfvar\u003c/code\u003e file allows you to deploy this applications to multiple environments (dev|statging|prod)\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# (./env_configs/prod.tfvars)\u003c/span\u003e\n\u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e      \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"myawesomesite.com\"\u003c/span\u003e\n\u003cspan class=\"token property\"\u003ehosted_zone_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"myawesomesite.com\"\u003c/span\u003e\n\u003cspan class=\"token property\"\u003eenv_tags\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Production\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eNow running this\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token comment\"\u003e# *NOTE* run these commands in the terraform folder\u003c/span\u003e\n\n\u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_PROFILE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u0026#x3C;YOUR_AWS_PROFILE_HERE\u003e\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eCLIENT_BUCKET_NAME\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u0026#x3C;YOUR_AWS_S3_BUCKET_NAME\u003e\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eTERRAFORM_STATE_BUCKET_NAME\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u0026#x3C;YOUR_TF_REMOTE_STATE_BUCKET_NAME\u003e\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Environment variables\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eWORKSPACE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"prod\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eVAR_FILE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"./env/prod.tfvars\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# TF version\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003etf_ver\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"v0.13.5\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003e \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003eTerraform --version\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=~\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Terraform \u003cspan class=\"token variable\"\u003e$tf_ver\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Terraform \u003cspan class=\"token variable\"\u003e$tf_ver\u003c/span\u003e is required\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003eexit\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Cleanup .terraform\u003c/span\u003e\n\u003cspan class=\"token function\"\u003erm\u003c/span\u003e -rf .terraform/\n\n\u003cspan class=\"token comment\"\u003e# Deploy terraform\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"[Running] terraform\"\u003c/span\u003e\nterraform init -backend-config \u003cspan class=\"token assign-left variable\"\u003ebucket\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e${TERRAFORM_STATE_BUCKET_NAME}\u003c/span\u003e\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# If the workspace does not exist, create it.\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003e terraform workspace \u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token variable\"\u003e${WORKSPACE}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e terraform workspace new \u003cspan class=\"token variable\"\u003e${WORKSPACE}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\nterraform apply -auto-approve -var-file\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$VAR_FILE\u003c/span\u003e\n\n\u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# where the package.json file exist\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Build the static files\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"[Build] production version of the website]\"\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eyarn\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eyarn\u003c/span\u003e run build\n\n\u003cspan class=\"token comment\"\u003e# Upload the source code to AWS S3\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"[Upload] website content\"\u003c/span\u003e\naws s3 \u003cspan class=\"token function\"\u003erm\u003c/span\u003e s3://\u003cspan class=\"token variable\"\u003e$CLIENT_BUCKET_NAME\u003c/span\u003e/  --recursive\naws s3 \u003cspan class=\"token function\"\u003esync\u003c/span\u003e dist/ s3://\u003cspan class=\"token variable\"\u003e$CLIENT_BUCKET_NAME\u003c/span\u003e/ --exclude \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\"*.DS_Store*\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\"\naws s3 \u003cspan class=\"token function\"\u003ecp\u003c/span\u003e dist/index.html s3://\u003cspan class=\"token variable\"\u003e$CLIENT_BUCKET_NAME\u003c/span\u003e/ --cache-control max-age\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eCloudFront add a secondary failover origin\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eCreate a bucket and a CloudFront ditribution:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003evariable \u003cspan class=\"token string\"\u003e\"primary_bucket_name\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my-awesome-site\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"s3_origin_id\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"myS3Origin\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Primary Origin\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"primary_origin_website_s3_policy\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003estatement\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003esid\u003c/span\u003e       \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"bucket_policy_for_primary\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eactions\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"s3:GetObject\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eeffect\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Allow\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresources\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"arn:aws:s3:::\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003eprimary_bucket_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e/*\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprincipals\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"AWS\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eidentifiers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eaws_cloudfront_origin_access_identity.website_origin_access_identity.iam_arn\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_s3_bucket\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"primary_origin\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.primary_bucket_name\n  \u003cspan class=\"token property\"\u003eacl\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"private\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003epolicy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.aws_iam_policy_document.primary_origin_website_s3_policy.json\n\n  \u003cspan class=\"token keyword\"\u003ewebsite\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eindex_document\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index.html\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eerror_document\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"404.html\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003etags\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eforce_destroy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\n\u003cspan class=\"token comment\"\u003e# CloudFront (With single origin)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_cloudfront_origin_access_identity\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"website_origin_access_identity\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ecomment\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"site \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003eworkspace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e Access Identity\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_cloudfront_distribution\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"s3_distribution\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eorigin\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_s3_bucket.primary_origin.bucket_regional_domain_name\n    \u003cspan class=\"token property\"\u003eorigin_id\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.s3_origin_id\n\n    \u003cspan class=\"token keyword\"\u003es3_origin_config\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eorigin_access_identity\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_origin_access_identity.website_origin_access_identity.cloudfront_access_identity_path\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eenabled\u003c/span\u003e             \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eis_ipv6_enabled\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ecomment\u003c/span\u003e             \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Some comment\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault_root_object\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index.html\"\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003elogging_config\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003einclude_cookies\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"mylogs.s3.amazonaws.com\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eprefix\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"myprefix\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003ealiases\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"mysite.example.com\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"yoursite.example.com\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003edefault_cache_behavior\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eallowed_methods\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"DELETE\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"PATCH\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"PUT\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecached_methods\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_origin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.s3_origin_id\n\n    \u003cspan class=\"token keyword\"\u003eforwarded_values\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003equery_string\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\n      \u003cspan class=\"token keyword\"\u003ecookies\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003eforward\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"none\"\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token property\"\u003eviewer_protocol_policy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"allow-all\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emin_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edefault_ttl\u003c/span\u003e            \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e3600\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emax_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e86400\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# Cache behavior with precedence 0\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eordered_cache_behavior\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003epath_pattern\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/index.html\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eallowed_methods\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecached_methods\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_origin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.s3_origin_id\n\n    \u003cspan class=\"token keyword\"\u003eforwarded_values\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003equery_string\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"true\"\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003ecookies\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003eforward\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"none\"\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token property\"\u003emin_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edefault_ttl\u003c/span\u003e            \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e86400\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emax_ttl\u003c/span\u003e                \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e31536000\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecompress\u003c/span\u003e               \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eviewer_protocol_policy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"redirect-to-https\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eprice_class\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"PriceClass_200\"\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003erestrictions\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003egeo_restriction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003erestriction_type\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"none\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003etags\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eEnvironment\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"production\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eviewer_certificate\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecloudfront_default_certificate\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eNow add a second bucket in another region and update your CloudFront config block to allow for secondary origin\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# Add a bucket in another region\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"eu-west-1\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ealias\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"failover_region\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\nvariable \u003cspan class=\"token string\"\u003e\"secondary_bucket_name\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my-awesome-site-failover\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Secondary Bucket\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"secondary_origin_website_s3_policy\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eprovider\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws.failover_region\n\n  \u003cspan class=\"token keyword\"\u003estatement\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003esid\u003c/span\u003e       \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"bucket_policy_for_secondary\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eactions\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"s3:GetObject\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eeffect\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Allow\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eresources\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"arn:aws:s3:::\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003esecondary_bucket_name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e/*\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprincipals\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"AWS\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eidentifiers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eaws_cloudfront_origin_access_identity.website_origin_access_identity.iam_arn\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_s3_bucket\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"secondary_origin\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eprovider\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws.failover_region\n\n  \u003cspan class=\"token property\"\u003ebucket\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.secondary_bucket_name\n  \u003cspan class=\"token property\"\u003eacl\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"private\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003epolicy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e data.aws_iam_policy_document.secondary_origin_website_s3_policy.json\n\n  \u003cspan class=\"token keyword\"\u003ewebsite\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eindex_document\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index.html\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eerror_document\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"404.html\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003etags\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003eforce_destroy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"token comment\"\u003e# Update your cloudfront distribution\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_cloudfront_distribution\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"s3_distribution\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# Add an `origin group`\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eorigin_group\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eorigin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"OriginWithFailover\"\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003efailover_criteria\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003estatus_codes\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e403\u003c/span\u003e, \u003cspan class=\"token number\"\u003e404\u003c/span\u003e, \u003cspan class=\"token number\"\u003e500\u003c/span\u003e, \u003cspan class=\"token number\"\u003e502\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# *NOTE: this order matters! (first one will be the primary)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003emember\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eorigin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"primaryS3\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003emember\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eorigin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"failoverS3\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# Add a second origin\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eorigin\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003edomain_name\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_s3_bucket.secondary_origin.bucket_regional_domain_name\n    \u003cspan class=\"token property\"\u003eorigin_id\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"failoverS3\"\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003es3_origin_config\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eorigin_access_identity\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_cloudfront_origin_access_identity.website_origin_access_identity.cloudfront_access_identity_path\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003edefault_cache_behavior\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_origin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"OriginWithFailover\"\u003c/span\u003e\n\n    \u003cspan class=\"token property\"\u003eallowed_methods\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecached_methods\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# *...\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eordered_cache_behavior\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_origin_id\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"OriginWithFailover\"\u003c/span\u003e\n\n    \u003cspan class=\"token property\"\u003eallowed_methods\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"OPTIONS\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Note \u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecached_methods\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"HEAD\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# *...\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e# *...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eNow you can test it by uploading this below HTML to the bucket in the \u003ccode\u003eeu-west-1\u003c/code\u003e and leave the \u003ccode\u003eus-west-2\u003c/code\u003e empty for now\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003e\u003cspan class=\"token doctype\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;!\u003c/span\u003e\u003cspan class=\"token doctype-tag\"\u003edoctype\u003c/span\u003e \u003cspan class=\"token name\"\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ehtml\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003elang\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003een\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003etitle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003eeu-west-1\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003etitle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eh1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003eeu-west-1\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003eh1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eimg\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003esrc\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eimage.jpg\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eIf you go to the CloudFront URL, you should see a site that says \u003ccode\u003eeu-west-1\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eNow Add the below html to the \u003ccode\u003eus-west-2\u003c/code\u003e bucket:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003e\u003cspan class=\"token doctype\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;!\u003c/span\u003e\u003cspan class=\"token doctype-tag\"\u003edoctype\u003c/span\u003e \u003cspan class=\"token name\"\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ehtml\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003elang\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003een\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003etitle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003eus-west-2\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003etitle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eh1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003eus-west-2\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003eh1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eimg\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003esrc\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eimage.jpg\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eIf you refresh your browser you should now see \u003ccode\u003eus-west-2\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","ogImage":{"url":"/assets/covers/terraform.jpg"},"coverImage":"/assets/covers/terraform.jpg"}},"__N_SSG":true},"page":"/learn/[slug]","query":{"slug":"terraform"},"buildId":"EkTy0ofHgnF_2CImAlSoL","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>