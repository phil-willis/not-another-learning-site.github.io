<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="Not another learning site."/><meta property="og:image" content="https://og-image.now.sh/Next.js%20Blog%20Starter%20Example.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><title>Not another learning site.</title><meta property="og:image" content="/assets/covers/aws.jpg"/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/d8d6bd39d8240bb4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d8d6bd39d8240bb4.css" data-n-g=""/><link rel="preload" href="/_next/static/css/cf121497002c184d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cf121497002c184d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-779b41245c009d2a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-156acf25c3b6001c.js" defer=""></script><script src="/_next/static/chunks/664-4243e6d8b13d56da.js" defer=""></script><script src="/_next/static/chunks/pages/learn/%5Bslug%5D-f7c40571bdb12048.js" defer=""></script><script src="/_next/static/C2QjU3KTzw_2dzPJqoxa3/_buildManifest.js" defer=""></script><script src="/_next/static/C2QjU3KTzw_2dzPJqoxa3/_ssgManifest.js" defer=""></script><script src="/_next/static/C2QjU3KTzw_2dzPJqoxa3/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="min-h-screen"><main><div class="container mx-auto px-5"><div style="position:fixed;background-color:rgba(255,255,255,0.9);backdrop-filter:blur(10px);width:100%;left:0px;z-index:1000"><h2 class="text-2xl md:text-4xl font-bold tracking-tight md:tracking-tighter leading-tight mb-20 mt-8" style="padding:0;padding-left:10px;margin-bottom:20px"><a class="hover:underline" href="/">Learn</a>.</h2></div><article class="mb-32"><div style="height:100px"></div><h1 class="text-6xl md:text-7xl lg:text-8xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">aws</h1><div class="mb-8 md:mb-16 sm:mx-0"><div class="sm:mx-0"><img src="/assets/covers/aws.jpg" alt="Cover Image for aws" class="shadow-sm" layout="responsive" width="1240" height="620"/></div></div><div class="max-w-2xl mx-auto"><div class="block md:hidden mb-6"><div>TODO: add language chip here</div></div></div><div class="max-w-2xl mx-auto"><div class="markdown-styles_markdown__h_8de"><details>
<summary>AWS CLI</summary>
<ul>
<li>Installing the AWS CLI <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">Docs here</a></li>
<li>For macOS <a href="https://awscli.amazonaws.com/AWSCLIV2.pkg">download</a>
<ul>
<li>You can install to any folder, or choose the recommended default folder of <code>/usr/local/aws-cli</code>.</li>
<li>The installer automatically creates a symlink at <code>/usr/local/bin/aws</code> that links to the main program in the installation folder you chose.</li>
</ul>
</li>
<li>Check to see if it's installed properly
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ <span class="token function">which</span> aws
/usr/local/bin/aws 
$ aws --version
aws-cli/2.4.5 Python/3.8.8 Darwin/18.7.0 botocore/2.4.5
</code></pre></div>
</li>
<li>You can access your AWS services via (<a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html">more on profiles here</a>):
<ol>
<li>Named profiles</li>
</ol>
<ul>
<li>
<p>AWS uses <code>~./aws/credentials</code> file for accessing your AWS accounts where you can have multiple profiles but you should probably have a <code>default</code> profile</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token punctuation">[</span>default<span class="token punctuation">]</span>
<span class="token assign-left variable">aws_access_key_id</span><span class="token operator">=</span>AAAAAAAAAAAAAEXAMPLE
<span class="token assign-left variable">aws_secret_access_key</span><span class="token operator">=</span><span class="token number">123456789123456789</span>

<span class="token punctuation">[</span>user1<span class="token punctuation">]</span>
<span class="token assign-left variable">aws_access_key_id</span><span class="token operator">=</span>BBBBBBBBBBBBBEXAMPLE
<span class="token assign-left variable">aws_secret_access_key</span><span class="token operator">=</span><span class="token number">12345678923456789</span>
</code></pre></div>
</li>
<li>
<p>You can also define the default regions for each profile in <code>~/.aws/config</code></p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token punctuation">[</span>default<span class="token punctuation">]</span>
<span class="token assign-left variable">region</span><span class="token operator">=</span>us-west-2
<span class="token assign-left variable">output</span><span class="token operator">=</span>json

<span class="token punctuation">[</span>profile user1<span class="token punctuation">]</span>
<span class="token assign-left variable">region</span><span class="token operator">=</span>us-east-1
<span class="token assign-left variable">output</span><span class="token operator">=</span>text
</code></pre></div>
</li>
<li>
<p>List profiles</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ aws configure list-profiles
$ aws configure list
</code></pre></div>
</li>
<li>
<p>Accessing a specific profile's resources you just have to pass in the <code>--profile &#x3C;PROFILE_NAME></code></p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ aws s3 <span class="token function">ls</span> --profile default
</code></pre></div>
</li>
</ul>
<ol start="2">
<li>Environment variables</li>
</ol>
<ul>
<li>You can also pass in environment variables access key/secrets
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_ACCESS_KEY_ID</span><span class="token operator">=</span>BBBBBBBBBBBBBEXAMPLE
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_SECRET_ACCESS_KEY</span><span class="token operator">=</span><span class="token number">12345678923456789</span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_DEFAULT_REGION</span><span class="token operator">=</span>us-west-2
</code></pre></div>
</li>
</ul>
</li>
<li>Now, getting your <code>AWS_ACCESS_KEY_ID</code> &#x26; <code>AWS_SECRET_ACCESS_KEY</code> values
<ol>
<li>Go to Amazon Web Services console and click on the name of your account (it is located in the top right corner of the console). Then, in the expanded drop-down list, select <code>Security Credentials</code>.
<img src="/assets/blog/aws/credentials_1.jpg" alt="Security Page"></li>
<li>Click the <code>Access keys (access key ID and secret access key)</code> accordion title and click <code>Create New Access Key</code>
<img src="/assets/blog/aws/credentials_2.jpg" alt="Security Page"></li>
<li>Click <code>Show Access Key</code> to have it displayed on the screen. Note, that you can download it to your machine as a file and open it whenever needed. To download it, just click the <code>Download Key File</code> button.
<img src="/assets/blog/aws/credentials_2.jpg" alt="Security Page"></li>
<li>Now update your <code>~/.aws/credentials</code> file with this key pair</li>
</ol>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token punctuation">[</span>default<span class="token punctuation">]</span>
<span class="token assign-left variable">aws_access_key_id</span><span class="token operator">=</span>AAAAAAAAAAAAAEXAMPLE
<span class="token assign-left variable">aws_secret_access_key</span><span class="token operator">=</span><span class="token number">123456789123456789</span>
</code></pre></div>
</li>
</ul>
</details>
<details>
<summary>S3</summary>
- AWS Lambda provides various ways to access secrets or sensitive data securely. Here are a few of the most common methods:
<ol>
<li>
<p><code>AWS Systems Manager Parameter Store</code>: This is a managed service that lets you store and retrieve secrets, such as database credentials and API keys. You can access the secrets in a Lambda function by using the AWS Systems Manager API, AWS CLI, or SDK.</p>
</li>
<li>
<p><code>AWS Secrets Manager</code>: This is a fully managed service that enables you to store, rotate, and retrieve secrets securely. You can access the secrets in a Lambda function by using the AWS Secrets Manager API, AWS CLI, or SDK.</p>
</li>
<li>
<p><code>Environment Variables</code>: You can store secrets as environment variables in a Lambda function. These secrets are encrypted and protected by the Lambda service-linked role.</p>
</li>
<li>
<p><code>IAM Role</code>: You can assign an IAM role to a Lambda function that has permissions to access the secrets. For example, you can assign a role that has read-only access to the secrets stored in AWS Secrets Manager or the AWS Systems Manager Parameter Store.</p>
</li>
</ol>
<ul>
<li>Regardless of the method you choose, it's important to ensure that the secrets are stored securely and protected from unauthorized access. You should also consider rotating the secrets on a regular basis and limiting the permissions of the roles and services that access the secrets.</li>
</ul>
</details>
<details>
<summary>IAM</summary>
<h1>IAM (Identity and Access Management)</h1>
<ul>
<li><code>AWS IAM</code> is a web service that helps you securely control access to AWS resources. IAM enables you to manage users, groups, and permissions to AWS resources. With IAM, you can create and manage AWS users and groups, and use permissions to allow and deny access to AWS resources.</li>
<li>An <code>AWS policy </code>is a document that defines one or more permissions. AWS policies are written in JSON and specify the actions that a user, group, or role is allowed or denied to perform on AWS resources. For example, you can create a policy that allows a user to perform only read operations on Amazon S3 buckets, or a policy that allows a group to launch EC2 instances.</li>
<li>Policies can be attached to AWS users, groups, or roles. When a policy is attached to a user, it defines what that user can do in the AWS environment. When a policy is attached to a group, it defines the permissions for all users in that group. When a policy is attached to a role, it defines the permissions for applications or services that assume the role.</li>
<li>AWS provides a number of managed policies that you can use as building blocks for your policies. For example, the AmazonS3ReadOnlyAccess policy provides read-only access to Amazon S3 buckets. You can also create custom policies, either by creating a new policy from scratch or by modifying an existing policy.</li>
<li>Here's an example of a simple AWS policy to allow read access to an Amazon S3 bucket:
<div class="remark-highlight"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span>
                <span class="token string">"s3:ListBucket"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:s3:::&#x3C;YOUR_BUCKET_NAME>"</span><span class="token punctuation">,</span>
                <span class="token string">"arn:aws:s3:::&#x3C;YOUR_BUCKET_NAME>/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>This policy uses the "Effect" of "Allow" to specify that the policy allows read access to the S3 bucket. The "Action" section lists the specific S3 actions that are allowed (s3:GetObject and s3:ListBucket), and the "Resource" section specifies the ARN (Amazon Resource Name) of the S3 bucket and its contents (&#x3C;YOUR_BUCKET_NAME> and &#x3C;YOUR_BUCKET_NAME>/*).</li>
<li>Note that in the &#x3C;YOUR_BUCKET_NAME> placeholder in the ARN, you would replace it with the actual name of the S3 bucket you want to grant read access to.</li>
<li>You can attach this policy to an IAM user, group, or role to grant read access to the specified S3 bucket.</li>
</ul>
</details>
<details>
<summary>S3</summary>
<h1>S3</h1>
<ul>
<li>Storage</li>
</ul>
</details>
<details>
<summary>CloudWatch</summary>
<h1>CloudWatch</h1>
<ul>
<li>CloudWatch enables you to monitor your complete stack (applications, infrastructure, network, and services) and use alarms, logs, and events data to take automated actions and reduce mean time to resolution (MTTR). This frees up important resources and allows you to focus on building applications and business value.</li>
<li>You can create Dashboards, Alarms, or just query the logs</li>
</ul>
<h2>Logs</h2>
<ul>
<li>You have 2 options: <code>Log Goups</code> or <code>Log Insights</code></li>
<li><code>Log Insights</code> is better</li>
<li>Select a log group(s) then run a query
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">fields @timestamp, @message, @logStream, @log
| sort @timestamp desc
| limit 20</code></pre></div>
</li>
<li>Allowed filtering options are:
<div class="remark-highlight"><pre class="language-html"><code class="language-html">'in', 'and', 'or', 'not', 'like', '=~', '~=', '|', '|>', '^', '*', '/', '%', '+', '-', '<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>',</span> <span class="token attr-name">'</span><span class="token punctuation">></span></span>', '&#x3C;=', '>=', '=', '!='
</code></pre></div>
</li>
<li>You can also regex console.log event you've done in your Lambdas like:
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">fields @timestamp, @message, @logStream, @log
| sort @timestamp desc
| filter @message like /????/
| limit 20</code></pre></div>
</li>
<li>Learn more about queries <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax-examples.html">here</a></li>
</ul>
</details>
<details>
<summary>CLoudFront</summary>
<h1>CLoudFront</h1>
<ul>
<li>Distribute your static content at AWS edge locations</li>
</ul>
</details>
<details>
<summary>ACM</summary>
<h1>ACM</h1>
<ul>
<li>AWS Certificate Manager is a service provided by Amazon that issues on-demand TLS certificates at no cost. Much like Let’s Encrypt, Amazon controls the Certificate Authority (Amazon Trust Services, LLC) behind the certificates, as well as the accompanying API to manage them.</li>
<li>Amazon Certificate Manager (ACM) provides an elegant wayt to convert  a cumbersome multi-step process (the process of provisioning, validating, and configuring Transport Layer Security (TLS) certificates) into a single step</li>
<li>ACM certificates can only be associated with AWS Elastic and Application Load Balancers, CloudFront distributions, and API Gateway endpoints.</li>
</ul>
</details>
<details>
<summary>Route53</summary>
<h1>Route53</h1>
<ul>
<li>Route end users to your site reliably with globally-dispersed Domain Name System (DNS) servers and automatic scaling.</li>
</ul>
</details>
<details>
<summary>API Gateway</summary>
<h1>API Gateway</h1>
<ul>
<li>
<p>Allows you to make RESTful applications</p>
</li>
<li>
<p>There's 4 types of API Gateway offering:</p>
<ul>
<li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api.html">HTTP API</a></li>
<li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-rest-api.html">REST API</a></li>
<li>REST API (private)</li>
<li>WebSocket API</li>
</ul>
</li>
<li>
<p><code>REST APIs </code>support more features than <code>HTTP APIs</code>, while <code>HTTP APIs</code> are designed with minimal features so that they can be offered at a lower price. You can read more <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-vs-rest.html">here</a></p>
</li>
<li>
<p>When you add a new endpoint you have to create a <code>resource</code> then add the http <code>methods</code> you want</p>
</li>
</ul>
<h2>Custom Authorizer</h2>
<ul>
<li>
<p><a href="https://www.alexdebrie.com/posts/lambda-custom-authorizers/">Here's a great writeup on Lambda Custom Authorizers</a></p>
</li>
<li>
<p>API Gateway provides an HTTP API endpoint that is fully configurable. You define the HTTP resources (like /user), the HTTP methods on that resources (like POST, GET, DELETE, …) and the integration (e.g. Lambda function) that should be called to process the request. A Lambda function can then run whatever logic is needed to answer the request. The Lambda function returns its result to the API Gateway. The API Gateway responds to the caller. The following figure demonstrates this flow.
<img src="/assets/blog/aws/api-gateway-flow.jpg" alt="api-gateway-flow"></p>
</li>
<li>
<p>You could include the authentication and authorization logic into the Lambda function that handles the request. But you can also separate concerns, make use of API Gateway caching mechanism, and go for Custom Authorization. API Gateway will invoke another Lambda function (Auth Lambda Function) for the first request and caches that result for a configurable duration. Caching will reduce the overhead (latency and DynamoDB charges) for authentication and authorization to a minimum.
<img src="/assets/blog/aws/api-gateway-flow_custom-authorizer.jpg" alt="api-gateway-flow_custom-authorizer"></p>
</li>
<li>
<p>You can use whatever logic you like to decide if a request is allowed or not. Here I will implement an API token mechanism. All HTTP requests from clients must pass an Authorization: xyz header. The Auth Lambda Function will take this token to query a DynamoDB table. The request is allowed or denied depending on if the query matches.</p>
</li>
<li>
<p>The code for the Auth Lambda Function is responsible for looking up the token. The Authorization HTTP header field is used to transmit the token. You can use Node.js and the AWS SDK for JavaScript to implement this logic. API Gateway will pass an event to our function like this:</p>
<div class="remark-highlight"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"TOKEN"</span><span class="token punctuation">,</span>
  <span class="token property">"authorizationToken"</span><span class="token operator">:</span><span class="token string">"&#x3C;caller-supplied-token>"</span><span class="token punctuation">,</span>
  <span class="token property">"methodArn"</span><span class="token operator">:</span><span class="token string">"arn:aws:execute-api:&#x3C;regionId>:&#x3C;accountId>:&#x3C;apiId>/&#x3C;stage>/&#x3C;method>/&#x3C;resourcePath>"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p>API Gateway expects that we respond in the following way:</p>
<div class="remark-highlight"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"principalId"</span><span class="token operator">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span>
  <span class="token property">"policyDocument"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"execute-api:Invoke"</span><span class="token punctuation">,</span>
        <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span> <span class="token comment">// or Deny</span>
        <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:execute-api:&#x3C;regionId>:&#x3C;accountId>:&#x3C;apiId>/&#x3C;stage>/&#x3C;method>/&#x3C;resourcePath>"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>
<p>A simple implementation looks like this:</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token constant">AWS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'aws-sdk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> dynamodb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWS<span class="token punctuation">.</span>DynamoDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">generatePolicy</span><span class="token punctuation">(</span><span class="token parameter">principalId<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> resource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'principalId'</span><span class="token operator">:</span> principalId<span class="token punctuation">,</span>
    <span class="token string-property property">'policyDocument'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'Version'</span><span class="token operator">:</span> <span class="token string">'2012-10-17'</span><span class="token punctuation">,</span>
      <span class="token string-property property">'Statement'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token string-property property">'Action'</span><span class="token operator">:</span> <span class="token string">'execute-api:Invoke'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'Effect'</span><span class="token operator">:</span> effect<span class="token punctuation">,</span>
        <span class="token string-property property">'Resource'</span><span class="token operator">:</span> resource
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">handler</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> token <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token property-access">authorizationToken</span><span class="token punctuation">;</span>
  dynamodb<span class="token punctuation">.</span><span class="token method function property-access">getItem</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string-property property">"Key"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"token"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"S"</span><span class="token operator">:</span> token<span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"TableName"</span><span class="token operator">:</span> <span class="token string">"auth-token"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Item</span></span> <span class="token operator">===</span> <span class="token keyword nil">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token function">generatePolicy</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'Deny'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token property-access">methodArn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token function">generatePolicy</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'Allow'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token property-access">methodArn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
</li>
<li>
<p>More on Lambda authorizer <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-use-lambda-authorizer.html">here</a></p>
</li>
</ul>
</details>
<details>
<summary>Lambda</summary>
<h1>Lambda</h1>
<ul>
<li>Serverless functions</li>
</ul>
</details>
<details>
<summary>Elastic Container Registry (ECR) </summary>
<h1>ECR</h1>
<ul>
<li>ECR is your own Docker repository where you can push images up to your AWS account</li>
<li>Lets create a simple registry and add a docker container
<ol>
<li>Create a Node.js application e.g. <code>$ yarn create nest</code></li>
<li>Create a docker file, <code>./Dockerfile</code></li>
</ol>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">FROM node:18-alpine
WORKDIR /user/src/app
COPY <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span>
RUN <span class="token function">rm</span> -rf node_modules <span class="token operator">&#x26;&#x26;</span> <span class="token function">yarn</span> <span class="token function">install</span> --frozen-lockfile
RUN <span class="token function">yarn</span> build
<span class="token environment constant">USER</span> <span class="token function">node</span>
CMD <span class="token punctuation">[</span><span class="token string">"npm"</span>, <span class="token string">"run"</span>, <span class="token string">"start:prod"</span><span class="token punctuation">]</span>
</code></pre></div>
<ol start="2">
<li>Create the AWS ECR</li>
</ol>
<ul>
<li><a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/getting-started-cli.html">AWS Docs</a>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token assign-left variable">REPO_NAME</span><span class="token operator">=</span><span class="token string">"meee/nestjs-api"</span>
<span class="token assign-left variable">AWS_REGION</span><span class="token operator">=</span><span class="token string">"us-west-2"</span>
aws ecr create-repository <span class="token punctuation">\</span>
    --repository-name <span class="token variable">$REPO_NAME</span> <span class="token punctuation">\</span>
    --image-scanning-configuration <span class="token assign-left variable">scanOnPush</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
    --region <span class="token variable">$AWS_REGION</span>
</code></pre></div>
</li>
<li>Or with Terraform
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">provider<span class="token type variable"> "aws" </span></span><span class="token punctuation">{</span>
  <span class="token property">region</span>  <span class="token punctuation">=</span> <span class="token string">"us-west-2"</span>
<span class="token punctuation">}</span>

<span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token keyword">required_providers</span> <span class="token punctuation">{</span>
    <span class="token property">aws</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">"hashicorp/aws"</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">"~> 4.16"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token property">required_version</span> <span class="token punctuation">=</span> <span class="token string">">= 1.0.10"</span>
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> "ecr_registry_name" </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span> <span class="token punctuation">=</span> string
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_ecr_repository"</span></span> <span class="token string">"ecr_repo"</span> <span class="token punctuation">{</span>
    <span class="token property">name</span> <span class="token punctuation">=</span> var.ecr_registry_name
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<ol start="3">
<li>Create a build/deploy script</li>
</ol>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token comment"># Variables</span>
<span class="token assign-left variable">IMAGE_TAG</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">node</span> -p -e <span class="token string">"require('./package.json').version"</span><span class="token variable">)</span></span>
<span class="token assign-left variable">AWS_REGION</span><span class="token operator">=</span><span class="token string">"us-west-2"</span>
<span class="token assign-left variable">IMAGE_NAME</span><span class="token operator">=</span><span class="token string">"nike/nestjs-api"</span>
<span class="token assign-left variable">ACCOUNT_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>aws sts get-caller-identity <span class="token operator">|</span> jq -r <span class="token string">".Account"</span><span class="token variable">)</span></span>
<span class="token assign-left variable">REPOSITORY_URI</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$ACCOUNT_ID</span>.dkr.ecr.us-west-2.amazonaws.com"</span>
<span class="token assign-left variable">ECR_NAME</span><span class="token operator">=</span><span class="token string">"ecr_example_repo"</span>

<span class="token comment"># Check to see if version already exist</span>
<span class="token assign-left variable">NODE_V</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq <span class="token string">".version"</span> package.json<span class="token variable">)</span></span>
<span class="token keyword">for</span> <span class="token for-or-select variable">element</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span>aws ecr list-images --repository-name $IMAGE_NAME <span class="token operator">|</span> jq .imageIds<span class="token punctuation">[</span><span class="token punctuation">]</span>.imageTag<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$element</span>"</span> <span class="token operator">==</span> <span class="token string">"<span class="token variable">$NODE_V</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
    <span class="token builtin class-name">echo</span> <span class="token string">"[Error] Version <span class="token variable"><span class="token variable">`</span>$<span class="token punctuation">{</span>element<span class="token punctuation">}</span><span class="token variable">`</span></span> Already exist in the remote registry, update your package.json version"</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
  <span class="token keyword">fi</span>
<span class="token keyword">done</span>

<span class="token comment"># Build your image</span>
<span class="token function">yarn</span> build
<span class="token function">docker</span> build -t <span class="token string">"<span class="token variable">$IMAGE_NAME</span>:<span class="token variable">$IMAGE_TAG</span>"</span> <span class="token builtin class-name">.</span>
<span class="token function">docker</span> build -t <span class="token string">"<span class="token variable">$REPOSITORY_URI</span>/<span class="token variable">$IMAGE_NAME</span>:latest"</span> <span class="token builtin class-name">.</span>
<span class="token function">docker</span> build -t <span class="token string">"<span class="token variable">$REPOSITORY_URI</span>/<span class="token variable">$IMAGE_NAME</span>:<span class="token variable">$IMAGE_TAG</span>"</span> <span class="token builtin class-name">.</span>

<span class="token comment"># Create Infrastructure</span>
<span class="token function">pushd</span> pipelines/terraform
terraform init
terraform apply -auto-approve -var <span class="token assign-left variable">ecr_registry_name</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$IMAGE_NAME</span>"</span>
<span class="token function">popd</span>

<span class="token comment"># Authenticating to Docker</span>
aws ecr get-login-password --region <span class="token variable">$AWS_REGION</span> <span class="token operator">|</span> <span class="token function">docker</span> login --username AWS --password-stdin <span class="token string">"<span class="token variable">$ACCOUNT_ID</span>.dkr.ecr.<span class="token variable">$AWS_REGION</span>.amazonaws.com"</span>

<span class="token comment"># Push to the repository</span>
<span class="token function">docker</span> push <span class="token string">"<span class="token variable">$ACCOUNT_ID</span>.dkr.ecr.us-west-2.amazonaws.com/<span class="token variable">$IMAGE_NAME</span>:<span class="token variable">$IMAGE_TAG</span>"</span>
<span class="token function">docker</span> push <span class="token string">"<span class="token variable">$ACCOUNT_ID</span>.dkr.ecr.us-west-2.amazonaws.com/<span class="token variable">$IMAGE_NAME</span>:latest"</span>
</code></pre></div>
</li>
</ul>
</details>
<details>
<summary>Elastic Container Service (ECS)</summary>
<h1>ECS</h1>
<ul>
<li>ECS is a fully managed container orchestration service. AWS ECS is a fantastic service for running your containers.</li>
<li>ECS Fargate, as this is a serverless compute service that allows you to run containers without provisioning servers.</li>
</ul>
<ol>
<li>Create a cluster go <a href="https://us-west-2.console.aws.amazon.com/ecs/v2/clusters?region=us-west-2">here</a> to see all your clusters</li>
</ol>
<ul>
<li>Add this to your TF files and run
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"aws_ecs_cluster"</span></span> <span class="token string">"my_cluster"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span> <span class="token punctuation">=</span> var.cluster_name
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>You should then see your new cluster in AWS</li>
</ul>
<ol start="2">
<li>Create a Task</li>
</ol>
<ul>
<li>Notice how we specify the image by referencing the repository URL of our other terraform resource.</li>
<li>Also notice how we provide the port mapping of 3000.</li>
<li>We also create an IAM role so that tasks have the correct permissions to execute.</li>
<li>If you click Task Definitions in AWS ECS, you should see your new task:</li>
<li>Add the following code:
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># Cluster</span>
<span class="token keyword">resource <span class="token type variable">"aws_ecs_cluster"</span></span> <span class="token string">"my_cluster"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span> <span class="token punctuation">=</span> var.cluster_name
<span class="token punctuation">}</span>


<span class="token keyword">variable<span class="token type variable"> "task_name" </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span> <span class="token punctuation">=</span> string
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">"(optional) describe your variable"</span>
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">"my-first-task"</span>
<span class="token punctuation">}</span>


<span class="token comment"># Task definition</span>
<span class="token keyword">resource <span class="token type variable">"aws_ecs_task_definition"</span></span> <span class="token string">"my_first_task"</span> <span class="token punctuation">{</span>
  <span class="token property">family</span>                   <span class="token punctuation">=</span> var.task_name
  <span class="token property">container_definitions</span>    <span class="token punctuation">=</span> <span class="token heredoc string">&#x3C;&#x3C;DEFINITION</span>
<span class="token heredoc string">  [</span>
<span class="token heredoc string">    {</span>
<span class="token heredoc string">      "name": "${var.task_name}",</span>
<span class="token heredoc string">      "image": "${aws_ecr_repository.ecr_repo.repository_url}",</span>
<span class="token heredoc string">      "essential": true,</span>
<span class="token heredoc string">      "portMappings": [</span>
<span class="token heredoc string">        {</span>
<span class="token heredoc string">          "containerPort": 3000,</span>
<span class="token heredoc string">          "hostPort": 3000</span>
<span class="token heredoc string">        }</span>
<span class="token heredoc string">      ],</span>
<span class="token heredoc string">      "memory": 512,</span>
<span class="token heredoc string">      "cpu": 256</span>
<span class="token heredoc string">    }</span>
<span class="token heredoc string">  ]</span>
<span class="token heredoc string">  DEFINITION</span>
  <span class="token property">requires_compatibilities</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"FARGATE"</span><span class="token punctuation">]</span> <span class="token comment"># Stating that we are using ECS Fargate</span>
  <span class="token property">network_mode</span>             <span class="token punctuation">=</span> <span class="token string">"awsvpc"</span>    <span class="token comment"># Using awsvpc as our network mode as this is required for Fargate</span>
  <span class="token property">memory</span>                   <span class="token punctuation">=</span> <span class="token number">512</span>         <span class="token comment"># Specifying the memory our container requires</span>
  <span class="token property">cpu</span>                      <span class="token punctuation">=</span> <span class="token number">256</span>         <span class="token comment"># Specifying the CPU our container requires</span>
  <span class="token property">execution_role_arn</span>       <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_iam_role<span class="token punctuation">.</span>ecsTaskExecutionRole<span class="token punctuation">.</span>arn<span class="token punctuation">}</span></span>"</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_iam_role"</span></span> <span class="token string">"ecsTaskExecutionRole"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>               <span class="token punctuation">=</span> <span class="token string">"ecsTaskExecutionRole"</span>
  <span class="token property">assume_role_policy</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">data</span><span class="token punctuation">.</span><span class="token type variable">aws_iam_policy_document</span><span class="token punctuation">.</span>assume_role_policy<span class="token punctuation">.</span>json<span class="token punctuation">}</span></span>"</span>
<span class="token punctuation">}</span>

<span class="token keyword">data <span class="token type variable">"aws_iam_policy_document"</span></span> <span class="token string">"assume_role_policy"</span> <span class="token punctuation">{</span>
  <span class="token keyword">statement</span> <span class="token punctuation">{</span>
    <span class="token property">actions</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"sts:AssumeRole"</span><span class="token punctuation">]</span>

    <span class="token keyword">principals</span> <span class="token punctuation">{</span>
      <span class="token property">type</span>        <span class="token punctuation">=</span> <span class="token string">"Service"</span>
      <span class="token property">identifiers</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"ecs-tasks.amazonaws.com"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_iam_role_policy_attachment"</span></span> <span class="token string">"ecsTaskExecutionRole_policy"</span> <span class="token punctuation">{</span>
  <span class="token property">role</span>       <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_iam_role<span class="token punctuation">.</span>ecsTaskExecutionRole<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span>"</span>
  <span class="token property">policy_arn</span> <span class="token punctuation">=</span> <span class="token string">"arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<ol start="3">
<li>Create VPC</li>
</ol>
<ul>
<li>As we are using Fargate, our tasks need to specify that the network mode is awsvpc.</li>
<li>As a result, we need to extend our service to include a network configuration.</li>
<li>You may have not known it yet, but our cluster was automatically deployed into your account’s default VPC.</li>
<li>However, for a service, this needs to be explicitly stated, even if we wish to continue using the default VPC and subnets.</li>
<li>First, we need to create reference resources to the default VPC and subnets so that they can be referenced by our other resources:
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"aws_default_vpc"</span></span> <span class="token string">"default"</span> <span class="token punctuation">{</span>
  <span class="token property">tags</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">Name</span> <span class="token punctuation">=</span> <span class="token string">"Default VPC"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># Providing a reference to our default VPC</span>
<span class="token keyword">resource <span class="token type variable">"aws_default_vpc"</span></span> <span class="token string">"default_vpc"</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment"># Providing a reference to our default subnets</span>
<span class="token keyword">resource <span class="token type variable">"aws_default_subnet"</span></span> <span class="token string">"default_subnet_a"</span> <span class="token punctuation">{</span>
  <span class="token property">availability_zone</span> <span class="token punctuation">=</span> <span class="token string">"eu-west-2a"</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_default_subnet"</span></span> <span class="token string">"default_subnet_b"</span> <span class="token punctuation">{</span>
  <span class="token property">availability_zone</span> <span class="token punctuation">=</span> <span class="token string">"eu-west-2b"</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_default_subnet"</span></span> <span class="token string">"default_subnet_c"</span> <span class="token punctuation">{</span>
  <span class="token property">availability_zone</span> <span class="token punctuation">=</span> <span class="token string">"eu-west-2c"</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
</ul>
<ol start="3">
<li>Create a service</li>
</ol>
<ul>
<li>time to create the service, notice that we are using the VPC define above
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># Service</span>
<span class="token keyword">resource <span class="token type variable">"aws_ecs_service"</span></span> <span class="token string">"my_service"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>            <span class="token punctuation">=</span> var.app_name                     <span class="token comment"># Naming our first service</span>
  <span class="token property">cluster</span>         <span class="token punctuation">=</span> aws_ecs_cluster.cluster.id       <span class="token comment"># Referencing our created Cluster</span>
  <span class="token property">task_definition</span> <span class="token punctuation">=</span> aws_ecs_task_definition.task.arn <span class="token comment"># Referencing the task our service will spin up</span>
  <span class="token property">launch_type</span>     <span class="token punctuation">=</span> <span class="token string">"FARGATE"</span>
  <span class="token property">desired_count</span>   <span class="token punctuation">=</span> <span class="token number">2</span> <span class="token comment"># Setting the number of containers we want deployed to 2</span>


  <span class="token keyword">network_configuration</span> <span class="token punctuation">{</span>
    <span class="token property">subnets</span>          <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_default_subnet<span class="token punctuation">.</span>default_subnet_a<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span>, <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_default_subnet<span class="token punctuation">.</span>default_subnet_b<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span>, <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_default_subnet<span class="token punctuation">.</span>default_subnet_c<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span><span class="token punctuation">]</span>
    <span class="token property">assign_public_ip</span> <span class="token punctuation">=</span> <span class="token boolean">true</span> <span class="token comment"># Providing our containers with public IPs</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li></li>
</ul>
<ol start="4">
<li>Final step is to create a Load Balancer</li>
</ol>
<ul>
<li>Add this code to your TF files
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"aws_alb"</span></span> <span class="token string">"application_load_balancer"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>               <span class="token punctuation">=</span> var.app_name <span class="token comment"># Naming our load balancer</span>
  <span class="token property">load_balancer_type</span> <span class="token punctuation">=</span> <span class="token string">"application"</span>
  <span class="token property">subnets</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span> <span class="token comment"># Referencing the default subnets</span>
    <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_default_subnet<span class="token punctuation">.</span>default_subnet_a<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span>,
    <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_default_subnet<span class="token punctuation">.</span>default_subnet_b<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span>,
    <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_default_subnet<span class="token punctuation">.</span>default_subnet_c<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span>
  <span class="token punctuation">]</span>
  <span class="token comment"># Referencing the security group</span>
  <span class="token property">security_groups</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_security_group<span class="token punctuation">.</span>load_balancer_security_group<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment"># Creating a security group for the load balancer:</span>
<span class="token keyword">resource <span class="token type variable">"aws_security_group"</span></span> <span class="token string">"load_balancer_security_group"</span> <span class="token punctuation">{</span>
  <span class="token keyword">ingress</span> <span class="token punctuation">{</span>
    <span class="token property">from_port</span>   <span class="token punctuation">=</span> <span class="token number">80</span> <span class="token comment"># Allowing traffic in from port 80</span>
    <span class="token property">to_port</span>     <span class="token punctuation">=</span> <span class="token number">80</span>
    <span class="token property">protocol</span>    <span class="token punctuation">=</span> <span class="token string">"tcp"</span>
    <span class="token property">cidr_blocks</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span> <span class="token comment"># Allowing traffic in from all sources</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">egress</span> <span class="token punctuation">{</span>
    <span class="token property">from_port</span>   <span class="token punctuation">=</span> <span class="token number">0</span> <span class="token comment"># Allowing any incoming port</span>
    <span class="token property">to_port</span>     <span class="token punctuation">=</span> <span class="token number">0</span> <span class="token comment"># Allowing any outgoing port</span>
    <span class="token property">protocol</span>    <span class="token punctuation">=</span> <span class="token string">"-1"</span> <span class="token comment"># Allowing any outgoing protocol </span>
    <span class="token property">cidr_blocks</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span> <span class="token comment"># Allowing traffic out to all IP addresses</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>To direct traffic we need to create a target group and listener. Each target group is used to route requests to one or more registered targets (in our case, containers).</li>
<li>Add this code to your TF files
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># Target Group and listener</span>
<span class="token keyword">resource <span class="token type variable">"aws_lb_target_group"</span></span> <span class="token string">"target_group"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>        <span class="token punctuation">=</span> <span class="token string">"target-group"</span>
  <span class="token property">port</span>        <span class="token punctuation">=</span> <span class="token number">80</span>
  <span class="token property">protocol</span>    <span class="token punctuation">=</span> <span class="token string">"HTTP"</span>
  <span class="token property">target_type</span> <span class="token punctuation">=</span> <span class="token string">"ip"</span>
  <span class="token property">vpc_id</span>      <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_default_vpc<span class="token punctuation">.</span>default_vpc<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span> <span class="token comment"># Referencing the default VPC</span>
  <span class="token keyword">health_check</span> <span class="token punctuation">{</span>
    <span class="token property">matcher</span> <span class="token punctuation">=</span> <span class="token string">"200,301,302"</span>
    <span class="token property">path</span> <span class="token punctuation">=</span> <span class="token string">"/"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">"aws_lb_listener"</span></span> <span class="token string">"listener"</span> <span class="token punctuation">{</span>
  <span class="token property">load_balancer_arn</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_alb<span class="token punctuation">.</span>application_load_balancer<span class="token punctuation">.</span>arn<span class="token punctuation">}</span></span>"</span> <span class="token comment"># Referencing our load balancer</span>
  <span class="token property">port</span>              <span class="token punctuation">=</span> <span class="token string">"80"</span>
  <span class="token property">protocol</span>          <span class="token punctuation">=</span> <span class="token string">"HTTP"</span>
  <span class="token keyword">default_action</span> <span class="token punctuation">{</span>
    <span class="token property">type</span>             <span class="token punctuation">=</span> <span class="token string">"forward"</span>
    <span class="token property">target_group_arn</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_lb_target_group<span class="token punctuation">.</span>target_group<span class="token punctuation">.</span>arn<span class="token punctuation">}</span></span>"</span> <span class="token comment"># Referencing our tagrte group</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>Now if you go to EC2 then click on <code>Load Balancer</code></li>
<li>If you view the Listeners tab of your load balancer, you should see a listener that forwards traffic to your target group:</li>
<li>We now have to tell your <code>aws_ecs_service</code> about this load balancer
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">"aws_ecs_service"</span></span> <span class="token string">"my_service"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>            <span class="token punctuation">=</span> var.app_name                     <span class="token comment"># Naming our first service</span>
  <span class="token comment"># ...</span>
  
  <span class="token keyword">load_balancer</span> <span class="token punctuation">{</span>
    <span class="token property">target_group_arn</span> <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_lb_target_group<span class="token punctuation">.</span>target_group<span class="token punctuation">.</span>arn<span class="token punctuation">}</span></span>"</span> <span class="token comment"># Referencing our target group</span>
    <span class="token property">container_name</span>   <span class="token punctuation">=</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_ecs_task_definition<span class="token punctuation">.</span>my_first_task<span class="token punctuation">.</span>family<span class="token punctuation">}</span></span>"</span>
    <span class="token property">container_port</span>   <span class="token punctuation">=</span> <span class="token number">3000</span> <span class="token comment"># Specifying the container port</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
</li>
<li>ECS service does not allow traffic in by default. We can change this by creating a security group for the ECS service that allows traffic only from the application load balancer security group:</li>
</ul>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token comment"># Service</span>
<span class="token keyword">resource <span class="token type variable">"aws_ecs_service"</span></span> <span class="token string">"service"</span> <span class="token punctuation">{</span>
  <span class="token property">name</span>            <span class="token punctuation">=</span> var.app_name                     <span class="token comment"># Naming our first service</span>
  <span class="token comment"># ...</span>
  <span class="token keyword">network_configuration</span> <span class="token punctuation">{</span>
    <span class="token comment"># ...</span>
    <span class="token property">security_groups</span>  <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_security_group<span class="token punctuation">.</span>service_security_group<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span><span class="token punctuation">]</span> <span class="token comment"># Setting the security group</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token comment"># Security Group</span>
<span class="token keyword">resource <span class="token type variable">"aws_security_group"</span></span> <span class="token string">"service_security_group"</span> <span class="token punctuation">{</span>
  <span class="token keyword">ingress</span> <span class="token punctuation">{</span>
    <span class="token property">from_port</span> <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">to_port</span>   <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token property">protocol</span>  <span class="token punctuation">=</span> <span class="token string">"-1"</span>
    <span class="token comment"># Only allowing traffic in from the load balancer security group</span>
    <span class="token property">security_groups</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>aws_security_group<span class="token punctuation">.</span>load_balancer_security_group<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>"</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">egress</span> <span class="token punctuation">{</span>
    <span class="token property">from_port</span>   <span class="token punctuation">=</span> <span class="token number">0</span> <span class="token comment"># Allowing any incoming port</span>
    <span class="token property">to_port</span>     <span class="token punctuation">=</span> <span class="token number">0</span> <span class="token comment"># Allowing any outgoing port</span>
    <span class="token property">protocol</span>    <span class="token punctuation">=</span> <span class="token string">"-1"</span> <span class="token comment"># Allowing any outgoing protocol </span>
    <span class="token property">cidr_blocks</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span> <span class="token comment"># Allowing traffic out to all IP addresses</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div>
</details>
<details>
<summary>DynamoDB</summary>
<h1>DynamoDB</h1>
<ul>
<li>DynamoDB is a NoSQL database service</li>
</ul>
</details>
<details>
<summary>RDS</summary>
<h1>RDS</h1>
<ul>
<li>Relational Database Service (RDS)</li>
</ul>
<h1>PostGIS</h1>
<ul>
<li><a href="https://www.martinpeters.ie/2020/02/01/cdk-rds-postgis-setup/"></a></li>
</ul>
</details>
<details>
<summary>Aurora DB</summary>
<h1>Aurora DB</h1>
<ul>
<li>MySQL and PostgreSQL-compatible relational database built for the cloud. Performance and availability of commercial-grade databases at 1/10th the cost.</li>
<li>Amazon Aurora is a MySQL and PostgreSQL-compatible relational database built for the cloud, that combines the performance and availability of traditional enterprise databases with the simplicity and cost-effectiveness of open source databases.</li>
<li>Amazon Aurora is up to five times faster than standard MySQL databases and three times faster than standard PostgreSQL databases.</li>
<li>DB normally run on an EC and it a pain to scale</li>
<li>Aurora scale automatically,</li>
<li>Aurora make 6 copies of your data distributes around multiple locations</li>
<li>Continuously backs it up to S3 so your data is safe</li>
<li>Aurora can also replicate around multiple regions</li>
<li>It's fully managed</li>
<li>Aurora comes in 2 flavors
<ul>
<li>Aurora Basic</li>
<li>Aurora Serverless (scales as much as you need and shuts down when you don't need it)</li>
</ul>
</li>
<li>Aurora uses a data API to access the data, which is different to how you normally connect to a relational database (via connections)
<ul>
<li>Working with Relational Database you have to connect to the DB, do your operations, then closing the connections</li>
<li>In the world of Serverless it become a little problematic cause you can have multiple lambda functions and they will all be handling the connections independenly which can lead to problems in your database like running out of open connections, your killing the memory, making it preform really bad</li>
<li>You can use an AWS Proxy that sits between your Database and your lambda functions and will handle the connections</li>
<li>You should really just use this if you have legacy DB</li>
<li>If you are building a new application, just use the Aurora Serverless and save yourself the headache</li>
</ul>
</li>
<li>DynamoDB used the model of accessing the DB via the API</li>
<li>In the serverless world dealing with DB connections is a pain,</li>
</ul>
</details>
<details>
<summary>AWS CDK (AWS Cloud Development Kit)</summary>
<h1>AWS CDK (AWS Cloud Development Kit)</h1>
<ul>
<li>The AWS CDK (Amazon Web Services Cloud Development Kit) is a <a href="https://github.com/aws/aws-cdk">new open source framework</a> to define cloud infrastructure in code (Infrastructure as Code) and provisioning it through AWS CloudFormation.</li>
<li>CDK provides many high level components to allow rapid code development requiring much less input compared to the typical CloudFormation templates.</li>
<li>CDK is available in TypeScript, Python, Java and C#.
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token comment"># Install globally </span>
$ <span class="token function">npm</span> i -g aws-cdk

$ <span class="token function">mkdir</span> my-app <span class="token operator">&#x26;&#x26;</span> <span class="token builtin class-name">cd</span> my-app
$ cdk init app --language<span class="token operator">=</span>typescript

$ <span class="token function">npm</span> i @aws-cdk/aws-apigatewayv2 @aws-cdk/aws-apigatewayv2-integrations @aws-cdk/aws-ec2 @aws-cdk/aws-lambda @aws-cdk/aws-rds @aws-cdk/core source-map-support
</code></pre></div>
</li>
</ul>
</details>
<details>
<summary>AWS SAM (AWS Serverless Application Model)</summary>
<h1>AWS SAM (AWS Serverless Application Model)</h1>
<ul>
<li>SAM is an open-source framework for building serverless applications.</li>
<li>You define the services you want in YAML and during the deployment SAM will convert it to CloudFormation syntax</li>
<li>SAM can be installed with <code>Homebrew</code></li>
<li>SAM allows you to run your application locally so you can test it out and debug</li>
<li>SAM is Infrastructure as Code</li>
</ul>
<h2>Installing SAM on MacOS</h2>
<ul>
<li><a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install-mac.html">How to install SAM</a>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ brew tap aws/tap
$ brew <span class="token function">install</span> aws-sam-cli
$ sam --version

$ brew upgrade aws-sam-cli
</code></pre></div>
</li>
</ul>
<h2>Get setup</h2>
<ul>
<li>Start by scaffolding your application
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token comment"># Step 1 - Download a sample application</span>
$ sam init
<span class="token comment"># 1 - AWS Quick Start Templates</span>
<span class="token comment"># 1 - Zip (artifact is a zip uploaded to S3)</span>
<span class="token comment"># 1 - nodejs14.x</span>
<span class="token comment"># AWS quick start application templates:</span>
<span class="token comment">#    1 - Hello World Example</span>
<span class="token comment">#    2 - Step Functions Sample App (Stock Trader)</span>
<span class="token comment">#    3 - Quick Start: From Scratch</span>
<span class="token comment">#    4 - Quick Start: Scheduled Events</span>
<span class="token comment">#    5 - Quick Start: S3</span>
<span class="token comment">#    6 - Quick Start: SNS</span>
<span class="token comment">#    7 - Quick Start: SQS</span>
<span class="token comment">#    8 - Quick Start: Web Backend</span>

<span class="token comment"># Step 2 run your code locally</span>
$ sam <span class="token builtin class-name">local</span> start-api

<span class="token comment"># Step 3 - Build your application</span>
$ <span class="token builtin class-name">cd</span> sam-app
$ sam build

<span class="token comment"># Step 4 - Deploy your application</span>
$ sam deploy --guided
<span class="token comment"># Once everything is deployed it will print out the REST Endpoint `https://&#x3C;RANDOM_STRING>.execute-api.us-west-2.amazonaws.com/Prod/`</span>
</code></pre></div>
</li>
</ul>
<h2>Check your stuff out in AWS Console</h2>
<ul>
<li>You can view your SAM application in AWS Console by going to <code>Lambda</code> > <code>Applications</code>
<img src="/assets/blog/aws/aws-console_serverless-application.png" alt="aws-console_serverless-application"></li>
<li>You can view your stack my clicking the <code>CloudFormation</code></li>
</ul>
<h2>Check your stuff within VSCode with the <code>Serverless Console</code> extension</h2>
<ul>
<li>
<p>You can use a vscode extension <a href="https://marketplace.visualstudio.com/items?itemName=devAdvice.serverlessconsole">Serverless Console</a> to view all the logs</p>
<ul>
<li>In vscode click the lighting bolt in the quick look panel</li>
<li>Create a connection</li>
</ul>
<p><img src="/assets/blog/aws/serverless-console_connect.png" alt="serverless-console_connect"></p>
<p><img src="/assets/blog/aws/serverless-console_panel.png" alt="serverless-console_panel"></p>
</li>
<li>
<p>Invoke your Lambda function directly</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ sam <span class="token builtin class-name">local</span> invoke <span class="token string">"HelloWorldFunction"</span> -e events/event.json
</code></pre></div>
</li>
</ul>
<h2>Cleanup</h2>
<ul>
<li>
<p>To delete the sample application that you created, use the AWS CLI. Assuming you used your project name for the stack name, you can run the following:</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">aws cloudformation delete-stack --stack-name <span class="token operator">&#x3C;</span>STACK_NAME<span class="token operator">></span>
</code></pre></div>
</li>
</ul>
</details>
</div></div></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5"><div class="py-28 flex flex-col lg:flex-row items-center"><div class="flex flex-col lg:flex-row justify-center items-center lg:pl-4 lg:w-1/2"><a href="/">Learn something else</a></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"aws","slug":"aws","content":"\u003cdetails\u003e\n\u003csummary\u003eAWS CLI\u003c/summary\u003e\n\u003cul\u003e\n\u003cli\u003eInstalling the AWS CLI \u003ca href=\"https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html\"\u003eDocs here\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eFor macOS \u003ca href=\"https://awscli.amazonaws.com/AWSCLIV2.pkg\"\u003edownload\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003eYou can install to any folder, or choose the recommended default folder of \u003ccode\u003e/usr/local/aws-cli\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eThe installer automatically creates a symlink at \u003ccode\u003e/usr/local/bin/aws\u003c/code\u003e that links to the main program in the installation folder you chose.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eCheck to see if it's installed properly\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ \u003cspan class=\"token function\"\u003ewhich\u003c/span\u003e aws\n/usr/local/bin/aws \n$ aws --version\naws-cli/2.4.5 Python/3.8.8 Darwin/18.7.0 botocore/2.4.5\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eYou can access your AWS services via (\u003ca href=\"https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html\"\u003emore on profiles here\u003c/a\u003e):\n\u003col\u003e\n\u003cli\u003eNamed profiles\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eAWS uses \u003ccode\u003e~./aws/credentials\u003c/code\u003e file for accessing your AWS accounts where you can have multiple profiles but you should probably have a \u003ccode\u003edefault\u003c/code\u003e profile\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003edefault\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eaws_access_key_id\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eAAAAAAAAAAAAAEXAMPLE\n\u003cspan class=\"token assign-left variable\"\u003eaws_secret_access_key\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e123456789123456789\u003c/span\u003e\n\n\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003euser1\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eaws_access_key_id\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eBBBBBBBBBBBBBEXAMPLE\n\u003cspan class=\"token assign-left variable\"\u003eaws_secret_access_key\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e12345678923456789\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eYou can also define the default regions for each profile in \u003ccode\u003e~/.aws/config\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003edefault\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eregion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eus-west-2\n\u003cspan class=\"token assign-left variable\"\u003eoutput\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003ejson\n\n\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eprofile user1\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eregion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eus-east-1\n\u003cspan class=\"token assign-left variable\"\u003eoutput\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003etext\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eList profiles\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ aws configure list-profiles\n$ aws configure list\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAccessing a specific profile's resources you just have to pass in the \u003ccode\u003e--profile \u0026#x3C;PROFILE_NAME\u003e\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ aws s3 \u003cspan class=\"token function\"\u003els\u003c/span\u003e --profile default\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eEnvironment variables\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eYou can also pass in environment variables access key/secrets\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ \u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_ACCESS_KEY_ID\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eBBBBBBBBBBBBBEXAMPLE\n$ \u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_SECRET_ACCESS_KEY\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e12345678923456789\u003c/span\u003e\n$ \u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eAWS_DEFAULT_REGION\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eus-west-2\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eNow, getting your \u003ccode\u003eAWS_ACCESS_KEY_ID\u003c/code\u003e \u0026#x26; \u003ccode\u003eAWS_SECRET_ACCESS_KEY\u003c/code\u003e values\n\u003col\u003e\n\u003cli\u003eGo to Amazon Web Services console and click on the name of your account (it is located in the top right corner of the console). Then, in the expanded drop-down list, select \u003ccode\u003eSecurity Credentials\u003c/code\u003e.\n\u003cimg src=\"/assets/blog/aws/credentials_1.jpg\" alt=\"Security Page\"\u003e\u003c/li\u003e\n\u003cli\u003eClick the \u003ccode\u003eAccess keys (access key ID and secret access key)\u003c/code\u003e accordion title and click \u003ccode\u003eCreate New Access Key\u003c/code\u003e\n\u003cimg src=\"/assets/blog/aws/credentials_2.jpg\" alt=\"Security Page\"\u003e\u003c/li\u003e\n\u003cli\u003eClick \u003ccode\u003eShow Access Key\u003c/code\u003e to have it displayed on the screen. Note, that you can download it to your machine as a file and open it whenever needed. To download it, just click the \u003ccode\u003eDownload Key File\u003c/code\u003e button.\n\u003cimg src=\"/assets/blog/aws/credentials_2.jpg\" alt=\"Security Page\"\u003e\u003c/li\u003e\n\u003cli\u003eNow update your \u003ccode\u003e~/.aws/credentials\u003c/code\u003e file with this key pair\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003edefault\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eaws_access_key_id\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eAAAAAAAAAAAAAEXAMPLE\n\u003cspan class=\"token assign-left variable\"\u003eaws_secret_access_key\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e123456789123456789\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eS3\u003c/summary\u003e\n- AWS Lambda provides various ways to access secrets or sensitive data securely. Here are a few of the most common methods:\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003eAWS Systems Manager Parameter Store\u003c/code\u003e: This is a managed service that lets you store and retrieve secrets, such as database credentials and API keys. You can access the secrets in a Lambda function by using the AWS Systems Manager API, AWS CLI, or SDK.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003eAWS Secrets Manager\u003c/code\u003e: This is a fully managed service that enables you to store, rotate, and retrieve secrets securely. You can access the secrets in a Lambda function by using the AWS Secrets Manager API, AWS CLI, or SDK.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003eEnvironment Variables\u003c/code\u003e: You can store secrets as environment variables in a Lambda function. These secrets are encrypted and protected by the Lambda service-linked role.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003eIAM Role\u003c/code\u003e: You can assign an IAM role to a Lambda function that has permissions to access the secrets. For example, you can assign a role that has read-only access to the secrets stored in AWS Secrets Manager or the AWS Systems Manager Parameter Store.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eRegardless of the method you choose, it's important to ensure that the secrets are stored securely and protected from unauthorized access. You should also consider rotating the secrets on a regular basis and limiting the permissions of the roles and services that access the secrets.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eIAM\u003c/summary\u003e\n\u003ch1\u003eIAM (Identity and Access Management)\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eAWS IAM\u003c/code\u003e is a web service that helps you securely control access to AWS resources. IAM enables you to manage users, groups, and permissions to AWS resources. With IAM, you can create and manage AWS users and groups, and use permissions to allow and deny access to AWS resources.\u003c/li\u003e\n\u003cli\u003eAn \u003ccode\u003eAWS policy \u003c/code\u003eis a document that defines one or more permissions. AWS policies are written in JSON and specify the actions that a user, group, or role is allowed or denied to perform on AWS resources. For example, you can create a policy that allows a user to perform only read operations on Amazon S3 buckets, or a policy that allows a group to launch EC2 instances.\u003c/li\u003e\n\u003cli\u003ePolicies can be attached to AWS users, groups, or roles. When a policy is attached to a user, it defines what that user can do in the AWS environment. When a policy is attached to a group, it defines the permissions for all users in that group. When a policy is attached to a role, it defines the permissions for applications or services that assume the role.\u003c/li\u003e\n\u003cli\u003eAWS provides a number of managed policies that you can use as building blocks for your policies. For example, the AmazonS3ReadOnlyAccess policy provides read-only access to Amazon S3 buckets. You can also create custom policies, either by creating a new policy from scratch or by modifying an existing policy.\u003c/li\u003e\n\u003cli\u003eHere's an example of a simple AWS policy to allow read access to an Amazon S3 bucket:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"Version\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"2012-10-17\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"Statement\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token property\"\u003e\"Effect\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Allow\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token property\"\u003e\"Action\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n                \u003cspan class=\"token string\"\u003e\"s3:GetObject\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"token string\"\u003e\"s3:ListBucket\"\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token property\"\u003e\"Resource\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n                \u003cspan class=\"token string\"\u003e\"arn:aws:s3:::\u0026#x3C;YOUR_BUCKET_NAME\u003e\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"token string\"\u003e\"arn:aws:s3:::\u0026#x3C;YOUR_BUCKET_NAME\u003e/*\"\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eThis policy uses the \"Effect\" of \"Allow\" to specify that the policy allows read access to the S3 bucket. The \"Action\" section lists the specific S3 actions that are allowed (s3:GetObject and s3:ListBucket), and the \"Resource\" section specifies the ARN (Amazon Resource Name) of the S3 bucket and its contents (\u0026#x3C;YOUR_BUCKET_NAME\u003e and \u0026#x3C;YOUR_BUCKET_NAME\u003e/*).\u003c/li\u003e\n\u003cli\u003eNote that in the \u0026#x3C;YOUR_BUCKET_NAME\u003e placeholder in the ARN, you would replace it with the actual name of the S3 bucket you want to grant read access to.\u003c/li\u003e\n\u003cli\u003eYou can attach this policy to an IAM user, group, or role to grant read access to the specified S3 bucket.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eS3\u003c/summary\u003e\n\u003ch1\u003eS3\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eStorage\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eCloudWatch\u003c/summary\u003e\n\u003ch1\u003eCloudWatch\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eCloudWatch enables you to monitor your complete stack (applications, infrastructure, network, and services) and use alarms, logs, and events data to take automated actions and reduce mean time to resolution (MTTR). This frees up important resources and allows you to focus on building applications and business value.\u003c/li\u003e\n\u003cli\u003eYou can create Dashboards, Alarms, or just query the logs\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eLogs\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eYou have 2 options: \u003ccode\u003eLog Goups\u003c/code\u003e or \u003ccode\u003eLog Insights\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eLog Insights\u003c/code\u003e is better\u003c/li\u003e\n\u003cli\u003eSelect a log group(s) then run a query\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003efields @timestamp, @message, @logStream, @log\n| sort @timestamp desc\n| limit 20\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eAllowed filtering options are:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003e'in', 'and', 'or', 'not', 'like', '=~', '~=', '|', '|\u003e', '^', '*', '/', '%', '+', '-', '\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e',\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003e'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e', '\u0026#x3C;=', '\u003e=', '=', '!='\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eYou can also regex console.log event you've done in your Lambdas like:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003efields @timestamp, @message, @logStream, @log\n| sort @timestamp desc\n| filter @message like /????/\n| limit 20\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eLearn more about queries \u003ca href=\"https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax-examples.html\"\u003ehere\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eCLoudFront\u003c/summary\u003e\n\u003ch1\u003eCLoudFront\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eDistribute your static content at AWS edge locations\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eACM\u003c/summary\u003e\n\u003ch1\u003eACM\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eAWS Certificate Manager is a service provided by Amazon that issues on-demand TLS certificates at no cost. Much like Let’s Encrypt, Amazon controls the Certificate Authority (Amazon Trust Services, LLC) behind the certificates, as well as the accompanying API to manage them.\u003c/li\u003e\n\u003cli\u003eAmazon Certificate Manager (ACM) provides an elegant wayt to convert  a cumbersome multi-step process (the process of provisioning, validating, and configuring Transport Layer Security (TLS) certificates) into a single step\u003c/li\u003e\n\u003cli\u003eACM certificates can only be associated with AWS Elastic and Application Load Balancers, CloudFront distributions, and API Gateway endpoints.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eRoute53\u003c/summary\u003e\n\u003ch1\u003eRoute53\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eRoute end users to your site reliably with globally-dispersed Domain Name System (DNS) servers and automatic scaling.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eAPI Gateway\u003c/summary\u003e\n\u003ch1\u003eAPI Gateway\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eAllows you to make RESTful applications\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThere's 4 types of API Gateway offering:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api.html\"\u003eHTTP API\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-rest-api.html\"\u003eREST API\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eREST API (private)\u003c/li\u003e\n\u003cli\u003eWebSocket API\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003eREST APIs \u003c/code\u003esupport more features than \u003ccode\u003eHTTP APIs\u003c/code\u003e, while \u003ccode\u003eHTTP APIs\u003c/code\u003e are designed with minimal features so that they can be offered at a lower price. You can read more \u003ca href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-vs-rest.html\"\u003ehere\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWhen you add a new endpoint you have to create a \u003ccode\u003eresource\u003c/code\u003e then add the http \u003ccode\u003emethods\u003c/code\u003e you want\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eCustom Authorizer\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://www.alexdebrie.com/posts/lambda-custom-authorizers/\"\u003eHere's a great writeup on Lambda Custom Authorizers\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAPI Gateway provides an HTTP API endpoint that is fully configurable. You define the HTTP resources (like /user), the HTTP methods on that resources (like POST, GET, DELETE, …) and the integration (e.g. Lambda function) that should be called to process the request. A Lambda function can then run whatever logic is needed to answer the request. The Lambda function returns its result to the API Gateway. The API Gateway responds to the caller. The following figure demonstrates this flow.\n\u003cimg src=\"/assets/blog/aws/api-gateway-flow.jpg\" alt=\"api-gateway-flow\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eYou could include the authentication and authorization logic into the Lambda function that handles the request. But you can also separate concerns, make use of API Gateway caching mechanism, and go for Custom Authorization. API Gateway will invoke another Lambda function (Auth Lambda Function) for the first request and caches that result for a configurable duration. Caching will reduce the overhead (latency and DynamoDB charges) for authentication and authorization to a minimum.\n\u003cimg src=\"/assets/blog/aws/api-gateway-flow_custom-authorizer.jpg\" alt=\"api-gateway-flow_custom-authorizer\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eYou can use whatever logic you like to decide if a request is allowed or not. Here I will implement an API token mechanism. All HTTP requests from clients must pass an Authorization: xyz header. The Auth Lambda Function will take this token to query a DynamoDB table. The request is allowed or denied depending on if the query matches.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe code for the Auth Lambda Function is responsible for looking up the token. The Authorization HTTP header field is used to transmit the token. You can use Node.js and the AWS SDK for JavaScript to implement this logic. API Gateway will pass an event to our function like this:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"TOKEN\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"authorizationToken\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u0026#x3C;caller-supplied-token\u003e\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"methodArn\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"arn:aws:execute-api:\u0026#x3C;regionId\u003e:\u0026#x3C;accountId\u003e:\u0026#x3C;apiId\u003e/\u0026#x3C;stage\u003e/\u0026#x3C;method\u003e/\u0026#x3C;resourcePath\u003e\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAPI Gateway expects that we respond in the following way:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"principalId\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"xyz\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"policyDocument\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"Version\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"2012-10-17\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"Statement\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"Action\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"execute-api:Invoke\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"Effect\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Allow\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// or Deny\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"Resource\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"arn:aws:execute-api:\u0026#x3C;regionId\u003e:\u0026#x3C;accountId\u003e:\u0026#x3C;apiId\u003e/\u0026#x3C;stage\u003e/\u0026#x3C;method\u003e/\u0026#x3C;resourcePath\u003e\"\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eA simple implementation looks like this:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e \u003cspan class=\"token constant\"\u003eAWS\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'aws-sdk'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e dynamodb \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAWS\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eDynamoDB\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003egeneratePolicy\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eprincipalId\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e effect\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e resource\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token string-property property\"\u003e'principalId'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e principalId\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string-property property\"\u003e'policyDocument'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token string-property property\"\u003e'Version'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'2012-10-17'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token string-property property\"\u003e'Statement'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token string-property property\"\u003e'Action'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'execute-api:Invoke'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token string-property property\"\u003e'Effect'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e effect\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token string-property property\"\u003e'Resource'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e resource\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\nexports\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method-variable function-variable method function property-access\"\u003ehandler\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eevent\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e context\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e cb\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e token \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e event\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eauthorizationToken\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  dynamodb\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003egetItem\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token string-property property\"\u003e\"Key\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token string-property property\"\u003e\"token\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token string-property property\"\u003e\"S\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e token\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string-property property\"\u003e\"TableName\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"auth-token\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eerr\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e data\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerr\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003ecb\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerr\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edata\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003e\u003cspan class=\"token maybe-class-name\"\u003eItem\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token keyword nil\"\u003eundefined\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003ecb\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword null nil\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003egeneratePolicy\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'user'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'Deny'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e event\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003emethodArn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003ecb\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword null nil\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003egeneratePolicy\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'user'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'Allow'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e event\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003emethodArn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eMore on Lambda authorizer \u003ca href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-use-lambda-authorizer.html\"\u003ehere\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eLambda\u003c/summary\u003e\n\u003ch1\u003eLambda\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eServerless functions\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eElastic Container Registry (ECR) \u003c/summary\u003e\n\u003ch1\u003eECR\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eECR is your own Docker repository where you can push images up to your AWS account\u003c/li\u003e\n\u003cli\u003eLets create a simple registry and add a docker container\n\u003col\u003e\n\u003cli\u003eCreate a Node.js application e.g. \u003ccode\u003e$ yarn create nest\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eCreate a docker file, \u003ccode\u003e./Dockerfile\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003eFROM node:18-alpine\nWORKDIR /user/src/app\nCOPY \u003cspan class=\"token builtin class-name\"\u003e.\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003e.\u003c/span\u003e\nRUN \u003cspan class=\"token function\"\u003erm\u003c/span\u003e -rf node_modules \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token function\"\u003eyarn\u003c/span\u003e \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e --frozen-lockfile\nRUN \u003cspan class=\"token function\"\u003eyarn\u003c/span\u003e build\n\u003cspan class=\"token environment constant\"\u003eUSER\u003c/span\u003e \u003cspan class=\"token function\"\u003enode\u003c/span\u003e\nCMD \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"npm\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"run\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"start:prod\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eCreate the AWS ECR\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.aws.amazon.com/AmazonECR/latest/userguide/getting-started-cli.html\"\u003eAWS Docs\u003c/a\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token assign-left variable\"\u003eREPO_NAME\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"meee/nestjs-api\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eAWS_REGION\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\naws ecr create-repository \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    --repository-name \u003cspan class=\"token variable\"\u003e$REPO_NAME\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    --image-scanning-configuration \u003cspan class=\"token assign-left variable\"\u003escanOnPush\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003etrue \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    --region \u003cspan class=\"token variable\"\u003e$AWS_REGION\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eOr with Terraform\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"aws\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eregion\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003erequired_providers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eaws\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003esource\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hashicorp/aws\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"~\u003e 4.16\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003erequired_version\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003e= 1.0.10\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"ecr_registry_name\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_ecr_repository\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"ecr_repo\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.ecr_registry_name\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eCreate a build/deploy script\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token comment\"\u003e# Variables\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eIMAGE_TAG\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003enode\u003c/span\u003e -p -e \u003cspan class=\"token string\"\u003e\"require('./package.json').version\"\u003c/span\u003e\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eAWS_REGION\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"us-west-2\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eIMAGE_NAME\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"nike/nestjs-api\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eACCOUNT_ID\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003eaws sts get-caller-identity \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e jq -r \u003cspan class=\"token string\"\u003e\".Account\"\u003c/span\u003e\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eREPOSITORY_URI\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$ACCOUNT_ID\u003c/span\u003e.dkr.ecr.us-west-2.amazonaws.com\"\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eECR_NAME\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ecr_example_repo\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Check to see if version already exist\u003c/span\u003e\n\u003cspan class=\"token assign-left variable\"\u003eNODE_V\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003ejq \u003cspan class=\"token string\"\u003e\".version\"\u003c/span\u003e package.json\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token for-or-select variable\"\u003eelement\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003eaws ecr list-images --repository-name $IMAGE_NAME \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e jq .imageIds\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e.imageTag\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edo\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$element\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$NODE_V\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethen\u003c/span\u003e \n    \u003cspan class=\"token builtin class-name\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"[Error] Version \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e`\u003c/span\u003e$\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eelement\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token variable\"\u003e`\u003c/span\u003e\u003c/span\u003e Already exist in the remote registry, update your package.json version\"\u003c/span\u003e\n    \u003cspan class=\"token builtin class-name\"\u003eexit\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003efi\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edone\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Build your image\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eyarn\u003c/span\u003e build\n\u003cspan class=\"token function\"\u003edocker\u003c/span\u003e build -t \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$IMAGE_NAME\u003c/span\u003e:\u003cspan class=\"token variable\"\u003e$IMAGE_TAG\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003e.\u003c/span\u003e\n\u003cspan class=\"token function\"\u003edocker\u003c/span\u003e build -t \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$REPOSITORY_URI\u003c/span\u003e/\u003cspan class=\"token variable\"\u003e$IMAGE_NAME\u003c/span\u003e:latest\"\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003e.\u003c/span\u003e\n\u003cspan class=\"token function\"\u003edocker\u003c/span\u003e build -t \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$REPOSITORY_URI\u003c/span\u003e/\u003cspan class=\"token variable\"\u003e$IMAGE_NAME\u003c/span\u003e:\u003cspan class=\"token variable\"\u003e$IMAGE_TAG\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003e.\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Create Infrastructure\u003c/span\u003e\n\u003cspan class=\"token function\"\u003epushd\u003c/span\u003e pipelines/terraform\nterraform init\nterraform apply -auto-approve -var \u003cspan class=\"token assign-left variable\"\u003eecr_registry_name\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$IMAGE_NAME\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token function\"\u003epopd\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Authenticating to Docker\u003c/span\u003e\naws ecr get-login-password --region \u003cspan class=\"token variable\"\u003e$AWS_REGION\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003edocker\u003c/span\u003e login --username AWS --password-stdin \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$ACCOUNT_ID\u003c/span\u003e.dkr.ecr.\u003cspan class=\"token variable\"\u003e$AWS_REGION\u003c/span\u003e.amazonaws.com\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Push to the repository\u003c/span\u003e\n\u003cspan class=\"token function\"\u003edocker\u003c/span\u003e push \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$ACCOUNT_ID\u003c/span\u003e.dkr.ecr.us-west-2.amazonaws.com/\u003cspan class=\"token variable\"\u003e$IMAGE_NAME\u003c/span\u003e:\u003cspan class=\"token variable\"\u003e$IMAGE_TAG\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token function\"\u003edocker\u003c/span\u003e push \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token variable\"\u003e$ACCOUNT_ID\u003c/span\u003e.dkr.ecr.us-west-2.amazonaws.com/\u003cspan class=\"token variable\"\u003e$IMAGE_NAME\u003c/span\u003e:latest\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eElastic Container Service (ECS)\u003c/summary\u003e\n\u003ch1\u003eECS\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eECS is a fully managed container orchestration service. AWS ECS is a fantastic service for running your containers.\u003c/li\u003e\n\u003cli\u003eECS Fargate, as this is a serverless compute service that allows you to run containers without provisioning servers.\u003c/li\u003e\n\u003c/ul\u003e\n\u003col\u003e\n\u003cli\u003eCreate a cluster go \u003ca href=\"https://us-west-2.console.aws.amazon.com/ecs/v2/clusters?region=us-west-2\"\u003ehere\u003c/a\u003e to see all your clusters\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eAdd this to your TF files and run\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_ecs_cluster\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my_cluster\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.cluster_name\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eYou should then see your new cluster in AWS\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eCreate a Task\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eNotice how we specify the image by referencing the repository URL of our other terraform resource.\u003c/li\u003e\n\u003cli\u003eAlso notice how we provide the port mapping of 3000.\u003c/li\u003e\n\u003cli\u003eWe also create an IAM role so that tasks have the correct permissions to execute.\u003c/li\u003e\n\u003cli\u003eIf you click Task Definitions in AWS ECS, you should see your new task:\u003c/li\u003e\n\u003cli\u003eAdd the following code:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# Cluster\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_ecs_cluster\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my_cluster\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.cluster_name\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"task_name\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"(optional) describe your variable\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edefault\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my-first-task\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"token comment\"\u003e# Task definition\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_ecs_task_definition\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my_first_task\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003efamily\u003c/span\u003e                   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.task_name\n  \u003cspan class=\"token property\"\u003econtainer_definitions\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token heredoc string\"\u003e\u0026#x3C;\u0026#x3C;DEFINITION\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e  [\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e    {\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e      \"name\": \"${var.task_name}\",\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e      \"image\": \"${aws_ecr_repository.ecr_repo.repository_url}\",\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e      \"essential\": true,\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e      \"portMappings\": [\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e        {\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e          \"containerPort\": 3000,\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e          \"hostPort\": 3000\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e        }\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e      ],\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e      \"memory\": 512,\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e      \"cpu\": 256\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e    }\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e  ]\u003c/span\u003e\n\u003cspan class=\"token heredoc string\"\u003e  DEFINITION\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003erequires_compatibilities\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"FARGATE\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Stating that we are using ECS Fargate\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003enetwork_mode\u003c/span\u003e             \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"awsvpc\"\u003c/span\u003e    \u003cspan class=\"token comment\"\u003e# Using awsvpc as our network mode as this is required for Fargate\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ememory\u003c/span\u003e                   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e512\u003c/span\u003e         \u003cspan class=\"token comment\"\u003e# Specifying the memory our container requires\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ecpu\u003c/span\u003e                      \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e256\u003c/span\u003e         \u003cspan class=\"token comment\"\u003e# Specifying the CPU our container requires\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eexecution_role_arn\u003c/span\u003e       \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_iam_role\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eecsTaskExecutionRole\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003earn\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_iam_role\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"ecsTaskExecutionRole\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e               \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"ecsTaskExecutionRole\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eassume_role_policy\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003edata\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003eaws_iam_policy_document\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eassume_role_policy\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ejson\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003edata \u003cspan class=\"token type variable\"\u003e\"aws_iam_policy_document\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"assume_role_policy\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003estatement\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eactions\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"sts:AssumeRole\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprincipals\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Service\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eidentifiers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ecs-tasks.amazonaws.com\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_iam_role_policy_attachment\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"ecsTaskExecutionRole_policy\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003erole\u003c/span\u003e       \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_iam_role\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eecsTaskExecutionRole\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003epolicy_arn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eCreate VPC\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eAs we are using Fargate, our tasks need to specify that the network mode is awsvpc.\u003c/li\u003e\n\u003cli\u003eAs a result, we need to extend our service to include a network configuration.\u003c/li\u003e\n\u003cli\u003eYou may have not known it yet, but our cluster was automatically deployed into your account’s default VPC.\u003c/li\u003e\n\u003cli\u003eHowever, for a service, this needs to be explicitly stated, even if we wish to continue using the default VPC and subnets.\u003c/li\u003e\n\u003cli\u003eFirst, we need to create reference resources to the default VPC and subnets so that they can be referenced by our other resources:\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_default_vpc\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"default\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etags\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eName\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Default VPC\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Providing a reference to our default VPC\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_default_vpc\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"default_vpc\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Providing a reference to our default subnets\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_default_subnet\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"default_subnet_a\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eavailability_zone\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"eu-west-2a\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_default_subnet\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"default_subnet_b\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eavailability_zone\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"eu-west-2b\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_default_subnet\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"default_subnet_c\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eavailability_zone\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"eu-west-2c\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eCreate a service\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003etime to create the service, notice that we are using the VPC define above\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# Service\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_ecs_service\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my_service\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e            \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.app_name                     \u003cspan class=\"token comment\"\u003e# Naming our first service\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ecluster\u003c/span\u003e         \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_ecs_cluster.cluster.id       \u003cspan class=\"token comment\"\u003e# Referencing our created Cluster\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etask_definition\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e aws_ecs_task_definition.task.arn \u003cspan class=\"token comment\"\u003e# Referencing the task our service will spin up\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003elaunch_type\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"FARGATE\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edesired_count\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Setting the number of containers we want deployed to 2\u003c/span\u003e\n\n\n  \u003cspan class=\"token keyword\"\u003enetwork_configuration\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003esubnets\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_default_subnet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edefault_subnet_a\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_default_subnet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edefault_subnet_b\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e, \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_default_subnet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edefault_subnet_c\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eassign_public_ip\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Providing our containers with public IPs\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"4\"\u003e\n\u003cli\u003eFinal step is to create a Load Balancer\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eAdd this code to your TF files\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_alb\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"application_load_balancer\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e               \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.app_name \u003cspan class=\"token comment\"\u003e# Naming our load balancer\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eload_balancer_type\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"application\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esubnets\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Referencing the default subnets\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_default_subnet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edefault_subnet_a\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e,\n    \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_default_subnet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edefault_subnet_b\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e,\n    \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_default_subnet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edefault_subnet_c\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# Referencing the security group\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003esecurity_groups\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_security_group\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eload_balancer_security_group\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Creating a security group for the load balancer:\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_security_group\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"load_balancer_security_group\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eingress\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003efrom_port\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e80\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Allowing traffic in from port 80\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eto_port\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e80\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eprotocol\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"tcp\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecidr_blocks\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"0.0.0.0/0\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Allowing traffic in from all sources\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eegress\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003efrom_port\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Allowing any incoming port\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eto_port\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Allowing any outgoing port\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eprotocol\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"-1\"\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Allowing any outgoing protocol \u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecidr_blocks\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"0.0.0.0/0\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Allowing traffic out to all IP addresses\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eTo direct traffic we need to create a target group and listener. Each target group is used to route requests to one or more registered targets (in our case, containers).\u003c/li\u003e\n\u003cli\u003eAdd this code to your TF files\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# Target Group and listener\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_lb_target_group\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"target_group\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"target-group\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eport\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e80\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eprotocol\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"HTTP\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etarget_type\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"ip\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003evpc_id\u003c/span\u003e      \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_default_vpc\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edefault_vpc\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Referencing the default VPC\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ehealth_check\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ematcher\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"200,301,302\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003epath\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_lb_listener\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"listener\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eload_balancer_arn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_alb\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eapplication_load_balancer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003earn\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Referencing our load balancer\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eport\u003c/span\u003e              \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"80\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eprotocol\u003c/span\u003e          \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"HTTP\"\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003edefault_action\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etype\u003c/span\u003e             \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"forward\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_group_arn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_lb_target_group\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etarget_group\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003earn\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Referencing our tagrte group\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eNow if you go to EC2 then click on \u003ccode\u003eLoad Balancer\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eIf you view the Listeners tab of your load balancer, you should see a listener that forwards traffic to your target group:\u003c/li\u003e\n\u003cli\u003eWe now have to tell your \u003ccode\u003eaws_ecs_service\u003c/code\u003e about this load balancer\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_ecs_service\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"my_service\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e            \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.app_name                     \u003cspan class=\"token comment\"\u003e# Naming our first service\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# ...\u003c/span\u003e\n  \n  \u003cspan class=\"token keyword\"\u003eload_balancer\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003etarget_group_arn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_lb_target_group\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etarget_group\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003earn\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Referencing our target group\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003econtainer_name\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_ecs_task_definition\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emy_first_task\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efamily\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003econtainer_port\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e3000\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Specifying the container port\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eECS service does not allow traffic in by default. We can change this by creating a security group for the ECS service that allows traffic only from the application load balancer security group:\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token comment\"\u003e# Service\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_ecs_service\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"service\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e            \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.app_name                     \u003cspan class=\"token comment\"\u003e# Naming our first service\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# ...\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003enetwork_configuration\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# ...\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003esecurity_groups\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_security_group\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eservice_security_group\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Setting the security group\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\n\u003cspan class=\"token comment\"\u003e# Security Group\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"aws_security_group\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"service_security_group\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eingress\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003efrom_port\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eto_port\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eprotocol\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"-1\"\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# Only allowing traffic in from the load balancer security group\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003esecurity_groups\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaws_security_group\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eload_balancer_security_group\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eegress\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003efrom_port\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Allowing any incoming port\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eto_port\u003c/span\u003e     \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Allowing any outgoing port\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003eprotocol\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"-1\"\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Allowing any outgoing protocol \u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ecidr_blocks\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"0.0.0.0/0\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# Allowing traffic out to all IP addresses\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eDynamoDB\u003c/summary\u003e\n\u003ch1\u003eDynamoDB\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eDynamoDB is a NoSQL database service\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eRDS\u003c/summary\u003e\n\u003ch1\u003eRDS\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eRelational Database Service (RDS)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003ePostGIS\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.martinpeters.ie/2020/02/01/cdk-rds-postgis-setup/\"\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eAurora DB\u003c/summary\u003e\n\u003ch1\u003eAurora DB\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eMySQL and PostgreSQL-compatible relational database built for the cloud. Performance and availability of commercial-grade databases at 1/10th the cost.\u003c/li\u003e\n\u003cli\u003eAmazon Aurora is a MySQL and PostgreSQL-compatible relational database built for the cloud, that combines the performance and availability of traditional enterprise databases with the simplicity and cost-effectiveness of open source databases.\u003c/li\u003e\n\u003cli\u003eAmazon Aurora is up to five times faster than standard MySQL databases and three times faster than standard PostgreSQL databases.\u003c/li\u003e\n\u003cli\u003eDB normally run on an EC and it a pain to scale\u003c/li\u003e\n\u003cli\u003eAurora scale automatically,\u003c/li\u003e\n\u003cli\u003eAurora make 6 copies of your data distributes around multiple locations\u003c/li\u003e\n\u003cli\u003eContinuously backs it up to S3 so your data is safe\u003c/li\u003e\n\u003cli\u003eAurora can also replicate around multiple regions\u003c/li\u003e\n\u003cli\u003eIt's fully managed\u003c/li\u003e\n\u003cli\u003eAurora comes in 2 flavors\n\u003cul\u003e\n\u003cli\u003eAurora Basic\u003c/li\u003e\n\u003cli\u003eAurora Serverless (scales as much as you need and shuts down when you don't need it)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eAurora uses a data API to access the data, which is different to how you normally connect to a relational database (via connections)\n\u003cul\u003e\n\u003cli\u003eWorking with Relational Database you have to connect to the DB, do your operations, then closing the connections\u003c/li\u003e\n\u003cli\u003eIn the world of Serverless it become a little problematic cause you can have multiple lambda functions and they will all be handling the connections independenly which can lead to problems in your database like running out of open connections, your killing the memory, making it preform really bad\u003c/li\u003e\n\u003cli\u003eYou can use an AWS Proxy that sits between your Database and your lambda functions and will handle the connections\u003c/li\u003e\n\u003cli\u003eYou should really just use this if you have legacy DB\u003c/li\u003e\n\u003cli\u003eIf you are building a new application, just use the Aurora Serverless and save yourself the headache\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eDynamoDB used the model of accessing the DB via the API\u003c/li\u003e\n\u003cli\u003eIn the serverless world dealing with DB connections is a pain,\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eAWS CDK (AWS Cloud Development Kit)\u003c/summary\u003e\n\u003ch1\u003eAWS CDK (AWS Cloud Development Kit)\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eThe AWS CDK (Amazon Web Services Cloud Development Kit) is a \u003ca href=\"https://github.com/aws/aws-cdk\"\u003enew open source framework\u003c/a\u003e to define cloud infrastructure in code (Infrastructure as Code) and provisioning it through AWS CloudFormation.\u003c/li\u003e\n\u003cli\u003eCDK provides many high level components to allow rapid code development requiring much less input compared to the typical CloudFormation templates.\u003c/li\u003e\n\u003cli\u003eCDK is available in TypeScript, Python, Java and C#.\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token comment\"\u003e# Install globally \u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003enpm\u003c/span\u003e i -g aws-cdk\n\n$ \u003cspan class=\"token function\"\u003emkdir\u003c/span\u003e my-app \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e my-app\n$ cdk init app --language\u003cspan class=\"token operator\"\u003e=\u003c/span\u003etypescript\n\n$ \u003cspan class=\"token function\"\u003enpm\u003c/span\u003e i @aws-cdk/aws-apigatewayv2 @aws-cdk/aws-apigatewayv2-integrations @aws-cdk/aws-ec2 @aws-cdk/aws-lambda @aws-cdk/aws-rds @aws-cdk/core source-map-support\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n\u003cdetails\u003e\n\u003csummary\u003eAWS SAM (AWS Serverless Application Model)\u003c/summary\u003e\n\u003ch1\u003eAWS SAM (AWS Serverless Application Model)\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eSAM is an open-source framework for building serverless applications.\u003c/li\u003e\n\u003cli\u003eYou define the services you want in YAML and during the deployment SAM will convert it to CloudFormation syntax\u003c/li\u003e\n\u003cli\u003eSAM can be installed with \u003ccode\u003eHomebrew\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eSAM allows you to run your application locally so you can test it out and debug\u003c/li\u003e\n\u003cli\u003eSAM is Infrastructure as Code\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eInstalling SAM on MacOS\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install-mac.html\"\u003eHow to install SAM\u003c/a\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ brew tap aws/tap\n$ brew \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e aws-sam-cli\n$ sam --version\n\n$ brew upgrade aws-sam-cli\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eGet setup\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eStart by scaffolding your application\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e\u003cspan class=\"token comment\"\u003e# Step 1 - Download a sample application\u003c/span\u003e\n$ sam init\n\u003cspan class=\"token comment\"\u003e# 1 - AWS Quick Start Templates\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# 1 - Zip (artifact is a zip uploaded to S3)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# 1 - nodejs14.x\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# AWS quick start application templates:\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    1 - Hello World Example\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    2 - Step Functions Sample App (Stock Trader)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    3 - Quick Start: From Scratch\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    4 - Quick Start: Scheduled Events\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    5 - Quick Start: S3\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    6 - Quick Start: SNS\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    7 - Quick Start: SQS\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#    8 - Quick Start: Web Backend\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Step 2 run your code locally\u003c/span\u003e\n$ sam \u003cspan class=\"token builtin class-name\"\u003elocal\u003c/span\u003e start-api\n\n\u003cspan class=\"token comment\"\u003e# Step 3 - Build your application\u003c/span\u003e\n$ \u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e sam-app\n$ sam build\n\n\u003cspan class=\"token comment\"\u003e# Step 4 - Deploy your application\u003c/span\u003e\n$ sam deploy --guided\n\u003cspan class=\"token comment\"\u003e# Once everything is deployed it will print out the REST Endpoint `https://\u0026#x3C;RANDOM_STRING\u003e.execute-api.us-west-2.amazonaws.com/Prod/`\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eCheck your stuff out in AWS Console\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eYou can view your SAM application in AWS Console by going to \u003ccode\u003eLambda\u003c/code\u003e \u003e \u003ccode\u003eApplications\u003c/code\u003e\n\u003cimg src=\"/assets/blog/aws/aws-console_serverless-application.png\" alt=\"aws-console_serverless-application\"\u003e\u003c/li\u003e\n\u003cli\u003eYou can view your stack my clicking the \u003ccode\u003eCloudFormation\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eCheck your stuff within VSCode with the \u003ccode\u003eServerless Console\u003c/code\u003e extension\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eYou can use a vscode extension \u003ca href=\"https://marketplace.visualstudio.com/items?itemName=devAdvice.serverlessconsole\"\u003eServerless Console\u003c/a\u003e to view all the logs\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIn vscode click the lighting bolt in the quick look panel\u003c/li\u003e\n\u003cli\u003eCreate a connection\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/assets/blog/aws/serverless-console_connect.png\" alt=\"serverless-console_connect\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/blog/aws/serverless-console_panel.png\" alt=\"serverless-console_panel\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eInvoke your Lambda function directly\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ sam \u003cspan class=\"token builtin class-name\"\u003elocal\u003c/span\u003e invoke \u003cspan class=\"token string\"\u003e\"HelloWorldFunction\"\u003c/span\u003e -e events/event.json\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eCleanup\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eTo delete the sample application that you created, use the AWS CLI. Assuming you used your project name for the stack name, you can run the following:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003eaws cloudformation delete-stack --stack-name \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eSTACK_NAME\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/details\u003e\n","ogImage":{"url":"/assets/covers/aws.jpg"},"coverImage":"/assets/covers/aws.jpg"}},"__N_SSG":true},"page":"/learn/[slug]","query":{"slug":"aws"},"buildId":"C2QjU3KTzw_2dzPJqoxa3","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>